{"nodes":[{"block_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","block_type":1,"children":["UKgsdhLCCo0fbIxRRzLcCU3xndc","CATtdX7aFooPHixY50tcnWQin4b","UGnHdOda7oTi7exdMllcpQ3xnDh","TI2AdGS4toaYdnx6niWcNNo3nVc","D6gFdQqcIoJlgIx8nKqchN0mntc","K9X6dOxeZofDmGxAfSocyHl1nag","Q2y6dQsHxoR6XWxIU10chZIznEg","WpLZdFf8mo7VIbxWdF7cxollnkg","HIgmdsiN5o3rYfxNGTScfkyYnBb","JPU8dC58XoVxb7xT8W5cCORxnMh","BtJgdqESbodgh3x9ioVcnGITnRt","KW9ed88ypo0l0jxBhZIcDC1sn8f","EdZSdbE5no5mkWxG6TDcT9kQnad","H0C5dkqi1oCAdRxeDaXckWWDnpf","L7hkd2ZM2o2EIpxrWa8cYv40nuh","JMpwdwsxIonmlox5Ql3cqp11nce","IUgGdTO4QowdY2xTwjScAGvHn9f","L6q4d7jMpoLUqdxcHi6c3HyjnBf","NUKNdQhOAoiY16xASCecwxOFnAz","LFJbdw5Z7ob7XNxhJCOcvxtdnqd","VRKKd3QYKoExPYxnkgzcvLC5nJc","Aw2Ody5Jlongukx2HqZcuTPpnWf","G9KMdoRTroRHFJx5OuTcLAnVnAe","E76Rdk0WNonQxLxjI4ac1RCsnEh","LaTndAT7xoEwWYx75hjc6eu9nad","OXSpdU9OBouDHzxM4xYcRJTYn8d","LnPJdOCWtoTB33xoHBlchOWInog","DJa1dvcJ9o5LJnxu3ZScgnnfnnb","ZaoAdelhooO5ckxi0QHcGVmpnWe","A0Opdm47qo6Ww1xlUgwc3r2Rnif","RU45d5DXNofqpzxzimlcLK05n6g","PIeHdXiYkoye5txEB3KcsDsqnOh","Sr6ddMrO8oJZ72xonTFcT28nn9c","E7UFdK0oCovR0XxJvxDcdE5Vnuh","A5mTdJwVfo1xpNxBuElcZCQunIb","Lec9dZV5foLg1Mx5QrLcgcqbnlc","KCJcduRKpoosasxDLLwcpZK4nFT","QOuTdm4wHosL0FxJI38cKXpLn9e","PlRbdI1r9o1XyBxMoiUcQaoEnyc","ApRqdn9ndogHmrxseCfcngpWnqb","VNBrdxZMnoD2rfxRCWLc5nManch","ZbORd83KqoyGpkxT1cEcvh8Ln9b","OXvUdMwvso2BrhxXrovcD9IFnQh","JxXMdvcS5ofVyGxtyhocI8XPnZd","CBj1dAj1Vo8LTCxGHu5cfkfNnZd","BKV0dhu1Yo0L7qxuhkuc3vShnLb","YX2wdqfNFo5f06xu44jc2XD5nZo","Kz4xdI4RqosYvyxqDKvcru04nUg","XlTJdhZ6poT653xgf4Scedxgned","C3r8dvLgQoLqRvx4iybcXz3wnUe","TLXMdXZfjo7MdkxzPBecnAgfnyg","O3FBd8S2eoOe8pxccEecessrnme","ZQEjdEHFeoYmj7xbf8ncJNp9nrg","VieNdXi3ZoTY2GxIl40c5uksnbd","BMeidIU5ZobMKpxRV0rcKTKTnxg","CxKldk6JKo5HmJxbRglc8S1MnZg","W4aVds1LioAvPyxtBZ7cRxdBnUb","VuTedbqBuohJqrxJSZmcic3hn3f","S30EdKsgaoTQUXxZ5oKcb1bvnLb","VhGfdUFINoeofjxwGfMcWEGjnvb","Nmx3dr2Gzo7Jp6xj3GKcy1stnIj","LEuxdPEpNo6q32xdPxScrNe0nDb","MK5rdB9ICoCChfxMCmUcFklqnJg","UTEIduGAeojjRtxUEE2cXgwyn0d","Tvs2dOUxqoymAjxER5ScWR87nhe","VAdWdSjazokE4rxSDB2cc5KpnJe","MZ8Pdik3fowGnsxM6YScHQhsnfc","YqbSds1AGoIZ1IxBY2dc5xvdnRc","LjBDdnqVSoRu0CxkWCMcYmZ7nkc","IOjUdutZfossqGxuN5scimQ8nTc","XssLd78bBobACdxBKh4cFKmTnQb","TDQMdHCxoodJ0ExyOXrcl34UnAc","NeR9d3dNHoApGPxAj6wc7nBhnpc","JA08dgTSLowWqBxsmx5cwoswnvf","A4HBdWYA8olh32xATVrcAnH8nug","H2Ild1ETWojbHyxFCHecFxUSnTd","YkSkdlqxSobbSuxQOv4cXhhCnth","NPPZdMEkHo6SrGxTTGtcEjeMnyg","HWVkdqsNrocL5UxmduzcAi9wnYg","YclTdJd83ol9KRxj7FycT6kKnoe","TvnXdgEe0oOB3uxllDJc36hTnBd","TKpIdgnfnoxg3LxATZec3dgAn2e","MtdadCyHpoxlRnxyVdscv6iznig","NkP8dkeDuou9mtxq8Doc7u0pnRd","LXFDdwBkQoIDuUxePirclt5mnxc","TmEadX152oQLATxhK26c0AGynwc","UbyvdN1kXoE30CxEaENcCHRfnQg","RuAldFczLopcqKxKGwxcNFwpn6c","OoN2dUKgpoSuLrxv7LtcN4KjnEG","F76mdmfHaoMtOJx4IF3cvi2onwb","GifbdeqqvoiSYcxijSjcEq9Yndd","KFFTdsT9voVDlFxA0j6csqf0nYd","UwNEd6hBNodl8Bx8Q7zcrYhRn8g","A8eQdUd3XoVRmGxuXWTc2MbBnyf","O4svdphnwoyjkVx9E6ncJxuDnWf","MydOdowSmo96aoxtSyQcn2ojncd","UUKndVCZnob8PBxLwLNccXpvnNe","RxQddfYZvongLQxtUDJcIbPQnxb","WVgCdILxuoab1kxpqK9cydNGnXR","V4IqdO6z3ohCQkxlRofcSKBOnUY","ZP0ydgPiyo4Vl5xVKMgcHfbcnJd","KsDNdrSmio85nnxuzAOczq6NnHg","UBQMdl0b5osMEtx3jCIchmzTnYg","WQiAdTmVroxhlmxJx91cAYdZnDc","Di9JdGDPIotTCVxU2IScNF41n3c","LARCdOncVoRxlixWpRHc46RXnLg","BLNRd7JcIowtKexYpi3co09hnOg","TaGcddcLZoMRK3xrdWMcuO4zn3g","IFXgdxscRo63rtxsURScrUFAnbg","UkhWd0UffowYzIxnSxucT163nNb","ES09duA1qo1CFVxJM5EcdOYtnLc","BHZ1d3viPoKoKfxiDXVcOy3SnWc","LzmQdKHsYoc3jPxQjXTckUe0n2f","ZV5FdnR7LoQjXSxphf0ckFefnih","JIcndVDePoWVDkxjnINcNZryn48","RbPMdSJ76oWFXDx4kZbcZzivn8e","Kbjzd5PQaoO7NOxhPOEcN6lqn7d","FW1UdVoo2okn40xHZCgcxQbYn8g","PTgod2GuJoO9mzxshYScHFJUnEe","FDOVdhgjjon1R1xoVrNcIsJdnZb","KOKtdW0pboFLyyxcd2xcfzPanxc","ZGfcdaI8ro6IgvxCCFYcLl0pn4b","Shnod7GiroOeM0xkiicctGhgnid","GPt3dsI9Too4w8xPHfCcmbclnNc","FlbrdvGvzonTfxxWMlucJbt9nMc","HCt8dSD2yobGWOxRDuTcNnJ9nCb","Tc6ZdxwG5oNoAcxpw03ctJuZnH3","ANhcdNct1o3VtSx38VQc4xkjn2b","EWy7dohJCoGf4sxJaaWcAJjqndb","A0scd5zdtoxPsSxeFbbcCtCwnWd","CEVSdAGUpocEnJxOjbwcpdZynFh","Hoe1dInXyomAyqx70p3czDDSnWf","I1wfdPkJ7oXg1Yxeehuc1zOxnzh","EghEdV0OIoB2isxylGNc1fiAnhg","NoX4de39wo843wxHk9PcpBmRnNe","KFpqdT4ymoLizLxHxh3cem4hnZc","JFsEdUqUwoiKx3xkkoGcACLcnWd","QmTrdvTAxoSlLcxhl5Pcignsnjb","T7G2d2fhsoz3jRxGLotcbOvPnbh","FcJMdPUWyoW5O5xgygscMB1tnRh","GJJndyvDhoTHPGxJ9bdccwWGnHo","JkbDdUyVEoEUpExRoXZcphExnfh","AjPMdXoSZoDJGJxllt1cRriInYf","VXqbd8BLroaUkLxo5TEcKtdznv7","S1XVdHX3woYBMOxaABDclu5inrg","KPKzdgWKNowzoJxN651cCr8jnXO","HHEVd0RCjoKdarxsAFscHp9knZb","VxZ8dQXIkoan6mxgqz1c6fDJnid","ARBtdPKwAoWyH0x87dqcxjBInNb","EvQqdrYfmo28hQxqbVMcbJfbned","QKSidtVG8o0wGsxtKrAciMNNn3d","MxVddMqhfoJEnjxyzN1cFkZRnHh","DDJKdYGefon06kxdxwucGE4unve","YW4Pd8w2jofvZfxnnMicVB7wnrF","LDUsd2m9XozEd1xbVTxcql0Fnyg","H9XOdKyNkotfBCxYCx5cjIJUnyg","NzoCdj1zsoiTomxvev2clR81nge","OWcldC3ReopXGIxhpApcUvumntc","DyaUdrnaJot7M9x87W1cwZF0nRd","Wo6WdmTxsovWOHxmsDIc1DTSnWb","Y8WLdiUSVoH1uXx0J0UczvrRnTe","AOTMdoy3aoGiyBxfwfVcGaHQn5f","XwQBdl354oJUKLx9ww3ccJytn85","VIpGdHVCgodZYPx0X0wcJscdn3f","VHPHd7XZjoB2qxxC3E0cRfJunNg","Dq7AdsaKloDxMtxRDpicarArnid","VlHrdAJKOokCMyxOuJXc2pLhn9c","IbBPdUmj1oNoaIxcYzLc16GOn8c","Iu56dr3wYo2KJdxwMXucJrVUnCc","YPjcd4Bi9oZbLKxFO0GcBkKFnkC","JYoldoEPuoN3zzxYLNtc7Mn6ndh","ZF6IdXL3HoUVwcx1nWsc4Dgjn8f","Nqa1dKUnio2E3sxxDO9cuQP2nAg","QgeCdCH8soLAivxvaewcEW9fnif","Dxnbd0L4koaHn7xPEwUcI6gznif","X4x6dtkqwoNIBNxCIHNc5WgunCb","S0HCdHhLmoonyWxNLQKcgZydnwb","AH1xdQMtSoDgksxnXpGccC9XnXg","MPPad2wjJoFbo0xJnWIcISoXn3e","Wh6sdnv6JojA0JxfihwcKQxdnRh","OGCXdFbmHoOsZ0xMOVWcxV7nnOf","VGbHdauZDoyo7OxYBt4c2tzdnXe","Ern8dcwlaouproxnAHZcI8Opnt0","FeN9dj1nuo9xq0xqNNbcgCKBnGP","KLRLdK2nooiyFixZMUYcP3IInEh","TFs0d5TwqoxEtKxAZoKc6nocnmc","Ufysdj7YEo8rJbx2vWJcXtzynkd","XcJrd70h8oaOoIxvIn7ck3tbnzc","X56hdkLIho4AlHxK2u4cjQv7nsd","IbWJdQwipoJnPdxdXaPcGpZ0nmc","KUbVdDgeuoZCf6xtNS5czkgBnTg","QuUWdAhXrolIM2xIeV4cUgZwnLg","VeRpdheJYoKKWoxTkTacDsLAn6d","W18edibkooXagRxrnuZcIjKwnHc","MYigd6LqAotNpYx9q4Ycn4bsnpb","LjzhddtrBoXKl0xoArYcPDcBnN2","P56xdVaoqoRMDxxe12ScnxlQn6d","EsYmdqwtCo5pSVxdRUKca64Rn1d","Y72YdSklqoHYQRx7uE4cZ3HKndd","HIt0dFcfOoN5vnxcMrjcsAmsn1b","PGSLd6kRPor3hdxh6afcUbbynSe","Cp6zdMiKfoWAEgxV9jUcHrHMnwe","UfJNdYGlbov7C2xCy7AciXSxnJh","XAQcdZjvroNpG3xOu9icR2CanLh","XRHidHfICoVN7Nxt7Hvc1hJennf","GRkidEJ53oVpzLxwwPJcGTNinAb","YhVmdS6Y0oVHKLx09cEcfrpvnRe","AL7EdNRQto1xOixGEIccWCZjnbb","NES3dhduHoQMrzxTg8fcIY0Lnic","QSnSdvwfFoSawVxdMzicokCInnh","ZJqfde4hjo2zCexRjEZcOoOSnRd","XVTEdGXb8oqKlexsrRkcasTqnGb","Ynqsd7ZV5o09DYxfLDxceidVnzh","H6yGdH6HMo3ucpxxLwMcijnDntd","OxLHdfnRMo8YsyxnaXrcZoUnnkb","WuJEd1cc3oifHmxMsyBcRGYZn8c","RmL6dqMa0oa3hYxln6tc3e51nNd","YWtAdXHkcoMC1NxbivjcJsUKnGd","L0TndpxEQo0B9Hxd24Cc5ZJXnjb","OonYdVQLkolL9Fxv1Fbciss1nFf","PrGCd76l9oqGxcxKeoDcQyZsnSe","TNBtdrlkfo2zWvxxyu1cK8RqnFh","BoYHdo8aiovjbYx4Vtlc18UZny2","PxUxdTwZgokSX2xWJV3cdAnEnzd","FPWjdIptMouJ7Zxr6tQczPrwnPf","UQWnd6ePdo5Gu4xvOvvcuYkpnP2","CRREdjVTBoEjhvxQMdpcRKyNnTN","Mqfyd5Of0oEdxLxBrtycPY0enqc"],"page":{"elements":[{"text_run":{"content":"用户传图","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1}},"parent_id":""},{"block_id":"UKgsdhLCCo0fbIxRRzLcCU3xndc","block_type":3,"heading1":{"elements":[{"text_run":{"content":"用户上传图片及审核","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"CATtdX7aFooPHixY50tcnWQin4b","block_type":4,"heading2":{"elements":[{"text_run":{"content":"需求分析","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"UGnHdOda7oTi7exdMllcpQ3xnDh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"之前我们已经开发了管理员上传图片功能，想实现用户上传图片就比较简单了，但是我们要考虑到一点“用户上传的内容可能是不安全的”。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"TI2AdGS4toaYdnx6niWcNNo3nVc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"一般只要涉及到\"用户上传内容”（俗称UGC）的场景，就要增加审核功能。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"D6gFdQqcIoJlgIx8nKqchN0mntc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"具体分析每个需求：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"K9X6dOxeZofDmGxAfSocyHl1nag","block_type":13,"ordered":{"elements":[{"text_run":{"content":"用户上传创建图片：需要开放权限，允许用户上传图片，功能和流程跟之前管理员上传图片一致，也要增加文件校验。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Q2y6dQsHxoR6XWxIU10chZIznEg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"管理员审核图片：管理员可以查看和筛选所有待审核的图片，并标记为通过或拒绝，可填写通过或拒绝的具体原因。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"WpLZdFf8mo7VIbxWdF7cxollnkg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"此外，需要记录审核人和审核时间作为日志，如果发现误审的情况也可以追责。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"HIgmdsiN5o3rYfxNGTScfkyYnBb","block_type":4,"heading2":{"elements":[{"text_run":{"content":"方案设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"JPU8dC58XoVxb7xT8W5cCORxnMh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"方案设计阶段我们需要确认：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"BtJgdqESbodgh3x9ioVcnGITnRt","block_type":12,"bullet":{"elements":[{"text_run":{"content":"审核的具体逻辑","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"KW9ed88ypo0l0jxBhZIcDC1sn8f","block_type":12,"bullet":{"elements":[{"text_run":{"content":"库表设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"EdZSdbE5no5mkWxG6TDcT9kQnad","block_type":5,"heading3":{"elements":[{"text_run":{"content":"审核逻辑","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"H0C5dkqi1oCAdRxeDaXckWWDnpf","block_type":13,"children":["S9jwdm8XVoOaaCx3SiTcrtxOncb","RkZodYq2CoC0ADxlhiWcTUUbnJb","JZWrdlhusoSesWxBEutc8TkMn7c"],"ordered":{"elements":[{"text_run":{"content":"管理员可以操作审核的状态流转：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"S9jwdm8XVoOaaCx3SiTcrtxOncb","block_type":12,"bullet":{"elements":[{"text_run":{"content":"默认为“待审核”，可以设置为“审核通过”或“审核拒绝”","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"H0C5dkqi1oCAdRxeDaXckWWDnpf"},{"block_id":"RkZodYq2CoC0ADxlhiWcTUUbnJb","block_type":12,"bullet":{"elements":[{"text_run":{"content":"已拒绝的图片可以重新审核为通过","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"H0C5dkqi1oCAdRxeDaXckWWDnpf"},{"block_id":"JZWrdlhusoSesWxBEutc8TkMn7c","block_type":12,"bullet":{"elements":[{"text_run":{"content":"已通过的图片可以撤销为拒绝状态","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"H0C5dkqi1oCAdRxeDaXckWWDnpf"},{"block_id":"L7hkd2ZM2o2EIpxrWa8cYv40nuh","block_type":13,"ordered":{"elements":[{"text_run":{"content":"管理员自动审核：管理员上传/更新图片时，图片自动审核通过，并且自动填充审核参数一—设置审核人为创建人、审核时间为当前时间、审核原因为“管理员自动过审”。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"JMpwdwsxIonmlox5Ql3cqp11nce","block_type":13,"ordered":{"elements":[{"text_run":{"content":"用户操作需要审核：用户上传或编辑图片时，图片的状态会被重置为“待审核”。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"IUgGdTO4QowdY2xTwjScAGvHn9f","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"重复审核时，既可以选择重置所有审核参数，也可以仅重置审核状态。其余参数在前端不展示，但是在后端保留，以便管理员参考历史审核信息。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"L6q4d7jMpoLUqdxcHi6c3HyjnBf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"控制内容可见性；对于用户来说，应该只能看见“审核通过”状态的数据；管理员可以在图片管理页面看到所有数据，并且根据审核状态筛选图片。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"NUKNdQhOAoiY16xASCecwxOFnAz","block_type":34,"children":["NSL3de0ngoeyhpxp3AVckmkGnPe","UKZLdZGZVoYzbdxEzshclrnwn5c"],"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","quote_container":{}},{"block_id":"NSL3de0ngoeyhpxp3AVckmkGnPe","block_type":2,"parent_id":"NUKNdQhOAoiY16xASCecwxOFnAz","text":{"elements":[{"text_run":{"content":"Q：是否要考虑并发问题呢？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"UKZLdZGZVoYzbdxEzshclrnwn5c","block_type":2,"parent_id":"NUKNdQhOAoiY16xASCecwxOFnAz","text":{"elements":[{"text_run":{"content":"A：由于审核操作为管理员手动执行，不涉及复杂的奖励机制或并发高频请求，误审核或重复审核对系统影响不大，因此无需过度考虑并发问题。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"LFJbdw5Z7ob7XNxhJCOcvxtdnqd","block_type":5,"heading3":{"elements":[{"text_run":{"content":"库表设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VRKKd3QYKoExPYxnkgzcvLC5nJc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"为了支持审核功能，我们在picture图片表中新增审核相关字段，同时优化索引设计以提升查询性能。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Aw2Ody5Jlongukx2HqZcuTPpnWf","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"修改表的 SQL 如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"G9KMdoRTroRHFJx5OuTcLAnVnAe","block_type":14,"code":{"elements":[{"text_run":{"content":"ALTER TABLE picture  \n    -- 添加新列  \n    ADD COLUMN reviewStatus INT DEFAULT 0 NOT NULL COMMENT '审核状态：0-待审核; 1-通过; 2-拒绝',  \n    ADD COLUMN reviewMessage VARCHAR(512) NULL COMMENT '审核信息',  \n    ADD COLUMN reviewerId BIGINT NULL COMMENT '审核人 ID',  \n    ADD COLUMN reviewTime DATETIME NULL COMMENT '审核时间';  \n  \n-- 创建基于 reviewStatus 列的索引  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"CREATE INDEX idx_reviewStatus ON picture (reviewStatus);","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":56,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"E76Rdk0WNonQxLxjI4ac1RCsnEh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"注意事项:","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"LaTndAT7xoEwWYx75hjc6eu9nad","block_type":13,"ordered":{"elements":[{"text_run":{"content":"审核状态：reviewStatus使用整数(0、1、2)表示不同的审核状态，而不是用字符串，可以节约表的空间、提升查找效率。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"OXSpdU9OBouDHzxM4xYcRJTYn8d","block_type":13,"ordered":{"elements":[{"text_run":{"content":"索引设计：由于要根据审核状态筛选图片，所以给该字段添加索引，提升查询性能。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"LnPJdOCWtoTB33xoHBlchOWInog","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"下面我们进行开发，先后端再前端。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"DJa1dvcJ9o5LJnxu3ZScgnnfnnb","block_type":4,"heading2":{"elements":[{"text_run":{"content":"后端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"ZaoAdelhooO5ckxi0QHcGVmpnWe","block_type":5,"heading3":{"elements":[{"text_run":{"content":"数据模型开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"A0Opdm47qo6Ww1xlUgwc3r2Rnif","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"由于新增一些审核相关的字段，要对原有的数据模型进行修改","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"RU45d5DXNofqpzxzimlcLK05n6g","block_type":13,"ordered":{"elements":[{"text_run":{"content":"实体类Picture新增","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"PIeHdXiYkoye5txEB3KcsDsqnOh","block_type":14,"code":{"elements":[{"text_run":{"content":"/**  \n * 状态：0-待审核; 1-通过; 2-拒绝  \n */  \nprivate Integer reviewStatus;  \n  \n/**  \n * 审核信息  \n */  \nprivate String reviewMessage;  \n  \n/**  \n * 审核人 id  \n */  \nprivate Long reviewerId;  \n  \n/**  \n * 审核时间  \n */  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"private Date reviewTime;","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":9,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Sr6ddMrO8oJZ72xonTFcT28nn9c","block_type":13,"ordered":{"elements":[{"text_run":{"content":"图片查询请求类PictureQueryRequest，新增","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"E7UFdK0oCovR0XxJvxDcdE5Vnuh","block_type":14,"code":{"elements":[{"text_run":{"content":"/**  \n * 状态：0-待审核; 1-通过; 2-拒绝  \n */  \nprivate Integer reviewStatus;  \n  \n/**  \n * 审核信息  \n */  \nprivate String reviewMessage;  \n  \n/**  \n * 审核人 id  \n */  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"private Long reviewerId;","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"A5mTdJwVfo1xpNxBuElcZCQunIb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"新建审核状态枚举类","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Lec9dZV5foLg1Mx5QrLcgcqbnlc","block_type":14,"code":{"elements":[{"text_run":{"content":"@Getter  \npublic enum PictureReviewStatusEnum {  \n    REVIEWING(\"待审核\", 0),  \n    PASS(\"通过\", 1),  \n    REJECT(\"拒绝\", 2);  \n  \n    private final String text;  \n    private final int value;  \n  \n    PictureReviewStatusEnum(String text, int value) {  \n        this.text = text;  \n        this.value = value;  \n    }  \n  \n    /**  \n     * 根据 value 获取枚举  \n     */  \n    public static PictureReviewStatusEnum getEnumByValue(Integer value) {  \n        if (ObjUtil.isEmpty(value)) {  \n            return null;  \n        }  \n        for (PictureReviewStatusEnum pictureReviewStatusEnum : PictureReviewStatusEnum.values()) {  \n            if (pictureReviewStatusEnum.value == value) {  \n                return pictureReviewStatusEnum;  \n            }  \n        }  \n        return null;  \n    }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"KCJcduRKpoosasxDLLwcpZK4nFT","block_type":5,"heading3":{"elements":[{"text_run":{"content":"管理员审核功能","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"QOuTdm4wHosL0FxJI38cKXpLn9e","block_type":13,"ordered":{"elements":[{"text_run":{"content":"开发请求包装类，注意不需要增加reviewId和reviewTime这两个是由系统自动填充的，而不是由前端传递。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"PlRbdI1r9o1XyBxMoiUcQaoEnyc","block_type":14,"code":{"elements":[{"text_run":{"content":"@Data  \npublic class PictureReviewRequest implements Serializable {  \n  \n    /**  \n     * id  \n     */  \n    private Long id;  \n  \n    /**  \n     * 状态：0-待审核, 1-通过, 2-拒绝  \n     */  \n    private Integer reviewStatus;  \n  \n    /**  \n     * 审核信息  \n     */  \n    private String reviewMessage;  \n  \n  \n    private static final long serialVersionUID = 1L;  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":9,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"ApRqdn9ndogHmrxseCfcngpWnqb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"开发审核服务","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VNBrdxZMnoD2rfxRCWLc5nManch","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"接口：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZbORd83KqoyGpkxT1cEcvh8Ln9b","block_type":14,"code":{"elements":[{"text_run":{"content":"/**  \n * 图片审核  \n *  \n * @param pictureReviewRequest  \n * @param loginUser  \n */  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"void doPictureReview(PictureReviewRequest pictureReviewRequest, User loginUser);","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"OXvUdMwvso2BrhxXrovcD9IFnQh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"实现类：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"JxXMdvcS5ofVyGxtyhocI8XPnZd","block_type":14,"code":{"elements":[{"text_run":{"content":"@Override  \npublic void doPictureReview(PictureReviewRequest pictureReviewRequest, User loginUser) {  \n    Long id = pictureReviewRequest.getId();  \n    Integer reviewStatus = pictureReviewRequest.getReviewStatus();  \n    PictureReviewStatusEnum reviewStatusEnum = PictureReviewStatusEnum.getEnumByValue(reviewStatus);  \n    if (id == null || reviewStatusEnum == null || PictureReviewStatusEnum.REVIEWING.equals(reviewStatusEnum)) {  \n        throw new BusinessException(ErrorCode.PARAMS_ERROR);  \n    }  \n    // 判断是否存在  \n    Picture oldPicture = this.getById(id);  \n    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);  \n    // 已是该状态  \n    if (oldPicture.getReviewStatus().equals(reviewStatus)) {  \n        throw new BusinessException(ErrorCode.PARAMS_ERROR, \"请勿重复审核\");  \n    }  \n    // 更新审核状态  \n    Picture updatePicture = new Picture();  \n    BeanUtils.copyProperties(pictureReviewRequest, updatePicture);  \n    updatePicture.setReviewerId(loginUser.getId());  \n    updatePicture.setReviewTime(new Date());  \n    boolean result = this.updateById(updatePicture);  \n    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"CBj1dAj1Vo8LTCxGHu5cfkfNnZd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"开发审核接口，加上管理员权限","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"BKV0dhu1Yo0L7qxuhkuc3vShnLb","block_type":14,"code":{"elements":[{"text_run":{"content":"@PostMapping(\"/review\")  \n@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  \npublic BaseResponse<Boolean> doPictureReview(@RequestBody PictureReviewRequest pictureReviewRequest,  \n                                             HttpServletRequest request) {  \n    ThrowUtils.throwIf(pictureReviewRequest == null, ErrorCode.PARAMS_ERROR);  \n    User loginUser = userService.getLoginUser(request);  \n    pictureService.doPictureReview(pictureReviewRequest, loginUser);  \n    return ResultUtils.success(true);  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"YX2wdqfNFo5f06xu44jc2XD5nZo","block_type":5,"heading3":{"elements":[{"text_run":{"content":"审核状态控制","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Kz4xdI4RqosYvyxqDKvcru04nUg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"权限控制","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"XlTJdhZ6poT653xgf4Scedxgned","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"首先取消上传图片接口（uploadPicture）的权限校验注解，但是注意，由于图片上传功能是支持图片编辑的，所以需要做好编辑权限控制———仅本人或管理员可编辑。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"C3r8dvLgQoLqRvx4iybcXz3wnUe","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"修改 PictureService的uploadPicture 方法，补充权限校验逻辑：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"TLXMdXZfjo7MdkxzPBecnAgfnyg","block_type":14,"code":{"elements":[{"text_run":{"content":"// 如果是更新图片，需要校验图片是否存在  \nif (pictureId != null) {  \n    Picture oldPicture = this.getById(pictureId);  \n    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR, \"图片不存在\");  \n    // 仅本人或管理员可编辑  \n    if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {  \n        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);  \n    }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"O3FBd8S2eoOe8pxccEecessrnme","block_type":13,"ordered":{"elements":[{"text_run":{"content":"设置审核状态：管理员自动过审并且填充审核参数；用户上传或编辑图片时，图片的状态会被重置为“待审核”。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"ZQEjdEHFeoYmj7xbf8ncJNp9nrg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"由于图片上传、用户编辑、管理员更新这3个操作都需要设置审核状态，所以我们可以先编写一个通用的“补充审核参数”的方法，根据用户的角色给图片对象填充审核字段的值。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"VieNdXi3ZoTY2GxIl40c5uksnbd","block_type":14,"code":{"elements":[{"text_run":{"content":"@Override  \npublic void fillReviewParams(Picture picture, User loginUser) {  \n    if (userService.isAdmin(loginUser)) {  \n        // 管理员自动过审  \n        picture.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());  \n        picture.setReviewerId(loginUser.getId());  \n        picture.setReviewMessage(\"管理员自动过审\");  \n        picture.setReviewTime(new Date());  \n    } else {  \n        // 非管理员，创建或编辑都要改为待审核  \n        picture.setReviewStatus(PictureReviewStatusEnum.REVIEWING.getValue());  \n    }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"BMeidIU5ZobMKpxRV0rcKTKTnxg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"分别给三个操作增加审核参数。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"CxKldk6JKo5HmJxbRglc8S1MnZg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"图片更新接口","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"W4aVds1LioAvPyxtBZ7cRxdBnUb","block_type":14,"code":{"elements":[{"text_run":{"content":"public BaseResponse<Boolean> updatePicture(@RequestBody PictureUpdateRequest pictureUpdateRequest  \n        , HttpServletRequest request) {  \n    // ...  \n    Picture oldPicture = pictureService.getById(id);  \n    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);  \n    // 补充审核参数  \n    User loginUser = userService.getLoginUser(request);  \n    pictureService.fillReviewParams(picture, loginUser);  \n    // 操作数据库  \n    boolean result = pictureService.updateById(picture);  \n    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  \n    return ResultUtils.success(true);  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VuTedbqBuohJqrxJSZmcic3hn3f","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"图片修改接口","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"S30EdKsgaoTQUXxZ5oKcb1bvnLb","block_type":14,"code":{"elements":[{"text_run":{"content":"public BaseResponse<Boolean> editPicture(@RequestBody PictureEditRequest pictureEditRequest, HttpServletRequest request) {  \n    // ...  \n    if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {  \n        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);  \n    }  \n    // 补充审核参数  \n    pictureService.fillReviewParams(picture, loginUser);  \n    // 操作数据库  \n    boolean result = pictureService.updateById(picture);  \n    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  \n    return ResultUtils.success(true);  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VhGfdUFINoeofjxwGfMcWEGjnvb","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"上传图片服务","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Nmx3dr2Gzo7Jp6xj3GKcy1stnIj","block_type":14,"code":{"elements":[{"text_run":{"content":"@Override  \npublic PictureVO uploadPicture(Object inputSource, PictureUploadRequest pictureUploadRequest, User loginUser) {  \n    // ...  \n    picture.setPicFormat(uploadPictureResult.getPicFormat());  \n    picture.setUserId(loginUser.getId());  \n    // 补充审核参数  \n    fillReviewParams(picture, loginUser);  \n    // 如果 pictureId 不为空，表示更新，否则是新增  \n    if (pictureId != null) {  \n        // 如果是更新，需要补充 id 和编辑时间  \n        picture.setId(pictureId);  \n        picture.setEditTime(new Date());  \n    }  \n    // ...  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"LEuxdPEpNo6q32xdPxScrNe0nDb","block_type":5,"heading3":{"elements":[{"text_run":{"content":"控制内容可见性","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"MK5rdB9ICoCChfxMCmUcFklqnJg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"目前我们只有主页给用户查看图片列表，所以需要修改主页调用的listPictureVOByPage接口，补充查询条件即可，默认只能查看已过审的数据：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"UTEIduGAeojjRtxUEE2cXgwyn0d","block_type":14,"code":{"elements":[{"text_run":{"content":"// 普通用户默认只能查看已过审的数据  \npictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());  \n// 查询数据库  \nPage<Picture> picturePage = pictureService.page(new Page<>(current, size),  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"        pictureService.getQueryWrapper(pictureQueryRequest));","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Tvs2dOUxqoymAjxER5ScWR87nhe","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"需要同步更改PictureService的getQueryWrapper方法，支持根据审核字段进行查询:","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"VAdWdSjazokE4rxSDB2cc5KpnJe","block_type":14,"code":{"elements":[{"text_run":{"content":"Integer reviewStatus = pictureQueryRequest.getReviewStatus();  \nString reviewMessage = pictureQueryRequest.getReviewMessage();  \nLong reviewerId = pictureQueryRequest.getReviewerId();  \nqueryWrapper.eq(ObjUtil.isNotEmpty(reviewStatus), \"reviewStatus\", reviewStatus);  \nqueryWrapper.like(StrUtil.isNotBlank(reviewMessage), \"reviewMessage\", reviewMessage);  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"queryWrapper.eq(ObjUtil.isNotEmpty(reviewerId), \"reviewerId\", reviewerId);","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"MZ8Pdik3fowGnsxM6YScHQhsnfc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"这样一来，后端就同时支持了“管理员筛选审核状态”的功能。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"YqbSds1AGoIZ1IxBY2dc5xvdnRc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"至此，用户上传图片及审核的后端就开发完成了。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"LjBDdnqVSoRu0CxkWCMcYmZ7nkc","block_type":34,"children":["IrRAdhg1Moi0GPxmkgbckZzAnre","RAssd7DyGo0elNxaV50cMUUKnHh"],"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","quote_container":{}},{"block_id":"IrRAdhg1Moi0GPxmkgbckZzAnre","block_type":2,"parent_id":"LjBDdnqVSoRu0CxkWCMcYmZ7nkc","text":{"elements":[{"text_run":{"content":"Q：根据id查询图片的接口需要做同样的限制么？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"RAssd7DyGo0elNxaV50cMUUKnHh","block_type":2,"parent_id":"LjBDdnqVSoRu0CxkWCMcYmZ7nkc","text":{"elements":[{"text_run":{"content":"A：对目前咱们的系统来说，用户正常情况下不会得到未过审图片的id，影响面较小，可以暂时不做。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IOjUdutZfossqGxuN5scimQ8nTc","block_type":4,"heading2":{"elements":[{"text_run":{"content":"前端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"XssLd78bBobACdxBKh4cFKmTnQb","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"控制首页未过审的图片不可见已经通过后端接口实现，我们只需开发管理员审核和按审核状态筛选图片功能即可。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"TDQMdHCxoodJ0ExyOXrcl34UnAc","block_type":5,"heading3":{"elements":[{"text_run":{"content":"定义审核常量","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"NeR9d3dNHoApGPxAj6wc7nBhnpc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"和后端一样，前端也有很多地方要用到审核状态信息，可以定义为一个常量。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"JA08dgTSLowWqBxsmx5cwoswnvf","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"在constants目录下新建picture.ts常量文件，定义枚举信息、对应的中文映射、以及后续筛选审核状态时要用到的选项数组：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"A4HBdWYA8olh32xATVrcAnH8nug","block_type":14,"code":{"elements":[{"text_run":{"content":"export const PIC_REVIEW_STATUS_ENUM = {  \n  REVIEWING: 0,  \n  PASS: 1,  \n  REJECT: 2,  \n}  \n  \nexport const PIC_REVIEW_STATUS_MAP = {  \n  0: '待审核',  \n  1: '通过',  \n  2: '拒绝',  \n}  \n  \nexport const PIC_REVIEW_STATUS_OPTIONS = Object.keys(PIC_REVIEW_STATUS_MAP).map((key) => {  \n  return {  \n    label: PIC_REVIEW_STATUS_MAP[key],  \n    value: key,  \n  }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"})","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":30,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"H2Ild1ETWojbHyxFCHecFxUSnTd","block_type":5,"heading3":{"elements":[{"text_run":{"content":"管理员审核功能","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"YkSkdlqxSobbSuxQOv4cXhhCnth","block_type":13,"ordered":{"elements":[{"text_run":{"content":"表格列新增审核信息","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"NPPZdMEkHo6SrGxTTGtcEjeMnyg","block_type":14,"code":{"elements":[{"text_run":{"content":"const columns = [  \n  // ...  \n  {  \n    title: '审核信息',  \n    dataIndex: 'reviewMessage',  \n  },  \n  // ...  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"]","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"HWVkdqsNrocL5UxmduzcAi9wnYg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"自定义审核列需要展示的内容","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"YclTdJd83ol9KRxj7FycT6kKnoe","block_type":14,"code":{"elements":[{"text_run":{"content":"<!-- 审核信息 -->  \n<template v-if=\"column.dataIndex === 'reviewMessage'\">  \n  <div>审核状态：{{ PIC_REVIEW_STATUS_MAP[record.reviewStatus] }}</div>  \n  <div>审核信息：{{ record.reviewMessage }}</div>  \n  <div>审核人：{{ record.reviewerId }}</div>  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</template>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"TvnXdgEe0oOB3uxllDJc36hTnBd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"新增审核通过和拒绝的按钮","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"TKpIdgnfnoxg3LxATZec3dgAn2e","block_type":14,"code":{"elements":[{"text_run":{"content":"<template v-else-if=\"column.key === 'action'\">  \n  <a-space wrap>  \n    <a-button  \n      v-if=\"record.reviewStatus !== PIC_REVIEW_STATUS_ENUM.PASS\"  \n      type=\"link\"  \n      @click=\"handleReview(record, PIC_REVIEW_STATUS_ENUM.PASS)\"  \n    >  \n      通过  \n    </a-button>  \n    <a-button  \n      v-if=\"record.reviewStatus !== PIC_REVIEW_STATUS_ENUM.REJECT\"  \n      type=\"link\"  \n      danger  \n      @click=\"handleReview(record, PIC_REVIEW_STATUS_ENUM.REJECT)\"  \n    >  \n      拒绝  \n    </a-button>  \n    <a-button type=\"link\" :href=\"`/add_picture?id=${record.id}`\" target=\"_blank\"  \n      >编辑  \n    </a-button>  \n    <a-button type=\"link\" danger @click=\"doDelete(record.id)\">删除</a-button>  \n  </a-space>  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</template>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"MtdadCyHpoxlRnxyVdscv6iznig","block_type":13,"ordered":{"elements":[{"text_run":{"content":"编写审核函数，调用后端完成操作","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"NkP8dkeDuou9mtxq8Doc7u0pnRd","block_type":14,"code":{"elements":[{"text_run":{"content":"const handleReview = async (record: API.Picture, reviewStatus: number) => {  \n  const reviewMessage = reviewStatus === PIC_REVIEW_STATUS_ENUM.PASS ? '管理员操作通过' : '管理员操作拒绝'  \n  const res = await doPictureReviewUsingPost({  \n    id: record.id,  \n    reviewStatus,  \n    reviewMessage,  \n  })  \n  if (res.data.code === 0) {  \n    message.success('审核操作成功')  \n    // 重新获取列表  \n    fetchData()  \n  } else {  \n    message.error('审核操作失败，' + res.data.message)  \n  }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"LXFDdwBkQoIDuUxePirclt5mnxc","block_type":5,"heading3":{"elements":[{"text_run":{"content":"按审核状态筛选","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"TmEadX152oQLATxhK26c0AGynwc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"只需要在原来的搜索表单中补充一个表单项即可，使用下拉框组件，传入定义好的审核状态常量作为选项：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"UbyvdN1kXoE30CxEaENcCHRfnQg","block_type":14,"code":{"elements":[{"text_run":{"content":"<a-form-item label=\"审核状态\" name=\"reviewStatus\">  \n  <a-select  \n    v-model:value=\"searchParams.reviewStatus\"  \n    :options=\"PIC_REVIEW_STATUS_OPTIONS\"  \n    placeholder=\"请输入审核状态\"  \n    style=\"min-width: 180px\"  \n    allow-clear  \n  />  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</a-form-item>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"RuAldFczLopcqKxKGwxcNFwpn6c","block_type":22,"divider":{},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"OoN2dUKgpoSuLrxv7LtcN4KjnEG","block_type":3,"heading1":{"elements":[{"text_run":{"content":"通过URL导入图片","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"F76mdmfHaoMtOJx4IF3cvi2onwb","block_type":4,"heading2":{"elements":[{"text_run":{"content":"需求分析","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"GifbdeqqvoiSYcxijSjcEq9Yndd","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"为了提高上传图片的效率，除了支持上传本地文件外，还可以支持输入一个远程URL，直接将网上已有的图片导入到我们的系统中。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"KFFTdsT9voVDlFxA0j6csqf0nYd","block_type":4,"heading2":{"elements":[{"text_run":{"content":"方案设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"UwNEd6hBNodl8Bx8Q7zcrYhRn8g","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"实现原理很简单，但是有一些细节需要注意：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"A8eQdUd3XoVRmGxuXWTc2MbBnyf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"下载图片：后端服务器从指定的远程URL下载图片到本地临时存储。对于Java项目，可以直接使用Hutool的HttpUtil.downloadFile方法一行代码完成。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"O4svdphnwoyjkVx9E6ncJxuDnWf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"校验图片：跟验证本地文件一样，需要校验图片的格式、大小等。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"MydOdowSmo96aoxtSyQcn2ojncd","block_type":34,"children":["PWb9dgVd4o4cu8xv2lCcKFFtn5g","HCcvdIlQvoRscgxfR9QcinXtnJg"],"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","quote_container":{}},{"block_id":"PWb9dgVd4o4cu8xv2lCcKFFtn5g","block_type":2,"parent_id":"MydOdowSmo96aoxtSyQcn2ojncd","text":{"elements":[{"text_run":{"content":"Q:传统的校验思路是先把文件下载到本地，再对本地文件进行校验，有没有更节省资源的方法呢？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"HCcvdIlQvoRscgxfR9QcinXtnJg","block_type":2,"parent_id":"MydOdowSmo96aoxtSyQcn2ojncd","text":{"elements":[{"text_run":{"content":"A:","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"其实可以先对URL本身进行校验。 ","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 首先是校验URL字符串本身的合法性，比如要是一个合理的URL地址。此外，可以先使用HEAD请求来获取URL对应文件的元信息（如文件大小、格式等)。HEAD请求仅返回HTTP响应头信息，而不会下载文件的内容，大大降低了网络流量的消耗。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"UUKndVCZnob8PBxLwLNccXpvnNe","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"注意此处不能使用GET请求，它会获取完整文件。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"RxQddfYZvongLQxtUDJcIbPQnxb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"上传图片：将校验通过的图片上传到对象存储服务，生成存储URL。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"WVgCdILxuoab1kxpqK9cydNGnXR","block_type":34,"children":["UjtWd4dYLoLu1pxegCscZnm7nzd"],"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","quote_container":{}},{"block_id":"UjtWd4dYLoLu1pxegCscZnm7nzd","block_type":2,"parent_id":"WVgCdILxuoab1kxpqK9cydNGnXR","text":{"elements":[{"text_run":{"content":"之后的流程就都可以复用从本地上传图片的流程了。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"V4IqdO6z3ohCQkxlRofcSKBOnUY","block_type":4,"heading2":{"elements":[{"text_run":{"content":"后端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"ZP0ydgPiyo4Vl5xVKMgcHfbcnJd","block_type":5,"heading3":{"elements":[{"text_run":{"content":"服务开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"KsDNdrSmio85nnxuzAOczq6NnHg","block_type":2,"children":["GfE2dCt8Poa1HzxCURAch63anlc","UWYPdkGRPod2vVxSkNpcOuaUnZb","J1YxdYeZQowC5gxIHFZc9cb4n1H","VVj1dBGlboVV1AxRcodcB9wqnIe"],"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"先编写通过URL上传文件的方法，为了便于开发，直接在FileManager类中编写，绝大多数代码跟之前的uploadPicture方法一致，只需要改动以下4处位置：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"GfE2dCt8Poa1HzxCURAch63anlc","block_type":13,"ordered":{"elements":[{"text_run":{"content":"方法接受的参数：之前是MultipartFile文件类型，现在是String字符串类型","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"KsDNdrSmio85nnxuzAOczq6NnHg"},{"block_id":"UWYPdkGRPod2vVxSkNpcOuaUnZb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"校验图片：之前是校验文件，现在是校验URL","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"KsDNdrSmio85nnxuzAOczq6NnHg"},{"block_id":"J1YxdYeZQowC5gxIHFZc9cb4n1H","block_type":13,"ordered":{"elements":[{"text_run":{"content":"获取文件名称：之前是根据文件获取，现在是根据URL获取","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"KsDNdrSmio85nnxuzAOczq6NnHg"},{"block_id":"VVj1dBGlboVV1AxRcodcB9wqnIe","block_type":13,"ordered":{"elements":[{"text_run":{"content":"保存临时文件：之前是将MultipartFile写入到临时文件，现在是从URL下载文件","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"KsDNdrSmio85nnxuzAOczq6NnHg"},{"block_id":"UBQMdl0b5osMEtx3jCIchmzTnYg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"代码如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"WQiAdTmVroxhlmxJx91cAYdZnDc","block_type":14,"code":{"elements":[{"text_run":{"content":"public UploadPictureResult uploadPictureByUrl(String fileUrl, String uploadPathPrefix) {  \n    // 校验图片  \n    // validPicture(multipartFile);  \n    validPicture(fileUrl);  \n    // 图片上传地址  \n    String uuid = RandomUtil.randomString(16);  \n    // String originFilename = multipartFile.getOriginalFilename();  \n    String originFilename = FileUtil.mainName(fileUrl);  \n    String uploadFilename = String.format(\"%s_%s.%s\", DateUtil.formatDate(new Date()), uuid,  \n            FileUtil.getSuffix(originFilename));  \n    String uploadPath = String.format(\"/%s/%s\", uploadPathPrefix, uploadFilename);  \n    File file = null;  \n    try {  \n        // 创建临时文件  \n        file = File.createTempFile(uploadPath, null);  \n        // multipartFile.transferTo(file);  \n        HttpUtil.downloadFile(fileUrl, file);  \n        // 上传图片  \n        // ... 其余代码保持不变  \n    } catch (Exception e) {  \n        log.error(\"图片上传到对象存储失败\", e);  \n        throw new BusinessException(ErrorCode.SYSTEM_ERROR, \"上传失败\");  \n    } finally {  \n        this.deleteTempFile(file);  \n    }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Di9JdGDPIotTCVxU2IScNF41n3c","block_type":5,"heading3":{"elements":[{"text_run":{"content":"校验URL图片","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"LARCdOncVoRxlixWpRHc46RXnLg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"编写校验URL图片的方法，分别校验URL格式、协议、文件是否存在、文件格式、文件大小。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"BLNRd7JcIowtKexYpi3co09hnOg","block_type":14,"code":{"elements":[{"text_run":{"content":"private void validPicture(String fileUrl) {  \n    ThrowUtils.throwIf(StrUtil.isBlank(fileUrl), ErrorCode.PARAMS_ERROR, \"文件地址不能为空\");  \n  \n    try {  \n        // 1. 验证 URL 格式  \n        new URL(fileUrl); // 验证是否是合法的 URL  \n    } catch (MalformedURLException e) {  \n        throw new BusinessException(ErrorCode.PARAMS_ERROR, \"文件地址格式不正确\");  \n    }  \n  \n    // 2. 校验 URL 协议  \n    ThrowUtils.throwIf(!(fileUrl.startsWith(\"http://\") || fileUrl.startsWith(\"https://\")),  \n            ErrorCode.PARAMS_ERROR, \"仅支持 HTTP 或 HTTPS 协议的文件地址\");  \n  \n    // 3. 发送 HEAD 请求以验证文件是否存在  \n    HttpResponse response = null;  \n    try {  \n        response = HttpUtil.createRequest(Method.HEAD, fileUrl).execute();  \n        // 未正常返回，无需执行其他判断  \n        if (response.getStatus() != HttpStatus.HTTP_OK) {  \n            return;  \n        }  \n        // 4. 校验文件类型  \n        String contentType = response.header(\"Content-Type\");  \n        if (StrUtil.isNotBlank(contentType)) {  \n            // 允许的图片类型  \n            final List<String> ALLOW_CONTENT_TYPES = Arrays.asList(\"image/jpeg\", \"image/jpg\", \"image/png\", \"image/webp\");  \n            ThrowUtils.throwIf(!ALLOW_CONTENT_TYPES.contains(contentType.toLowerCase()),  \n                    ErrorCode.PARAMS_ERROR, \"文件类型错误\");  \n        }  \n        // 5. 校验文件大小  \n        String contentLengthStr = response.header(\"Content-Length\");  \n        if (StrUtil.isNotBlank(contentLengthStr)) {  \n            try {  \n                long contentLength = Long.parseLong(contentLengthStr);  \n                final long TWO_MB = 2 * 1024 * 1024L; // 限制文件大小为 2MB  \n                ThrowUtils.throwIf(contentLength > TWO_MB, ErrorCode.PARAMS_ERROR, \"文件大小不能超过 2M\");  \n            } catch (NumberFormatException e) {  \n                throw new BusinessException(ErrorCode.PARAMS_ERROR, \"文件大小格式错误\");  \n            }  \n        }  \n    } finally {  \n        if (response != null) {  \n            response.close();  \n        }  \n    }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"TaGcddcLZoMRK3xrdWMcuO4zn3g","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"上述代码中，注意2点：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IFXgdxscRo63rtxsURScrUFAnbg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"注意发送HTTP请求后，需要即时释放资源","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"UkhWd0UffowYzIxnSxucT163nNb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"有些URL地址可能不支持通过HEAD请求访问，为了提高导入成功率，即使HEAD请求访问失败，也不会报错，并且不用执行后续的校验。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"仅对能获取到的信息进行校验。","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"ES09duA1qo1CFVxJM5EcdOYtnLc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"BHZ1d3viPoKoKfxiDXVcOy3SnWc","block_type":5,"heading3":{"elements":[{"text_run":{"content":"优化代码","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"LzmQdKHsYoc3jPxQjXTckUe0n2f","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"目前我们的FileManager文件内写了两种不同的上传文件的方法，但是我们会发现，这两种方法的流程完全一致、而且大多数代码都是相同的。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZV5FdnR7LoQjXSxphf0ckFefnih","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"这种情况下，我们就要想要运用设计模式——","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"模板方法模式","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 对代码进行优化。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"JIcndVDePoWVDkxjnINcNZryn48","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"模板方法模式是行为型设计模式，适用于具有通用处理流程、但处理细节不同的情况。通过定义一个抽象模板类，提供通用的业务流程处理逻辑，并将不同的部分定义为抽象方法，由子类具体实现。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"RbPMdSJ76oWFXDx4kZbcZzivn8e","block_type":2,"children":["YN1XdTl3WohmjsxOyj3cLVronpg","WPi1d53FQoRlJrx1TBgcMhsinHf","WiQodYxJ4oH7nXxKBL9cEeoBnWg","Im6GdhlKAo6zjlxyTLecfoscnUf","TTZsd6qS7ojzLpx9s5kcDVEknSd","XPaYdKqmhonPYIxONXlcX1xsnRg"],"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"在我们的场景中，两种文件上传方法的流程都是：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"YN1XdTl3WohmjsxOyj3cLVronpg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"校验文件","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"RbPMdSJ76oWFXDx4kZbcZzivn8e"},{"block_id":"WPi1d53FQoRlJrx1TBgcMhsinHf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"获取上传地址","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"RbPMdSJ76oWFXDx4kZbcZzivn8e"},{"block_id":"WiQodYxJ4oH7nXxKBL9cEeoBnWg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"获取本地临时文件","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"RbPMdSJ76oWFXDx4kZbcZzivn8e"},{"block_id":"Im6GdhlKAo6zjlxyTLecfoscnUf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"上传到对象存储","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"RbPMdSJ76oWFXDx4kZbcZzivn8e"},{"block_id":"TTZsd6qS7ojzLpx9s5kcDVEknSd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"封装解析得到的图片信息","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"RbPMdSJ76oWFXDx4kZbcZzivn8e"},{"block_id":"XPaYdKqmhonPYIxONXlcX1xsnRg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"清理临时文件","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"RbPMdSJ76oWFXDx4kZbcZzivn8e"},{"block_id":"Kbjzd5PQaoO7NOxhPOEcN6lqn7d","block_type":2,"children":["SHozdoiJdoWJLTxc7LUchBjJnPc","GDBDdD7zXoVLuaxR44icExiQnmd","MDmpdDcmMoxvMMxd5M2cXFmcnzL"],"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"可以将这些流程抽象为一套模板（抽象类)，将每个实现不一样的步骤都定义为一个抽象方法，比如：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SHozdoiJdoWJLTxc7LUchBjJnPc","block_type":13,"ordered":{"elements":[{"text_run":{"content":"校验图片","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"Kbjzd5PQaoO7NOxhPOEcN6lqn7d"},{"block_id":"GDBDdD7zXoVLuaxR44icExiQnmd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"获取文件名称","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"Kbjzd5PQaoO7NOxhPOEcN6lqn7d"},{"block_id":"MDmpdDcmMoxvMMxd5M2cXFmcnzL","block_type":13,"ordered":{"elements":[{"text_run":{"content":"保存临时文件","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"Kbjzd5PQaoO7NOxhPOEcN6lqn7d"},{"block_id":"FW1UdVoo2okn40xHZCgcxQbYn8g","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"下面开始开发，先在manager包下创建upload包，将模板方法有关的代码全部放在该包下统一管理。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"PTgod2GuJoO9mzxshYScHFJUnEe","block_type":13,"ordered":{"elements":[{"text_run":{"content":"新建图片上传抽象类PictureUploadTemplate","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"FDOVdhgjjon1R1xoVrNcIsJdnZb","block_type":14,"code":{"elements":[{"text_run":{"content":"@Slf4j  \npublic abstract class PictureUploadTemplate {  \n  \n    @Resource  \n    protected CosManager cosManager;  \n  \n    @Resource  \n    protected CosClientConfig cosClientConfig;  \n  \n    /**  \n     * 模板方法，定义上传流程  \n     */  \n    public final UploadPictureResult uploadPicture(Object inputSource, String uploadPathPrefix) {  \n        // 1. 校验图片  \n        validPicture(inputSource);  \n  \n        // 2. 图片上传地址  \n        String uuid = RandomUtil.randomString(16);  \n        String originFilename = getOriginFilename(inputSource);  \n        String uploadFilename = String.format(\"%s_%s.%s\", DateUtil.formatDate(new Date()), uuid,  \n                FileUtil.getSuffix(originFilename));  \n        String uploadPath = String.format(\"/%s/%s\", uploadPathPrefix, uploadFilename);  \n  \n        File file = null;  \n        try {  \n            // 3. 创建临时文件  \n            file = File.createTempFile(uploadPath, null);  \n            // 处理文件来源（本地或 URL）  \n            processFile(inputSource, file);  \n  \n            // 4. 上传图片到对象存储  \n            PutObjectResult putObjectResult = cosManager.putPictureObject(uploadPath, file);  \n            ImageInfo imageInfo = putObjectResult.getCiUploadResult().getOriginalInfo().getImageInfo();  \n  \n            // 5. 封装返回结果  \n            return buildResult(originFilename, file, uploadPath, imageInfo);  \n        } catch (Exception e) {  \n            log.error(\"图片上传到对象存储失败\", e);  \n            throw new BusinessException(ErrorCode.SYSTEM_ERROR, \"上传失败\");  \n        } finally {  \n            // 6. 清理临时文件  \n            deleteTempFile(file);  \n        }  \n    }  \n  \n    /**  \n     * 校验输入源（本地文件或 URL）  \n     */  \n    protected abstract void validPicture(Object inputSource);  \n  \n    /**  \n     * 获取输入源的原始文件名  \n     */  \n    protected abstract String getOriginFilename(Object inputSource);  \n  \n    /**  \n     * 处理输入源并生成本地临时文件  \n     */  \n    protected abstract void processFile(Object inputSource, File file) throws Exception;  \n  \n    /**  \n     * 封装返回结果  \n     */  \n    private UploadPictureResult buildResult(String originFilename, File file, String uploadPath, ImageInfo imageInfo) {  \n        UploadPictureResult uploadPictureResult = new UploadPictureResult();  \n        int picWidth = imageInfo.getWidth();  \n        int picHeight = imageInfo.getHeight();  \n        double picScale = NumberUtil.round(picWidth * 1.0 / picHeight, 2).doubleValue();  \n        uploadPictureResult.setPicName(FileUtil.mainName(originFilename));  \n        uploadPictureResult.setPicWidth(picWidth);  \n        uploadPictureResult.setPicHeight(picHeight);  \n        uploadPictureResult.setPicScale(picScale);  \n        uploadPictureResult.setPicFormat(imageInfo.getFormat());  \n        uploadPictureResult.setPicSize(FileUtil.size(file));  \n        uploadPictureResult.setUrl(cosClientConfig.getHost() + \"/\" + uploadPath);  \n        return uploadPictureResult;  \n    }  \n  \n    /**  \n     * 删除临时文件  \n     */  \n    public void deleteTempFile(File file) {  \n        if (file == null) {  \n            return;  \n        }  \n        boolean deleteResult = file.delete();  \n        if (!deleteResult) {  \n            log.error(\"file delete error, filepath = {}\", file.getAbsolutePath());  \n        }  \n    }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"KOKtdW0pboFLyyxcd2xcfzPanxc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"上述代码中，我们把每个步骤都封装为了一个单独的方法，公共的实现（比如deleteTempFile）可以直接放到模板中，而不用放到具体的实现类中。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZGfcdaI8ro6IgvxCCFYcLl0pn4b","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"注意，为了让模板同时兼容MultiPartFile和String类型的文件参数，直接将这两种情况统一为Object类型的inputSource 输入源。","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Shnod7GiroOeM0xkiicctGhgnid","block_type":13,"ordered":{"elements":[{"text_run":{"content":"新建本地图片上传子类FilePictureUpload，继承模板，并且打上@Service注解生成 Bean实例:","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"GPt3dsI9Too4w8xPHfCcmbclnNc","block_type":14,"code":{"elements":[{"text_run":{"content":"@Service  \npublic class FilePictureUpload extends PictureUploadTemplate {  \n  \n    @Override  \n    protected void validPicture(Object inputSource) {  \n        MultipartFile multipartFile = (MultipartFile) inputSource;  \n        ThrowUtils.throwIf(multipartFile == null, ErrorCode.PARAMS_ERROR, \"文件不能为空\");  \n        // 1. 校验文件大小  \n        long fileSize = multipartFile.getSize();  \n        final long ONE_M = 1024 * 1024L;  \n        ThrowUtils.throwIf(fileSize > 2 * ONE_M, ErrorCode.PARAMS_ERROR, \"文件大小不能超过 2M\");  \n        // 2. 校验文件后缀  \n        String fileSuffix = FileUtil.getSuffix(multipartFile.getOriginalFilename());  \n        // 允许上传的文件后缀  \n        final List<String> ALLOW_FORMAT_LIST = Arrays.asList(\"jpeg\", \"jpg\", \"png\", \"webp\");  \n        ThrowUtils.throwIf(!ALLOW_FORMAT_LIST.contains(fileSuffix), ErrorCode.PARAMS_ERROR, \"文件类型错误\");  \n    }  \n  \n    @Override  \n    protected String getOriginFilename(Object inputSource) {  \n        MultipartFile multipartFile = (MultipartFile) inputSource;  \n        return multipartFile.getOriginalFilename();  \n    }  \n  \n    @Override  \n    protected void processFile(Object inputSource, File file) throws Exception {  \n        MultipartFile multipartFile = (MultipartFile) inputSource;  \n        multipartFile.transferTo(file);  \n    }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"FlbrdvGvzonTfxxWMlucJbt9nMc","block_type":13,"ordered":{"elements":[{"text_run":{"content":"新建URL图片上传子类UrIPictureUpload，继承模板，并且打上@Service注解生成Bean实例:","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"HCt8dSD2yobGWOxRDuTcNnJ9nCb","block_type":14,"code":{"elements":[{"text_run":{"content":"@Service  \npublic class UrlPictureUpload extends PictureUploadTemplate {  \n    @Override  \n    protected void validPicture(Object inputSource) {  \n        String fileUrl = (String) inputSource;  \n        ThrowUtils.throwIf(StrUtil.isBlank(fileUrl), ErrorCode.PARAMS_ERROR, \"文件地址不能为空\");  \n        // ... 跟之前的校验逻辑保持一致  \n    }  \n  \n    @Override  \n    protected String getOriginFilename(Object inputSource) {  \n        String fileUrl = (String) inputSource;  \n        // 从 URL 中提取文件名  \n        return FileUtil.mainName(fileUrl);  \n    }  \n  \n    @Override  \n    protected void processFile(Object inputSource, File file) throws Exception {  \n        String fileUrl = (String) inputSource;  \n        // 下载文件到临时目录  \n        HttpUtil.downloadFile(fileUrl, file);  \n    }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Tc6ZdxwG5oNoAcxpw03ctJuZnH3","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"优化完后，可以还原FileManager文件，并添加@Deprecated注解表示已废弃，后续将直接使用文件上传模板类PictureUploadTemplate。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ANhcdNct1o3VtSx38VQc4xkjn2b","block_type":5,"heading3":{"elements":[{"text_run":{"content":"图片上传服务支持URL上传","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"EWy7dohJCoGf4sxJaaWcAJjqndb","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"由于图片上传的逻辑还是比较复杂的，尽量让URL上传复用之前的代码。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"A0scd5zdtoxPsSxeFbbcCtCwnWd","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"但是之前图片上传服务的uploadPicture方法接受的是文件类型的参数，现在要支持URL上传，怎么办呢？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"CEVSdAGUpocEnJxOjbwcpdZynFh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"可以将输入参数跟上述模板一样，改为Object类型的inputSource，然后在代码中可以根据inputSource的实际类型，来选择对应的图片上传子类。代码如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Hoe1dInXyomAyqx70p3czDDSnWf","block_type":14,"code":{"elements":[{"text_run":{"content":"@Resource  \nprivate FilePictureUpload filePictureUpload;  \n  \n@Resource  \nprivate UrlPictureUpload urlPictureUpload;  \n  \n// 上传图片  \npublic PictureVO uploadPicture(Object inputSource, PictureUploadRequest pictureUploadRequest, User loginUser) {  \n    if (inputSource == null) {  \n        throw new BusinessException(ErrorCode.PARAMS_ERROR, \"图片为空\");  \n    }  \n    // ...  \n    // 按照用户 id 划分目录  \n    String uploadPathPrefix = String.format(\"public/%s\", loginUser.getId());  \n    // 根据 inputSource 类型区分上传方式  \n    PictureUploadTemplate pictureUploadTemplate = filePictureUpload;  \n    if (inputSource instanceof String) {  \n        pictureUploadTemplate = urlPictureUpload;  \n    }  \n    UploadPictureResult uploadPictureResult = pictureUploadTemplate.uploadPicture(inputSource, uploadPathPrefix);  \n    // 构造要入库的图片信息  \n    // ...  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"I1wfdPkJ7oXg1Yxeehuc1zOxnzh","block_type":5,"heading3":{"elements":[{"text_run":{"content":"接口开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"EghEdV0OIoB2isxylGNc1fiAnhg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"在请求封装类 PictureUploadRequest 中新增 fileUrl 文件地址：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"NoX4de39wo843wxHk9PcpBmRnNe","block_type":14,"code":{"elements":[{"text_run":{"content":"@Data  \npublic class PictureUploadRequest implements Serializable {  \n  \n    /**  \n     * 图片 id（用于修改）  \n     */  \n    private Long id;  \n  \n    /**  \n     * 文件地址  \n     */  \n    private String fileUrl;  \n  \n    private static final long serialVersionUID = 1L;  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"KFpqdT4ymoLizLxHxh3cem4hnZc","block_type":13,"ordered":{"elements":[{"text_run":{"content":"在PictureController中新增接口通过Url上传图片","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"JFsEdUqUwoiKx3xkkoGcACLcnWd","block_type":14,"code":{"elements":[{"text_run":{"content":"/**  \n * 通过 URL 上传图片（可重新上传）  \n */  \n@PostMapping(\"/upload/url\")  \npublic BaseResponse<PictureVO> uploadPictureByUrl(  \n        @RequestBody PictureUploadRequest pictureUploadRequest,  \n        HttpServletRequest request) {  \n    User loginUser = userService.getLoginUser(request);  \n    String fileUrl = pictureUploadRequest.getFileUrl();  \n    PictureVO pictureVO = pictureService.uploadPicture(fileUrl, pictureUploadRequest, loginUser);  \n    return ResultUtils.success(pictureVO);  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"QmTrdvTAxoSlLcxhl5Pcignsnjb","block_type":4,"heading2":{"elements":[{"text_run":{"content":"前端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"T7G2d2fhsoz3jRxGLotcbOvPnbh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"和本地上传图片的开发流程一样，我们先来开发一个URL上传图片的组件，绝大多数代码都可以复用本地上传图片组件。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"FcJMdPUWyoW5O5xgygscMB1tnRh","block_type":5,"heading3":{"elements":[{"text_run":{"content":"URL上传组件","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"GJJndyvDhoTHPGxJ9bdccwWGnHo","block_type":34,"children":["K6l8dD0eGoTF94xe4bqczdwOnpe"],"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","quote_container":{}},{"block_id":"K6l8dD0eGoTF94xe4bqczdwOnpe","block_type":2,"parent_id":"GJJndyvDhoTHPGxJ9bdccwWGnHo","text":{"elements":[{"text_run":{"content":"URL上传组件＝文本输入框+提交按钮","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"JkbDdUyVEoEUpExRoXZcphExnfh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"可以使用组件库的","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"复合输入框","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fantdv.com%2Fcomponents%2Finput-cn%23components-input-demo-group"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"组件：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"AjPMdXoSZoDJGJxllt1cRriInYf","block_type":14,"code":{"elements":[{"text_run":{"content":"<div class=\"url-picture-upload\">  \n  <a-input-group compact style=\"margin-bottom: 16px\">  \n    <a-input v-model:value=\"fileUrl\" style=\"width: calc(100% - 120px)\" placeholder=\"请输入图片 URL\" />  \n    <a-button type=\"primary\" :loading=\"loading\" @click=\"handleUpload\" style=\"width: 120px\">提交</a-button>  \n  </a-input-group>  \n  <img v-if=\"picture?.url\" :src=\"picture?.url\" alt=\"avatar\" />  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</div>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VXqbd8BLroaUkLxo5TEcKtdznv7","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"开发上传操作函数","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"S1XVdHX3woYBMOxaABDclu5inrg","block_type":14,"code":{"elements":[{"text_run":{"content":"const loading = ref<boolean>(false)  \nconst fileUrl = ref<string>()  \n  \n/**  \n * 上传  \n */  \nconst handleUpload = async () => {  \n  loading.value = true  \n  try {  \n    const params: API.PictureUploadRequest = { fileUrl: fileUrl.value }  \n    if (props.picture) {  \n      params.id = props.picture.id  \n    }  \n    const res = await uploadPictureByUrlUsingPost(params)  \n    if (res.data.code === 0 && res.data.data) {  \n      message.success('图片上传成功')  \n      // 将上传成功的图片信息传递给父组件  \n      props.onSuccess?.(res.data.data)  \n    } else {  \n      message.error('图片上传失败，' + res.data.message)  \n    }  \n  } catch (error) {  \n    message.error('图片上传失败')  \n  } finally {  \n    loading.value = false  \n  }  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"KPKzdgWKNowzoJxN651cCr8jnXO","block_type":5,"heading3":{"elements":[{"text_run":{"content":"开发创建页面","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"HHEVd0RCjoKdarxsAFscHp9knZb","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"之前已经开发了创建图片页面，可以在上传图片时增加一个Tabs选项组件，让用户自己选择上传方式。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"VxZ8dQXIkoan6mxgqz1c6fDJnid","block_type":14,"code":{"elements":[{"text_run":{"content":"<!-- 选择上传方式 -->  \n<a-tabs v-model:activeKey=\"uploadType\"  \n  >>  \n  <a-tab-pane key=\"file\" tab=\"文件上传\">  \n    <PictureUpload :picture=\"picture\" :onSuccess=\"onSuccess\" />  \n  </a-tab-pane>  \n  <a-tab-pane key=\"url\" tab=\"URL 上传\" force-render>  \n    <UrlPictureUpload :picture=\"picture\" :onSuccess=\"onSuccess\" />  \n  </a-tab-pane>  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</a-tabs>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"ARBtdPKwAoWyH0x87dqcxjBInNb","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"定义上传类型变量","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"EvQqdrYfmo28hQxqbVMcbJfbned","block_type":14,"code":{"elements":[{"text_run":{"content":"const uploadType = ref<'file' | 'url'>('file')","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"QKSidtVG8o0wGsxtKrAciMNNn3d","block_type":22,"divider":{},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"MxVddMqhfoJEnjxyzN1cFkZRnHh","block_type":3,"heading1":{"elements":[{"text_run":{"content":"批量抓取和创建图片","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"DDJKdYGefon06kxdxwucGE4unve","block_type":4,"heading2":{"elements":[{"text_run":{"content":"需求分析","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"YW4Pd8w2jofvZfxnnMicVB7wnrF","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"为了帮助管理员快速丰富图片库，冷启动项目，需要提供批量从网络抓取并创建图片的功能。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"LDUsd2m9XozEd1xbVTxcql0Fnyg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"但是要注意，不建议将该功能开放给普通用户！","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 主要是为了防止滥用导致的版权问题、低质量内容的上传、服务器资源消耗和安全问题。因为我们要从网络批量抓取图片（爬虫），如果功能开放给用户，相当于所有用户都在使用我们的服务器作为爬虫源头，容易导致我们的服务器IP被封禁。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"H9XOdKyNkotfBCxYCx5cjIJUnyg","block_type":5,"heading3":{"elements":[{"text_run":{"content":"方案设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"NzoCdj1zsoiTomxvev2clR81nge","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"方案设计的重点包括：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"OWcldC3ReopXGIxhpApcUvumntc","block_type":12,"bullet":{"elements":[{"text_run":{"content":"如何抓取图片","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"DyaUdrnaJot7M9x87W1cwZF0nRd","block_type":12,"bullet":{"elements":[{"text_run":{"content":"抓取和导入规则","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Wo6WdmTxsovWOHxmsDIc1DTSnWb","block_type":5,"heading3":{"elements":[{"text_run":{"content":"如何抓取图片？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Y8WLdiUSVoH1uXx0J0UczvrRnTe","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"思考2个问题：从哪里抓取图片？怎么抓取图片呢？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"AOTMdoy3aoGiyBxfwfVcGaHQn5f","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"绝大多数的图片素材网站，都是有版权保护的，不建议大家操作，容易被封禁IP和账号。比较安全的方法是从搜索引擎中抓取图片，仅学习使用、不商用的话基本不会有什么风险。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"XwQBdl354oJUKLx9ww3ccJytn85","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"这里我们选择从bing搜索获取图片，首先进入","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"bing图片","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcn.bing.com%2Fimages%2Fsearch%3Fq%3D%25e4%25b8%2596%25e7%2595%258c%25e6%2597%2585%25e6%25b8%25b8%25e8%2583%259c%25e5%259c%25b0%26form%3DHDRSC2%26first%3D1"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"网站，可以看到很多图片，但是如何获取这些图片呢？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"VIpGdHVCgodZYPx0X0wcJscdn3f","block_type":27,"image":{"align":2,"height":847,"token":"AuhrbpFczo4a9mxLTIFcHxZznBf","width":1893},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VHPHd7XZjoB2qxxC3E0cRfJunNg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"有2种常见的做法","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Dq7AdsaKloDxMtxRDpicarArnid","block_type":13,"ordered":{"elements":[{"text_run":{"content":"请求到完整的页面内容后，对页面的HTML结构进行解析，提取到图片的地址，再通过URL下载；","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VlHrdAJKOokCMyxOuJXc2pLhn9c","block_type":13,"ordered":{"elements":[{"text_run":{"content":"直接调用后端获取图片地址的接口拿到图片数据。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"IbBPdUmj1oNoaIxcYzLc16GOn8c","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"要使用哪种方式，还是要具体情况具体分析，比如在调研过程中，我们会发现直接从bing图片的首页抓取数据，可能会出现获取不到图片的情况。所以我们换一种策略，尝试去找图片接口。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Iu56dr3wYo2KJdxwMXucJrVUnCc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"按F12打开网络请求控制台，向下滚动图片时会触发新一波图片的加载，就能看到获取图片数据的接口了：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"YPjcd4Bi9oZbLKxFO0GcBkKFnkC","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"https://cn.bing.com/images/async?q=%25s&mmasync=1","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"JYoldoEPuoN3zzxYLNtc7Mn6ndh","block_type":27,"image":{"align":2,"height":766,"token":"K0EtbhkFmoW7YaxgTkpc3bX8nLb","width":1915},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"ZF6IdXL3HoUVwcx1nWsc4Dgjn8f","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"但是该接口返回的还是HTML文档结构，所以我们需要使用一个HTML文档解析库来提取图片地址，Java中比较推荐jsoup，非常地轻量。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Nqa1dKUnio2E3sxxDO9cuQP2nAg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"jsoup支持使用跟前端一致的选择器语法来定位HTML的元素，比如类选择器、CSS选择器。我们可以先通过类选择器找到最外层的元素dgControl，再通过CSS选择器img.mimg找到所有的图片元素：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QgeCdCH8soLAivxvaewcEW9fnif","block_type":27,"image":{"align":2,"height":785,"token":"WTOzb0OqmogOKhx9W8xctD78nxf","width":1910},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Dxnbd0L4koaHn7xPEwUcI6gznif","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"注意，图片的地址后面有很多附加参数，比如?w=199&h=180，在导入图片时一定要移除！否则会影响图片的质量，还有可能导致上传到对象存储的文件包含被转义的特殊字符，引发无法访问等问题。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"X4x6dtkqwoNIBNxCIHNc5WgunCb","block_type":5,"heading3":{"elements":[{"text_run":{"content":"抓取和导入规则","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"S0HCdHhLmoonyWxNLQKcgZydnwb","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"可以在抓取时，让管理员填写以下参数：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"AH1xdQMtSoDgksxnXpGccC9XnXg","block_type":12,"bullet":{"elements":[{"text_run":{"content":"搜索关键词：便于找到需要的数据","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"MPPad2wjJoFbo0xJnWIcISoXn3e","block_type":12,"bullet":{"elements":[{"text_run":{"content":"抓取数量：单次要抓取的条数，不建议超过30条（接口单次返回的图片有限）","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Wh6sdnv6JojA0JxfihwcKQxdnRh","block_type":4,"heading2":{"elements":[{"text_run":{"content":"后端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"OGCXdFbmHoOsZ0xMOVWcxV7nnOf","block_type":5,"heading3":{"elements":[{"text_run":{"content":"定义请求体","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VGbHdauZDoyo7OxYBt4c2tzdnXe","block_type":14,"code":{"elements":[{"text_run":{"content":"@Data  \npublic class PictureUploadByBatchRequest {  \n  \n    /**  \n     * 搜索词  \n     */  \n    private String searchText;  \n  \n    /**  \n     * 抓取数量  \n     */  \n    private Integer count = 10;  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Ern8dcwlaouproxnAHZcI8Opnt0","block_type":5,"heading3":{"elements":[{"text_run":{"content":"开发服务","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"FeN9dj1nuo9xq0xqNNbcgCKBnGP","block_type":13,"ordered":{"elements":[{"text_run":{"content":"引入Jsoup库","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"KLRLdK2nooiyFixZMUYcP3IInEh","block_type":14,"code":{"elements":[{"text_run":{"content":"<!-- HTML 解析：https://jsoup.org/ -->  \n<dependency>  \n    <groupId>org.jsoup</groupId>  \n    <artifactId>jsoup</artifactId>  \n    <version>1.15.3</version>  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</dependency>=","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"TFs0d5TwqoxEtKxAZoKc6nocnmc","block_type":13,"ordered":{"elements":[{"text_run":{"content":"编写批量抓取和创建图片的方法","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Ufysdj7YEo8rJbx2vWJcXtzynkd","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"接口","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"XcJrd70h8oaOoIxvIn7ck3tbnzc","block_type":14,"code":{"elements":[{"text_run":{"content":"/**  \n * 批量抓取和创建图片  \n *  \n * @param pictureUploadByBatchRequest  \n * @param loginUser  \n * @return 成功创建的图片数  \n */  \nInteger uploadPictureByBatch(  \n    PictureUploadByBatchRequest pictureUploadByBatchRequest,  \n    User loginUser  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":");","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"X56hdkLIho4AlHxK2u4cjQv7nsd","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"实现类","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IbWJdQwipoJnPdxdXaPcGpZ0nmc","block_type":14,"code":{"elements":[{"text_run":{"content":"@Override  \npublic int uploadPictureByBatch(PictureUploadByBatchRequest pictureUploadByBatchRequest, User loginUser) {  \n    String searchText = pictureUploadByBatchRequest.getSearchText();  \n    // 格式化数量  \n    Integer count = pictureUploadByBatchRequest.getCount();  \n    ThrowUtils.throwIf(count > 30, ErrorCode.PARAMS_ERROR, \"最多 30 条\");  \n    // 要抓取的地址  \n    String fetchUrl = String.format(\"https://cn.bing.com/images/async?q=%s&mmasync=1\", searchText);  \n    Document document;  \n    try {  \n        document = Jsoup.connect(fetchUrl).get();  \n    } catch (IOException e) {  \n        log.error(\"获取页面失败\", e);  \n        throw new BusinessException(ErrorCode.OPERATION_ERROR, \"获取页面失败\");  \n    }  \n    Element div = document.getElementsByClass(\"dgControl\").first();  \n    if (ObjUtil.isNull(div)) {  \n        throw new BusinessException(ErrorCode.OPERATION_ERROR, \"获取元素失败\");  \n    }  \n    Elements imgElementList = div.select(\"img.mimg\");  \n    int uploadCount = 0;  \n    for (Element imgElement : imgElementList) {  \n        String fileUrl = imgElement.attr(\"src\");  \n        if (StrUtil.isBlank(fileUrl)) {  \n            log.info(\"当前链接为空，已跳过: {}\", fileUrl);  \n            continue;  \n        }  \n        // 处理图片上传地址，防止出现转义问题  \n        int questionMarkIndex = fileUrl.indexOf(\"?\");  \n        if (questionMarkIndex > -1) {  \n            fileUrl = fileUrl.substring(0, questionMarkIndex);  \n        }  \n        // 上传图片  \n        PictureUploadRequest pictureUploadRequest = new PictureUploadRequest();  \n        try {  \n            PictureVO pictureVO = this.uploadPicture(fileUrl, pictureUploadRequest, loginUser);  \n            log.info(\"图片上传成功, id = {}\", pictureVO.getId());  \n            uploadCount++;  \n        } catch (Exception e) {  \n            log.error(\"图片上传失败\", e);  \n            continue;  \n        }  \n        if (uploadCount >= count) {  \n            break;  \n        }  \n    }  \n    return uploadCount;  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"KUbVdDgeuoZCf6xtNS5czkgBnTg","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"上述代码中，我们添加了很多日志记录和异常处理逻辑，使得单张图片抓取或导入失败时任务还能够继续执行，最终返回创建成功的图片数。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QuUWdAhXrolIM2xIeV4cUgZwnLg","block_type":5,"heading3":{"elements":[{"text_run":{"content":"开发接口","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"VeRpdheJYoKKWoxTkTacDsLAn6d","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"在PictureController中开发接口，注意管理员权限","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"W18edibkooXagRxrnuZcIjKwnHc","block_type":14,"code":{"elements":[{"text_run":{"content":"@PostMapping(\"/upload/batch\")  \n@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  \npublic BaseResponse<Integer> uploadPictureByBatch(  \n        @RequestBody PictureUploadByBatchRequest pictureUploadByBatchRequest,  \n        HttpServletRequest request  \n) {  \n    ThrowUtils.throwIf(pictureUploadByBatchRequest == null, ErrorCode.PARAMS_ERROR);  \n    User loginUser = userService.getLoginUser(request);  \n    int uploadCount = pictureService.uploadPictureByBatch(pictureUploadByBatchRequest, loginUser);  \n    return ResultUtils.success(uploadCount);  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"MYigd6LqAotNpYx9q4Ycn4bsnpb","block_type":5,"heading3":{"elements":[{"text_run":{"content":"批量设置属性","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"LjzhddtrBoXKl0xoArYcPDcBnN2","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"之前我们导入系统的图片名称都是由对方的URL决定的，名称可能乱七八糟，而且不利于我们得知数据是在那一批被导入的。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"P56xdVaoqoRMDxxe12ScnxlQn6d","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"因此我们可以让管理员在执行任务前指定名称前缀，即导入到系统中的图片名称。比如前缀为“耄耋”，得到的图片名称就是“耄耋1”、“耄耋2”。。。相当于支持抓取和创建图片时批量对某批图片命名，名称前缀默认等于搜索关键词。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"EsYmdqwtCo5pSVxdRUKca64Rn1d","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"下面来开发实现：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Y72YdSklqoHYQRx7uE4cZ3HKndd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"给 PictureUploadByBatchRequest 请求包装类补充 namePrefix 参数:","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"HIt0dFcfOoN5vnxcMrjcsAmsn1b","block_type":14,"code":{"elements":[{"text_run":{"content":"/**  \n * 名称前缀  \n */  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"private String namePrefix;","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"PGSLd6kRPor3hdxh6afcUbbynSe","block_type":13,"ordered":{"elements":[{"text_run":{"content":"由于图片名称是在uploadPicture方法中传入并设置给Picture图片对象的，所以需要给该方法接受的参数PictureUploadRequest 类中补充 picName 参数:","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Cp6zdMiKfoWAEgxV9jUcHrHMnwe","block_type":14,"code":{"elements":[{"text_run":{"content":"/**  \n * 图片名称  \n */  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"private String picName;","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"UfJNdYGlbov7C2xCy7AciXSxnJh","block_type":13,"ordered":{"elements":[{"text_run":{"content":"修改uploadPicture服务方法，在构造入库图片信息时，可以通过pictureUploadRequest 对象获取到要手动设置的图片名称，而不是完全依赖于解析的结果：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"XAQcdZjvroNpG3xOu9icR2CanLh","block_type":14,"code":{"elements":[{"text_run":{"content":"// 构造要入库的图片信息  \nPicture picture = new Picture();  \npicture.setUrl(uploadPictureResult.getUrl());  \nString picName = uploadPictureResult.getPicName();  \nif (pictureUploadRequest != null && StrUtil.isNotBlank(pictureUploadRequest.getPicName())) {  \n    picName = pictureUploadRequest.getPicName();  \n}  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"picture.setName(picName);","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"XRHidHfICoVN7Nxt7Hvc1hJennf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"修改批量抓取和导入图片的服务方法uploadPictureByBatch，补充图片名称生成逻辑：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"GRkidEJ53oVpzLxwwPJcGTNinAb","block_type":14,"code":{"elements":[{"text_run":{"content":"String namePrefix = pictureUploadByBatchRequest.getNamePrefix();  \nif (StrUtil.isBlank(namePrefix)) {  \n    namePrefix = searchText;  \n}  \n// ...  \n// 上传图片  \nPictureUploadRequest pictureUploadRequest = new PictureUploadRequest();  \nif (StrUtil.isNotBlank(namePrefix)) {  \n    // 设置图片名称，序号连续递增  \n    pictureUploadRequest.setPicName(namePrefix + (uploadCount + 1));  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"YhVmdS6Y0oVHKLx09cEcfrpvnRe","block_type":5,"heading3":{"elements":[{"text_run":{"content":"接口测试","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"AL7EdNRQto1xOixGEIccWCZjnbb","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"使用Swagger测试接口，效果如图：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"NES3dhduHoQMrzxTg8fcIY0Lnic","block_type":27,"image":{"align":2,"height":837,"token":"Vlp1b2NojoMo1axbwTucMQyBnfb","width":1916},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"QSnSdvwfFoSawVxdMzicokCInnh","block_type":4,"heading2":{"elements":[{"text_run":{"content":"前端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"ZJqfde4hjo2zCexRjEZcOoOSnRd","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"可以新建一个批量创建图片页面，并且在图片管理页面补充跳转到该页面的按钮。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"XVTEdGXb8oqKlexsrRkcasTqnGb","block_type":5,"heading3":{"elements":[{"text_run":{"content":"图片管理页面补充按钮","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Ynqsd7ZV5o09DYxfLDxceidVnzh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"管理页面补充“批量创建图片”按钮，代码如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"H6yGdH6HMo3ucpxxLwMcijnDntd","block_type":14,"code":{"elements":[{"text_run":{"content":"<a-space>  \n  <a-button type=\"primary\" href=\"/add_picture\" target=\"_blank\">+ 创建图片</a-button>  \n  <a-button type=\"primary\" href=\"/add_picture/batch\" target=\"_blank\" ghost>+ 批量创建图片</a-button>  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</a-space>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"OxLHdfnRMo8YsyxnaXrcZoUnnkb","block_type":27,"image":{"align":2,"height":76,"token":"FXw0bSqWsoLuwXxjGyBcPFJFnJb","width":1896},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"WuJEd1cc3oifHmxMsyBcRGYZn8c","block_type":5,"heading3":{"elements":[{"text_run":{"content":"批量创建图片页面","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"RmL6dqMa0oa3hYxln6tc3e51nNd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"新建页面文件AddPictureBatchPage.vue（复制创建图片页面），并添加路由：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"YWtAdXHkcoMC1NxbivjcJsUKnGd","block_type":14,"code":{"elements":[{"text_run":{"content":"{  \n  path: '/add_picture/batch',  \n  name: '批量创建图片',  \n  component: AddPictureBatchPage,  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"L0TndpxEQo0B9Hxd24Cc5ZJXnjb","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"正常情况下，普通用户是看不见该页面的，即使看见了，也会因为后端的限制无法使用。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"OonYdVQLkolL9Fxv1Fbciss1nFf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"该页面主体是一个表单，和创建图片页面极为相似，先修改表单项：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"PrGCd76l9oqGxcxKeoDcQyZsnSe","block_type":14,"code":{"elements":[{"text_run":{"content":"<div id=\"addPictureBatchPage\">  \n  <h2 style=\"margin-bottom: 16px\">批量创建图片</h2>  \n  <a-form layout=\"vertical\" :model=\"formData\" @finish=\"handleSubmit\">  \n    <a-form-item label=\"关键词\" name=\"searchText\">  \n      <a-input v-model:value=\"formData.searchText\" placeholder=\"请输入关键词\" />  \n    </a-form-item>  \n    <a-form-item label=\"抓取数量\" name=\"count\">  \n      <a-input-number  \n        v-model:value=\"formData.count\"  \n        placeholder=\"请输入数量\"  \n        style=\"min-width: 180px\"  \n        :min=\"1\"  \n        :max=\"30\"  \n        allow-clear  \n      />  \n    </a-form-item>  \n    <a-form-item label=\"名称前缀\" name=\"namePrefix\">  \n      <a-input v-model:value=\"formData.namePrefix\" placeholder=\"请输入名称前缀，会自动补充序号\" />  \n    </a-form-item>  \n    <a-form-item>  \n      <a-button type=\"primary\" html-type=\"submit\" style=\"width: 100%\" :loading=\"loading\">  \n        执行任务  \n      </a-button>  \n    </a-form-item>  \n  </a-form>  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</div>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"TNBtdrlkfo2zWvxxyu1cK8RqnFh","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"注意，由于批量抓取任务是同步的，可能比较慢，所以需要添加loading效果，防止点击过快重复执行。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"BoYHdo8aiovjbYx4Vtlc18UZny2","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"定义表单项结构和 loading变量：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"PxUxdTwZgokSX2xWJV3cdAnEnzd","block_type":14,"code":{"elements":[{"text_run":{"content":"const formData = reactive<API.PictureUploadByBatchRequest>({  \n  count: 10,  \n})  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"const loading = ref(false)","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"FPWjdIptMouJ7Zxr6tQczPrwnPf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"编写提交函数","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"UQWnd6ePdo5Gu4xvOvvcuYkpnP2","block_type":14,"code":{"elements":[{"text_run":{"content":"const handleSubmit = async (values: any) => {  \n  loading.value = true;  \n  const res = await uploadPictureByBatchUsingPost({  \n    ...formData,  \n  })  \n  if (res.data.code === 0 && res.data.data) {  \n    message.success(`创建成功，共 ${res.data.data} 条`)  \n    router.push({  \n      path: '/',  \n    })  \n  } else {  \n    message.error('创建失败，' + res.data.message)  \n  }  \n  loading.value = false;  \n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"CRREdjVTBoEjhvxQMdpcRKyNnTN","block_type":22,"divider":{},"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b"},{"block_id":"Mqfyd5Of0oEdxLxBrtycPY0enqc","block_type":2,"parent_id":"WMAhdRmzMomDTTxkJBjcFpu5n0b","text":{"elements":[{"text_run":{"content":"","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}}],"type":"docx"}