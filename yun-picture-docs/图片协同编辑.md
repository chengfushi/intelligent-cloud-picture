# å›¾ç‰‡ååŒç¼–è¾‘

ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²Øœç»å®Œæˆäº†å›¢é˜Ÿç©ºé—´çš„åˆ›å»ºã€æˆå‘˜ç®¡ç†å’Œæƒé™æ§åˆ¶ç­‰åŠŸèƒ½ã€‚ä¸ºäº†æé«˜é¡¹ç›®çš„å•†ä¸šä»·å€¼ï¼Œæœ¬èŠ‚æ¥å®Œæˆæœ¬é¡¹ç›®çš„äº®ç‚¹åŠŸèƒ½ â€”â€” å›¾ç‰‡ååŒç¼–è¾‘ã€‚

å¤§çº²ï¼š

* å›¾ç‰‡ååŒç¼–è¾‘éœ€æ±‚åˆ†æ
* å›¾ç‰‡ååŒç¼–è¾‘æ–¹æ¡ˆè®¾è®¡
* å›¾ç‰‡ååŒç¼–è¾‘åç«¯å¼€å‘
* å›¾ç‰‡ååŒç¼–è¾‘å‰ç«¯å¼€å‘

é€šè¿‡æœ¬èŠ‚ï¼Œä½ å°†å­¦Øœä¹ åˆ°å¤šäººå®æ—¶åä½œåŠŸèƒ½çš„è®¾è®¡å¼€å‘ï¼Œæ¶‰åŠ WebSocketã€äº‹ä»¶é©±åŠ¨è®¾è®¡ã€Disruptor æ— é”é˜Ÿåˆ—ç­‰æŠ€æœ¯çŸ¥è¯†ã€‚å­¦ä¼šåå†å»å¼€å‘èŠå¤©å®¤ä¹‹ç±»çš„ä¸šåŠ¡ï¼Œéƒ½ä¼šè½»æ¾å¾ˆå¤šã€‚

# éœ€æ±‚åˆ†æ

ç°åœ¨å¾ˆå¤šäº§Øœå“éƒ½æœ‰å¤šäººåä½œåŠŸèƒ½ï¼Œæ¯”å¦‚ååŒæ–‡æ¡£ã€ååŒç´ æè®¾è®¡ã€ååŒä»£ç ç¼–è¾‘å™¨ç­‰ç­‰ï¼Œå¯ä»¥æé«˜åä½œçš„æ•ˆç‡ã€‚

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œæ‰€è°“çš„å›¾ç‰‡ååŒç¼–è¾‘åŠŸèƒ½ï¼Œæ˜¯åœ¨å›¾ç‰‡ç¼–è¾‘çš„åŸºç¡€ä¸Šå¢åŠ äº† â€œååŒâ€ çš„æ¦‚å¿µã€‚å½“ç”¨æˆ·ç¼–è¾‘æŸå¼ å›¾ç‰‡æ—¶ï¼Œå…¶ä»–ç”¨æˆ·å¯ä»¥ å®æ—¶ çœ‹åˆ°ç¼–è¾‘æ•ˆæœå’Œæ“ä½œæç¤ºã€‚å¦‚å›¾ï¼š

![](assets/HZRobpOkkoJZOpxaW83cF1a3n4v.png)

æ³¨æ„ï¼Œå› ä¸ºåªæœ‰Øœå›¢é˜Ÿç©ºé—´æ‰ä¼šæœ‰å¤šä¸ªç”¨æˆ·ç¼–è¾‘åŒä¸€å¼ å›¾ç‰‡ï¼Œæ‰€ä»¥è¯¥åŠŸèƒ½åªå¯¹å›¢é˜Ÿç©ºé—´å¼€æ”¾ï¼Œéœ€è¦æˆå‘˜å…·æœ‰ç¼–è¾‘æƒé™ã€‚ååŒçš„å›¾ç‰‡ç¼–è¾‘æ“ä½œåŒ…æ‹¬å·¦æ—‹ã€å³æ—‹ã€æ”¾å¤§ã€ç¼©å°ã€‚

---

# æ–¹æ¡ˆè®¾è®¡

è™½ç„¶éœ€æ±‚ä»‹Øœç»å¾ˆç®€å•ï¼Œä½†æ˜¯æ¶‰åŠåˆ°å¤šäººåä½œçš„ä¸šåŠ¡ï¼Œæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦è€ƒè™‘ï¼Œæ¯”å¦‚ï¼š

* å¤šä¸ªç”¨æˆ·ä¹‹é—´å¦‚ä½•è¿›è¡Œäº¤äº’ï¼Ÿ
* å¦‚ä½•é˜²æ­¢åä½œç¼–è¾‘æ—¶å‡ºç°å†²çªï¼Ÿ
* å¦‚ä½•æé«˜åä½œçš„å®æ—¶æ€§ï¼Ÿ

## åä½œäº¤äº’æµç¨‹

å¤šäººåä½œæ—¶Øœï¼Œæ¯ä¸ªç”¨æˆ·çš„åŠ¨ä½œéƒ½éœ€è¦é€šçŸ¥åˆ°å…¶ä»–ç”¨æˆ·ï¼Œæ”¶åˆ°é€šçŸ¥æ¶ˆæ¯çš„ç”¨æˆ·éœ€è¦è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

æ¯”å¦‚ç”¨æˆ· AØœ æ”¾å¤§äº†å›¾ç‰‡ï¼Œå°±éœ€è¦ç»™å…¶ä»–æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·å‘é€ â€œå›¾ç‰‡æ”¾å¤§â€ æ¶ˆæ¯ï¼Œå…¶ä»–ç”¨æˆ·æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯åï¼Œéœ€è¦åŒæ­¥æ”¾å¤§è‡ªå·±ç•Œé¢ä¸Šçš„å›¾ç‰‡ã€‚

è¿™å…¶å®æ˜¯ä¸€ç§ äº‹ä»¶é©±åŠ¨ çš„æ¶æ„è®¾è®¡æ€æƒ³ï¼Œåä½œç¼–è¾‘ä¸­çš„æ¯ä¸ªç”¨æˆ·åŠ¨ä½œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª äº‹ä»¶ï¼Œæ‰§è¡ŒåŠ¨ä½œæ—¶ä¼šäº§ç”Ÿäº‹ä»¶å¹¶æäº¤ç»™æœåŠ¡å™¨ï¼›æœåŠ¡å™¨æ”¶åˆ°äº‹ä»¶åï¼Œä¼šè½¬å‘ç»™å…¶ä»–ç”¨æˆ·ï¼›å…¶ä»–ç”¨æˆ·æ”¶åˆ°äº‹ä»¶åï¼Œå°±è¦ä½œä¸ºäº‹ä»¶çš„æ¶ˆè´¹è€…æ¥å¤„ç†äº‹ä»¶ã€‚æµç¨‹å¦‚å›¾ï¼š

![](assets/FbeqbmTBto4XRpx8LOzcgrNZnhb.png)

ç›¸æ¯”äºç”Ÿäº§è€…ç›´æ¥è°ƒç”¨æ¶ˆè´¹è€…ï¼Œäº‹ä»¶é©±åŠ¨æ¨¡å‹çš„ä¸»è¦ä¼˜ç‚¹åœ¨äº è§£è€¦ å’Œ å¼‚æ­¥æ€§ã€‚åœ¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ä¸­ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸éœ€è¦ç›´æ¥ä¾èµ–äºå½¼æ­¤çš„å®ç°ï¼Œç”Ÿäº§è€…åªéœ€è§¦å‘äº‹ä»¶å¹¶å°†å…¶å‘é€åˆ°äº‹ä»¶åˆ†å‘å™¨ï¼Œæ¶ˆè´¹è€…åˆ™æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†é€»è¾‘ã€‚è¿™æ ·å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥ç‹¬ç«‹å“åº”åŒä¸€äº‹ä»¶ï¼ˆæ¯”å¦‚ä¸€ä¸ªç”¨æˆ·æ—‹è½¬äº†å›¾ç‰‡ï¼Œå…¶ä»–ç”¨æˆ·éƒ½èƒ½åŒæ­¥ï¼‰ï¼Œç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œå¯æ‰©å±•æ€§æ›´å¼ºã€‚æ­¤å¤–ï¼Œäº‹ä»¶é©±åŠ¨è¿˜å¯ä»¥æå‡ç³»ç»Ÿçš„ å¹¶å‘æ€§PVHq6NW9Nt5fXkQO/a1pmCEpMMQkmAtku92aHSjiX4c= å’Œ å®æ—¶æ€§ï¼Œå¯ä»¥ç†è§£ä¸ºå¤šå¼•å…¥äº†ä¸€ä¸ªä¸­ä»‹æ¥å¸®å¿™ï¼Œé€šè¿‡å¼‚æ­¥æ¶ˆæ¯ä¼ é€’ï¼Œå‡å°‘äº†é˜»å¡å’Œç­‰å¾…ï¼Œèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°å¤„ç†å¤šä¸ªå¹¶å‘ä»»åŠ¡ã€‚

ä¸‹é¢æˆ‘ä»¬æŒ‰ç…§äº‹ä»¶é©±åŠ¨çš„è®¾è®¡ï¼Œæ¥è¯¦ç»†åˆ—ä¸¾åä½œç¼–è¾‘çš„äº¤äº’æµç¨‹ï¼š

## è§£å†³åä½œå†²çª

### 1ã€è§£å†³æ–¹æ¡ˆ

å‡è®¾è¿™æ ·ä¸€Øœç§åœºæ™¯ï¼šå¼ ä¸‰å’Œæå››åŒæ—¶å¿«é€Ÿç‚¹å‡»äº†åæ¬¡æ—‹è½¬ï¼Œæœ€ç»ˆçš„ç»“æœä¼šæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

å¦‚æœæ‰€æœ‰äº‹ä»¶éƒ½æ˜¯æŒ‰é¡ºåºå¤„ç†çš„ï¼Œé‚£ç»“æœå°±å¾ˆæ¸…æ™°äº†ï¼Œä½†äº‹å®ä¸Šï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼Œäº‹ä»¶é€šå¸¸æ˜¯ å¹¶å‘ çš„ï¼Œè€Œä¸æ˜¯ä¸¥æ ¼çš„é¡ºåºæ‰§è¡Œã€‚è¿™ç§å¹¶å‘æ“ä½œä¼šå¼•å‘ åä½œå†²çªï¼Œå¯¼è‡´å…¶ä»–ç”¨æˆ·çœ‹åˆ°çš„æ—‹è½¬æ•ˆæœæ˜¯ä¹±åºçš„ã€‚

é‚£ä¹ˆä½ ä¼šæ€Øœä¹ˆè§£å†³åä½œå†²çªçš„é—®é¢˜å‘¢ï¼Ÿâ€‚â€‚â€‚â€‚â€‚â€‚â€Œâ€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚ï»¿â€‰â€‚â€‚â€‚â€‰â€‚â€‰â€‚â€‰â€â€‰â€‰â€‚â€‰â€‰â€‰â€‚â€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸šåŠ¡è®¾è®¡æ¥å‡å°‘å¼€å‘æˆæœ¬ï¼Œæ¯”å¦‚çº¦å®š åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä½ç”¨æˆ·è¿›å…¥ç¼–è¾‘å›¾ç‰‡çš„çŠ¶æ€ï¼Œæ­¤æ—¶å…¶ä»–ç”¨æˆ·åªèƒ½å®æ—¶æµè§ˆåˆ°ä¿®æ”¹æ•ˆæœï¼Œä½†ä¸èƒ½å‚ä¸ç¼–è¾‘ï¼›è¿›å…¥ç¼–è¾‘çŠ¶æ€çš„ç”¨æˆ·å¯ä»¥é€€å‡ºç¼–è¾‘ï¼Œå…¶ä»–ç”¨æˆ·æ‰å¯ä»¥è¿›å…¥ç¼–è¾‘çŠ¶æ€ã€‚ç±»ä¼¼äºç»™å›¾ç‰‡ç¼–è¾‘è¿™ä¸ªåŠ¨ä½œåŠ äº†ä¸€æŠŠé”ï¼Œç›´æ¥ä»æºå¤´ä¸Šè§£å†³äº†ç¼–è¾‘å†²çªçš„é—®é¢˜ã€‚

æ­¤æ—¶ï¼Œåä½œØœç¼–è¾‘çš„äº¤äº’æµç¨‹åˆè¦å¢åŠ  2 ä¸ªåŠ¨ä½œ â€”â€” è¿›å…¥ç¼–è¾‘çŠ¶æ€å’Œé€€å‡ºç¼–è¾‘çŠ¶æ€ï¼š

å…¶å®æ ¸å¿ƒæµç¨‹æ˜¯å‰ 5 è¡Œï¼Œä½†æ˜¯è€ƒè™‘åˆ°å‰ç«¯ä¼ é€’äº†é”™è¯¯å‚æ•°çš„æƒ…å†µï¼Œæˆ‘ä»¬æ–°å¢ä¸€ç§ `ERROR` äº‹ä»¶ç±»å‹ï¼Œå¯ç”¨äºå±•ç¤ºé”™è¯¯æç¤ºä¿¡æ¯ã€‚

åœ¨æœ¬é¡¹ç›®ä¸­Øœï¼Œæˆ‘ä»¬å°±é‡‡ç”¨è¿™ç§æ–¹æ¡ˆï¼Œä¸ä»…å®ç°ç®€å•ã€æµç¨‹æ¸…æ™°ï¼Œä¹Ÿå°½æœ€å¤§å¯èƒ½å‡å°‘äº†ç¼–è¾‘å†²çªçš„é£é™©ã€‚

ä½†è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹ä¹ŸØœå¾ˆæ˜æ˜¾ï¼Œå‡å°‘äº†å®æ—¶åä½œçš„ä¾¿åˆ©æ€§ï¼Œå¯¹äºåä½œè®¾è®¡ã€åä½œç¼–ç ã€åä½œæ–‡æ¡£çš„åœºæ™¯ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªç”¨æˆ·ç¼–è¾‘ï¼Œæé«˜çš„æ•ˆç‡æœ‰é™ã€‚æ‰€ä»¥è¿™é‡Œå†åˆ†äº«å¦å¤–ä¸€ç§å®æ—¶ååŒç®—æ³•ä½œä¸ºæ‰©å±•çŸ¥è¯†ã€‚

### 2ã€æ‰©å±•çŸ¥è¯† - OT ç®—æ³•

å®æ—¶ååŒ OT ç®—æ³•ï¼ˆOperational Transformationï¼‰æ˜¯ä¸€ç§æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªç”¨æˆ·å®æ—¶åä½œç¼–è¾‘çš„æ ¸å¿ƒç®—æ³•ï¼Œå¹¿æ³›åº”ç”¨äºåœ¨çº¿æ–‡æ¡£åä½œç­‰åœºæ™¯ã€‚OT ç®—æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯è§£å†³å¹¶å‘ç¼–è¾‘å†²çªï¼Œç¡®ä¿ç¼–è¾‘ç»“æœåœ¨æ‰€æœ‰ç”¨æˆ·ç»ˆç«¯ä¸€è‡´ã€‚

OT ç®—æ³•å…¶å®å¾ˆå¥½ç†è§£ï¼Œå…ˆçœ‹ä¸‹ 3 ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

* æ“ä½œ (Operation)ï¼šè¡¨ç¤ºç”¨æˆ·å¯¹åä½œå†…å®¹çš„ä¿®æ”¹ï¼Œæ¯”å¦‚æ’å…¥å­—ç¬¦ã€åˆ é™¤å­—ç¬¦ç­‰ã€‚
* è½¬åŒ– (Transformation)ï¼šå½“å¤šä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘å†…å®¹æ—¶ï¼ŒOT ä¼šæ ¹æ®æ“ä½œçš„ä¸Šä¸‹æ–‡å°†å®ƒä»¬è½¬åŒ–ï¼Œä½¿å¾—è¿™äº›æ“ä½œå¯ä»¥æŒ‰ç…§ä¸åŒçš„é¡ºåºåº”ç”¨è€Œç»“æœä¿æŒä¸€è‡´ã€‚
* å› æœä¸€è‡´æ€§ï¼šOT ç®—æ³•ç¡®ä¿æ“ä½œæŒ‰ç…§ç”¨æˆ·çœ‹åˆ°çš„é¡ºåºè¢«æ­£ç¡®æ‰§è¡Œï¼Œå³æ¯ä¸ªç”¨æˆ·çš„æ“ä½œåŸºäºæœ€æ–°çš„å†…å®¹çŠ¶æ€ã€‚

å…¶ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯ è½¬åŒ– æ­¥éª¤äº†ï¼Œç›¸å½“äºæœ‰ä¸€ä¸ªè´Ÿè´£äººç»Ÿä¸€æ”¶é›†å¤§å®¶çš„æ“ä½œï¼Œç„¶åæŒ‰ç…§è®¾å®šçš„è§„åˆ™å’Œä¿¡æ¯è¿›è¡Œæ’åºä¸åˆå¹¶ï¼Œæœ€ç»ˆç»™å¤§å®¶ä¸€ä¸ªç»Ÿä¸€çš„ç»“æœã€‚

ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾åˆå§‹å†…å®¹æ˜¯ `"abc"`ï¼Œç”¨æˆ· A å’Œ B åŒæ—¶è¿›è¡Œç¼–è¾‘ï¼š

* ç”¨æˆ· A åœ¨ä½ç½® `1` æ’å…¥ `"x"`
* ç”¨æˆ· B åœ¨ä½ç½® `2` åˆ é™¤ `"b"`

å¦‚æœä¸ä½¿ç”¨ OT ç®—æ³•ï¼Œç»“æœæ˜¯ï¼š

1. ç”¨æˆ· A æ“ä½œåï¼Œå†…å®¹å˜ä¸º `"axbc"`
2. ç”¨æˆ· B æ“ä½œåï¼Œå†…å®¹å˜ä¸º `"ac"`

å¦‚æœç›´æ¥åº”ç”¨ B çš„æ“ä½œåˆ° A çš„ç»“æœï¼Œå¾—åˆ°çš„æ˜¯ `"ac"`ï¼Œå¯¹äº A æ¥è¯´ï¼Œç›¸å½“äºåˆ é™¤äº† `"b"`ï¼ŒA ä¼šæ„Ÿåˆ°ä¸€è„¸æ‡µé€¼ã€‚1jGyT1jdedQgDNFYA8T3BC8Rpod+tQXglYFmkZuCZXA=

å¦‚æœä½¿ç”¨ OT ç®—æ³•ï¼Œç»“æœæ˜¯ï¼š

1. ç”¨æˆ· A çš„æ“ä½œï¼Œåº”ç”¨åå†…å®¹ä¸º `"axbc"`
2. ç”¨æˆ· B çš„æ“ä½œç»è¿‡ OT è½¬åŒ–ä¸ºåˆ é™¤ `"b"` åœ¨ `"axbc"` ä¸­çš„æ–°ä½ç½®

æœ€ç»ˆç”¨æˆ· A å’Œ B çš„å†…å®¹éƒ½ä¸€è‡´ä¸º `"axc"`ï¼Œç¬¦åˆé¢„æœŸã€‚OT ç®—æ³•ç¡®ä¿æ— è®ºç”¨æˆ·ç¼–è¾‘çš„é¡ºåºå¦‚ä½•ï¼Œæœ€ç»ˆå†…å®¹æ˜¯ä¸€è‡´çš„ã€‚

å½“ç„¶ï¼Œå…·ä½“Øœçš„ OT ç®—æ³•è¿˜æ˜¯è¦æ ¹æ®éœ€æ±‚æ¥è®¾è®¡äº†ï¼Œåä½œå¯†åº¦è¶Šé«˜ï¼Œç®—æ³•è®¾è®¡éš¾åº¦è¶Šå¤§ã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç§ä¸ OØœT ç±»ä¼¼çš„ååŒç®—æ³• CRDTï¼ˆConflict-free Replicated Data Typeï¼‰ï¼Œå…¶é€šè¿‡æ•°å­¦æ¨¡å‹å®ç°æ— éœ€ä¸­å¿ƒåŒ–è½¬åŒ–çš„å†²çªè§£å†³ï¼Œåœ¨ç¦»çº¿åä½œåœºæ™¯ä¸­æ›´å…·ä¼˜åŠ¿ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œäº†è§£ã€‚

## æé«˜åä½œå®æ—¶æ€§

åœ¨å®æ—¶é€šè®¯çš„ä¸šåŠ¡åœºØœæ™¯ä¸­ï¼Œå¸¸ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆåŒ…æ‹¬é•¿è½®è¯¢ã€SSE å’Œ WebSocketã€‚ç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚éœ€è¦å®ç°é¢‘ç¹ä¸”é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œå› æ­¤æˆ‘ä»¬é€‰ç”¨ WebSocket æ¥å®ç°å³æ—¶é€šè®¯ã€‚

### 1ã€ä»€ä¹ˆæ˜¯ WebSocketï¼Ÿ

WebSocket æ˜¯ä¸€ç§ å…¨åŒå·¥é€šä¿¡åè®®ï¼Œè®©å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚æµè§ˆå™¨ï¼‰å’ŒæœåŠ¡å™¨ä¹‹é—´èƒ½å¤Ÿä¿æŒå®æ—¶ã€æŒç»­çš„è¿æ¥ã€‚å’Œä¼ ç»Ÿçš„ HTTP è¯·æ±‚-å“åº”æ¨¡å¼ä¸åŒï¼ŒWebSocket æ˜¯ä¸€æ¡**â€œå¸¸å¼€çš„éš§é“â€** ï¼Œè¿æ¥çš„åŒæ–¹å¯ä»¥éšæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¸æ–­å»ºç«‹å’Œå…³é—­è¿æ¥ã€‚

æ‰“ä¸ªæ¯”æ–¹ï¼š

* HTTP å°±åƒç‚¹å¤–å–ï¼š æ¯æ¬¡ä¸‹å•ï¼ˆè¯·æ±‚ï¼‰- åˆ°è´§ï¼ˆå“åº”ï¼‰éƒ½æ˜¯ä¸€æ¬¡ç‹¬ç«‹çš„æ“ä½œï¼Œå®Œæˆåè¿æ¥å…³é—­ã€‚
* WebSocket åƒæ˜¯æ‰“ç”µè¯ï¼šä½ æ‰“é€šäº†ç”µè¯ï¼ˆå»ºç«‹è¿æ¥ï¼‰ï¼Œå¯ä»¥éšæ—¶èŠå¤©ï¼ˆåŒå‘é€šä¿¡ï¼‰ï¼Œç›´åˆ°æŒ‚æ–­ï¼ˆå…³é—­è¿æ¥ï¼‰ã€‚

### 2ã€WebSocket çš„åº”ç”¨åœºæ™¯

WebSocket çš„ä¸»è¦ä½œç”¨æ˜¯ å®ç°å®æ—¶æ•°æ®ä¼ è¾“ï¼Œé€‚ç”¨äºéœ€è¦é¢‘ç¹äº¤äº’æˆ–è€…å®æ—¶æ›´æ–°æ•°æ®çš„åœºæ™¯ã€‚æ¯”å¦‚ï¼š

* å³æ—¶é€šè®¯ï¼ˆèŠå¤©è½¯ä»¶ã€å®æ—¶åä½œå·¥å…·ï¼‰
* å®æ—¶æ•°æ®æ›´æ–°ï¼ˆè‚¡ç¥¨è¡Œæƒ…ã€ä½“è‚²æ¯”èµ›æ¯”åˆ†ï¼‰
* åœ¨çº¿æ¸¸æˆï¼ˆå¤šäººå®æ—¶äº’åŠ¨ï¼‰
* ç‰©è”ç½‘ï¼ˆè®¾å¤‡çŠ¶æ€å®æ—¶ä¼ è¾“ï¼‰
* ååŒç¼–è¾‘ï¼ˆåƒè¯­é›€è¿™æ ·çš„å¤šäººåä½œç¼–è¾‘ï¼‰

é€šè¿‡ WeØœbSocketï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´èƒ½å¤Ÿæ˜¾è‘—å‡å°‘æ¶ˆæ¯ä¼ è¾“çš„å»¶è¿Ÿï¼Œæé«˜é€šä¿¡æ•ˆç‡ï¼ŒåŒæ—¶é™ä½æ•°æ®ä¼ è¾“çš„å¼€é”€ã€‚

### 3ã€WebSocket å’Œ HTTP çš„å…³ç³»

WebSockØœet å’Œ HTTP æ˜¯ä¸¤ç§ä¸åŒçš„é€šä¿¡åè®®ï¼Œä½†å®ƒä»¬æ˜¯ç´§å¯†ç›¸å…³çš„ï¼Œéƒ½æ˜¯åŸºäº TCP åè®®ã€éƒ½å¯ä»¥åœ¨åŒæ ·çš„ç«¯å£ä¸Šå·¥ä½œï¼ˆæ¯”å¦‚ 80 å’Œ 443ï¼‰ã€‚

**é¦–å…ˆè¦æ˜ç¡®ï¼ŒWebSocket æ˜¯å»ºç«‹åœ¨ HTTP åŸºç¡€ä¹‹ä¸Šçš„ï¼** WebSocket çš„è¿æ¥éœ€è¦é€šè¿‡ HTTP åè®®å‘èµ·ä¸€ä¸ªæ¡æ‰‹ï¼ˆç§°ä¸º HTTP Upgrade è¯·æ±‚ï¼‰ï¼Œè¿™ä¸ªæ¡æ‰‹è¯·æ±‚æ˜¯ WebSocket å»ºç«‹è¿æ¥çš„å‰æï¼Œè¡¨æ˜å¸Œæœ›åˆ‡æ¢åè®®ï¼›æœåŠ¡å™¨å¦‚æœæ”¯æŒ WebSocketï¼Œä¼šè¿”å›ä¸€ä¸ª HTTP 101 çŠ¶æ€ç ï¼Œè¡¨ç¤ºåè®®åˆ‡æ¢æˆåŠŸã€‚

æ¡æ‰‹å®ŒæˆåØœï¼ŒHTTP åè®®çš„ä½œç”¨ç»“æŸï¼Œé€šä¿¡ä¼šåˆ‡æ¢ä¸º WebSocket åè®®ï¼ŒåŒæ–¹å¯ä»¥å¼€å§‹å…¨åŒå·¥é€šä¿¡ã€‚

### 4ã€WebSocket åä½œç¼–è¾‘çš„æµç¨‹

é€šè¿‡ WebSoØœcket å®æ—¶é€šä¿¡çš„èƒ½åŠ›ï¼Œå¯ä»¥å°†ç”¨æˆ·çš„ç¼–è¾‘æ“ä½œå‘ç»™ WebSocket æœåŠ¡å™¨ï¼Œå†ç”±æœåŠ¡å™¨è½¬å‘ç»™å…¶ä»–è¿æ¥æœåŠ¡å™¨çš„ç”¨æˆ·å‰ç«¯ï¼Œå‰ç«¯å°±å¯ä»¥æ ¹æ®æ“ä½œå¤„ç†å›¾ç‰‡ã€‚Dlfw8NwnEDAWu8E/AQcY7dm3A98behgssP1uNM9pOf8=

å…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼š

1. å»ºç«‹è¿æ¥ä¹‹å‰ï¼Œå…ˆè¿›è¡Œç”¨æˆ·æƒé™æ ¡éªŒï¼›æ ¡éªŒé€šè¿‡åï¼Œå°†ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€è¦ç¼–è¾‘çš„å›¾ç‰‡ä¿¡æ¯ä¿å­˜åˆ°è¦å»ºç«‹çš„ WebSocket è¿æ¥çš„ä¼šè¯å±æ€§ä¸­ã€‚
2. å»ºç«‹è¿æ¥æˆåŠŸåï¼Œå°† WebSocket ä¼šè¯ä¿å­˜åˆ°è¯¥å›¾ç‰‡å¯¹åº”çš„ä¼šè¯é›†åˆä¸­ï¼Œä¾¿äºåç»­åˆ†å‘æ¶ˆæ¯ç»™å…¶ä»–ä¼šè¯ã€‚
3. å‰ç«¯å°†æ¶ˆæ¯å‘é€åˆ°åç«¯ï¼Œåç«¯æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†å™¨ã€‚
4. å¤„ç†å™¨å¤„ç†æ¶ˆæ¯ï¼Œå°†å¤„ç†ç»“æœä½œä¸ºæ¶ˆæ¯å‘é€ç»™éœ€è¦çš„ WebSocket å®¢æˆ·ç«¯ã€‚
5. å½“å‰ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œåˆ é™¤ä¼šè¯é›†åˆä¸­çš„ WebSocket ä¼šè¯ï¼Œé‡Šæ”¾èµ„æºã€‚

å’Œ HTTØœP è¯·æ±‚ä¸€æ ·ï¼Œå‰ç«¯å’Œ WebSocket æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“ä¿¡æ¯æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ JSON æ ¼å¼å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–ã€‚

### 5ã€WebSocket çš„å®ç°æ–¹å¼

å¯¹äº Java Spring é¡¹ç›®ï¼Œä¸»è¦æœ‰åŸç”Ÿ WebSocketï¼ˆåŸºäº`WebSocketHandler` å®ç°ï¼‰ã€STOMPã€WebFlux è¿™ 3 ç§å®ç°æ–¹å¼ã€‚

å¯¹äºå¤§å¤šæ•°ç®€å•å®æ—¶æ¨é€ï¼Œé€‰ç”¨åŸç”Ÿ WebSocketï¼›å¯¹äºå¤æ‚çš„èŠå¤©å®¤å’ŒååŒç³»ç»Ÿï¼Œé€‰ç”¨ WebSocket + STOMP + SockJSï¼›å¯¹äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿæ•°æ®æµæ¨é€ï¼Œé€‰ç”¨ WebFlux + Reactive WebSocketã€‚

å¯¹äºæˆ‘ä»¬çš„Øœé¡¹ç›®ï¼Œå¹¶å‘è¦æ±‚ä¸é«˜ï¼Œé€‰æ‹© Spring åŸç”Ÿçš„ WebSocket æ¥é™ä½å¼€å‘æˆæœ¬ã€‚

æ˜ç¡®æ–¹æ¡ˆåï¼Œæˆ‘ä»¬è¿›å…¥åç«¯å¼€å‘ã€‚

---

# åç«¯å¼€å‘

## 1ã€å¼•å…¥ WebSocket ä¾èµ–

å¼•å…¥ä¾èµ–ï¼š


```XML
<!-- websocket --><dependency><groupId>org.springframework.boot</groupId><artifactId>spring-boot-starter-websocket</artifactId></dependency>
```

æ–°å»º `manager.websocket` åŒ…ï¼Œæ‰€æœ‰å’Œ WebSocket ç›¸å…³çš„ä»£ç éƒ½æ”¾åˆ°è¯¥åŒ…ä¸‹ã€‚

## 2ã€å®šä¹‰æ•°æ®æ¨¡å‹

æ–°å»º `websocket.model` åŒ…ï¼Œå­˜æ”¾æ•°æ®æ¨¡å‹ï¼ŒåŒ…æ‹¬è¯·æ±‚ç±»ã€å“åº”ç±»ã€æšä¸¾ç±»ã€‚

1ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘è¯·æ±‚æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯å‰ç«¯è¦å‘é€ç»™åç«¯çš„å‚æ•°ï¼š


```Java
@Data@NoArgsConstructor@AllArgsConstructorpublic class PictureEditRequestMessage {

    /**
     * æ¶ˆæ¯ç±»å‹ï¼Œä¾‹å¦‚ "ENTER_EDIT", "EXIT_EDIT", "EDIT_ACTION"
     */private String type;

    /**
     * æ‰§è¡Œçš„ç¼–è¾‘åŠ¨ä½œ
     */private String editAction;
}
```

2ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘å“åº”æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯åç«¯è¦å‘é€ç»™å‰ç«¯çš„ä¿¡æ¯ï¼š


```Java
@Data@NoArgsConstructor@AllArgsConstructorpublic class PictureEditResponseMessage {

    /**
     * æ¶ˆæ¯ç±»å‹ï¼Œä¾‹å¦‚ "INFO", "ERROR", "ENTER_EDIT", "EXIT_EDIT", "EDIT_ACTION"
     */private String type;

    /**
     * ä¿¡æ¯
     */private String message;

    /**
     * æ‰§è¡Œçš„ç¼–è¾‘åŠ¨ä½œ
     */private String editAction;

    /**
     * ç”¨æˆ·ä¿¡æ¯
     */private UserVO user;
}
```

3ï¼‰å®šä¹‰å›¾Øœç‰‡ç¼–è¾‘æ¶ˆæ¯ç±»å‹æšä¸¾ï¼Œä¾¿äºåç»­æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼š


```Java
@Getterpublic enum PictureEditMessageTypeEnum {

    INFO("å‘é€é€šçŸ¥", "INFO"),
    ERROR("å‘é€é”™è¯¯", "ERROR"),
    ENTER_EDIT("è¿›å…¥ç¼–è¾‘çŠ¶æ€", "ENTER_EDIT"),
    EXIT_EDIT("é€€å‡ºç¼–è¾‘çŠ¶æ€", "EXIT_EDIT"),
    EDIT_ACTION("æ‰§è¡Œç¼–è¾‘æ“ä½œ", "EDIT_ACTION");

    private final String text;
    private final String value;

    PictureEditMessageTypeEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */public static PictureEditMessageTypeEnum getEnumByValue(String value) {
        if (value == null || value.isEmpty()) {
            return null;
        }
        for (PictureEditMessageTypeEnum typeEnum : PictureEditMessageTypeEnum.values()) {
            if (typeEnum.value.equals(value)) {
                return typeEnum;
            }
        }
        return null;
    }
}
```

4ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘æ“ä½œç±»å‹æšä¸¾ï¼š


```Java
@Getterpublic enum PictureEditActionEnum {

    ZOOM_IN("æ”¾å¤§æ“ä½œ", "ZOOM_IN"),
    ZOOM_OUT("ç¼©å°æ“ä½œ", "ZOOM_OUT"),
    ROTATE_LEFT("å·¦æ—‹æ“ä½œ", "ROTATE_LEFT"),
    ROTATE_RIGHT("å³æ—‹æ“ä½œ", "ROTATE_RIGHT");

    private final String text;
    private final String value;

    PictureEditActionEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */public static PictureEditActionEnum getEnumByValue(String value) {
        if (value == null || value.isEmpty()) {
            return null;
        }
        for (PictureEditActionEnum actionEnum : PictureEditActionEnum.values()) {
            if (actionEnum.value.equals(value)) {
                return actionEnum;
            }
        }
        return null;
    }
}
```

## 3ã€WebSocket æ‹¦æˆªå™¨ - æƒé™æ ¡éªŒ

åœ¨ WebSocØœket è¿æ¥å‰éœ€è¦è¿›è¡Œæƒé™æ ¡éªŒï¼Œå¦‚æœå‘ç°ç”¨æˆ·æ²¡æœ‰å›¢é˜Ÿç©ºé—´å†…ç¼–è¾‘å›¾ç‰‡çš„æƒé™ï¼Œåˆ™æ‹’ç»æ¡æ‰‹ï¼Œå¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ª WebSocket æ‹¦æˆªå™¨å®ç°è¿™ä¸ªèƒ½åŠ›ã€‚

æ­¤å¤–ï¼Œç”±äº HTTP å’Œ ØœWebSocket çš„åŒºåˆ«ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨åç»­æ”¶åˆ°å‰ç«¯æ¶ˆæ¯æ—¶ç›´æ¥ä» request å¯¹è±¡ä¸­è·å–åˆ°ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå› æ­¤ä¹Ÿéœ€è¦é€šè¿‡ WebSocket æ‹¦æˆªå™¨ï¼Œä¸ºå³å°†å»ºç«‹è¿æ¥çš„ WebSocket ä¼šè¯æŒ‡å®šä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€ç¼–è¾‘çš„å›¾ç‰‡ id ç­‰ã€‚

ç¼–å†™æ‹¦æˆªå™¨çš„ä»£ç ï¼Œéœ€è¦å®ç° `HandshakeInterceptor` æ¥å£ï¼š


```Java
@Component@Slf4jpublic class WsHandshakeInterceptor implements HandshakeInterceptor {

    @Resourceprivate UserService userService;

    @Resourceprivate PictureService pictureService;

    @Resourceprivate SpaceService spaceService;

    @Resourceprivate SpaceUserAuthManager spaceUserAuthManager;

    @Overridepublic boolean beforeHandshake(@NotNull ServerHttpRequest request, @NotNull ServerHttpResponse response, @NotNull WebSocketHandler wsHandler, @NotNull Map<String, Object> attributes) {
        if (request instanceof ServletServerHttpRequest) {
            HttpServletRequest servletRequest = ((ServletServerHttpRequest) request).getServletRequest();
            // è·å–è¯·æ±‚å‚æ•°String pictureId = servletRequest.getParameter("pictureId");
            if (StrUtil.isBlank(pictureId)) {
                log.error("ç¼ºå°‘å›¾ç‰‡å‚æ•°ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            User loginUser = userService.getLoginUser(servletRequest);
            if (ObjUtil.isEmpty(loginUser)) {
                log.error("ç”¨æˆ·æœªç™»å½•ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            // æ ¡éªŒç”¨æˆ·æ˜¯å¦æœ‰è¯¥å›¾ç‰‡çš„æƒé™Picture picture = pictureService.getById(pictureId);
            if (picture == null) {
                log.error("å›¾ç‰‡ä¸å­˜åœ¨ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            Long spaceId = picture.getSpaceId();
            Space space = null;
            if (spaceId != null) {
                space = spaceService.getById(spaceId);
                if (space == null) {
                    log.error("ç©ºé—´ä¸å­˜åœ¨ï¼Œæ‹’ç»æ¡æ‰‹");
                    return false;
                }
                if (space.getSpaceType() != SpaceTypeEnum.TEAM.getValue()) {
log.info("ä¸æ˜¯å›¢é˜Ÿç©ºé—´ï¼Œæ‹’ç»æ¡æ‰‹");
                    return false;
                }
            }
            List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
            if (!permissionList.contains(SpaceUserPermissionConstant.PICTURE_EDIT)) {
                log.error("æ²¡æœ‰å›¾ç‰‡ç¼–è¾‘æƒé™ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            // è®¾ç½® attributes
            attributes.put("user", loginUser);
            attributes.put("userId", loginUser.getId());
            attributes.put("pictureId", Long.valueOf(pictureId)); // è®°å¾—è½¬æ¢ä¸º Long ç±»å‹
        }
        return true;
    }

    @Overridepublic void afterHandshake(@NotNull ServerHttpRequest request, @NotNull ServerHttpResponse response, @NotNull WebSocketHandler wsHandler, Exception exception) {
    }
}
```

## 4ã€WebSocket å¤„ç†å™¨

æˆ‘ä»¬éœ€è¦å®šØœä¹‰ WebSocket å¤„ç†å™¨ç±»ï¼Œåœ¨è¿æ¥æˆåŠŸã€è¿æ¥å…³é—­ã€æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯æ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

å¯ä»¥å®ç° ØœTextWebSocketHandler æ¥å£ï¼Œè¿™æ ·å°±èƒ½ä»¥å­—ç¬¦ä¸²çš„æ–¹å¼å‘é€å’Œæ¥å—æ¶ˆæ¯äº†ï¼š


```Java
@Componentpublic class PictureEditHandler extends TextWebSocketHandler {
}
```

1ï¼‰é¦–å…ˆåœ¨å¤„ç†å™¨ç±»ä¸­å®šä¹‰ 2 ä¸ªå¸¸é‡ï¼Œåˆ†åˆ«ä¸ºï¼š

* ä¿å­˜å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ· idï¼Œæ‰§è¡Œç¼–è¾‘æ“ä½œã€è¿›å…¥æˆ–é€€å‡ºç¼–è¾‘æ—¶éƒ½ä¼šæ ¡éªŒã€‚
* ä¿å­˜å‚ä¸ç¼–è¾‘å›¾ç‰‡çš„ç”¨æˆ· WebSocket ä¼šè¯çš„é›†åˆã€‚

ç”±äºæ¯ä¸ªå›¾Øœç‰‡çš„åä½œç¼–è¾‘éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨ Map æ¥åŒºåˆ†æ¯ä¸ªå›¾ç‰‡ id å¯¹åº”çš„æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š


```Java
// æ¯å¼ å›¾ç‰‡çš„ç¼–è¾‘çŠ¶æ€ï¼Œkey: pictureId, value: å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ· IDprivate final Map<Long, Long> pictureEditingUsers = new ConcurrentHashMap<>();

// ä¿å­˜æ‰€æœ‰è¿æ¥çš„ä¼šè¯ï¼Œkey: pictureId, value: ç”¨æˆ·ä¼šè¯é›†åˆprivate final Map<Long, Set<WebSocketSession>> pictureSessions = new ConcurrentHashMap<>();
```

æ³¨æ„ï¼Œç”±äºå¯èƒ½åŒæ—¶æœ‰å¤šä¸ª WebSocket å®¢æˆ·ç«¯å»ºç«‹è¿æ¥å’Œå‘é€æ¶ˆæ¯ï¼Œé›†åˆè¦ä½¿ç”¨å¹¶å‘åŒ…ï¼ˆJUCï¼‰ä¸­çš„ `ConcurrentHashMap`ï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

2ï¼‰ç”±äºæ¥ä¸‹æ¥å¾ˆå¤šæ¶ˆæ¯éƒ½éœ€è¦ä¼ é€’ç»™æ‰€æœ‰åä½œè€…ï¼Œæ‰€ä»¥å…ˆç¼–å†™ä¸€ä¸ª å¹¿æ’­æ¶ˆæ¯ çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šæ ¹æ® pictureIdï¼Œå°†å“åº”æ¶ˆæ¯å‘é€ç»™ç¼–è¾‘è¯¥å›¾ç‰‡çš„æ‰€æœ‰ä¼šè¯ã€‚è€ƒè™‘åˆ°å¯èƒ½ä¼šæœ‰æ¶ˆæ¯ä¸éœ€è¦å‘é€ç»™ç¼–è¾‘è€…æœ¬äººçš„æƒ…å†µï¼Œè¯¥æ–¹æ³•è¿˜å¯ä»¥æ¥å— excludeSession å‚æ•°ï¼Œæ”¯æŒæ’é™¤æ‰å‘æŸä¸ªä¼šè¯å‘é€æ¶ˆæ¯ã€‚

ä»£ç å¦‚ä¸‹ï¼šØœâ€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€Œâ€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‚â€‚â€Œâ€‚â€‰â€‚â€‰â€‚â€‰â€‰â€‰â€‚ï»¿â€‰â€‰â€‰â€‚â€‚


```Java
private void broadcastToPicture(Long pictureId, PictureEditResponseMessage pictureEditResponseMessage, WebSocketSession excludeSession) throws Exception {
    Set<WebSocketSession> sessionSet = pictureSessions.get(pictureId);
    if (CollUtil.isNotEmpty(sessionSet)) {
        // åˆ›å»º ObjectMapperObjectMapper objectMapper = new ObjectMapper();
        // é…ç½®åºåˆ—åŒ–ï¼šå°† Long ç±»å‹è½¬ä¸º Stringï¼Œè§£å†³ä¸¢å¤±ç²¾åº¦é—®é¢˜SimpleModule module = new SimpleModule();
        module.addSerializer(Long.class, ToStringSerializer.instance);
        module.addSerializer(Long.TYPE, ToStringSerializer.instance); // æ”¯æŒ long åŸºæœ¬ç±»å‹
        objectMapper.registerModule(module);
        // åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²String message = objectMapper.writeValueAsString(pictureEditResponseMessage);
        TextMessage textMessage = new TextMessage(message);
        for (WebSocketSession session : sessionSet) {
            // æ’é™¤æ‰çš„ session ä¸å‘é€if (excludeSession != null && excludeSession.equals(session)) {
                continue;
            }
            if (session.isOpen()) {
                session.sendMessage(textMessage);
            }
        }
    }
}
```

ä¸Šè¿°ä»£ç ä¸­æœ‰ä¸ªå°ç»†ØœèŠ‚ï¼Œç”±äºå‰ç«¯ JS çš„é•¿æ•´æ•°å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ï¼Œæ‰€ä»¥ä½¿ç”¨ Jackson è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ï¼Œåœ¨å°†å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²æ—¶ï¼Œå°† Long ç±»å‹è½¬æ¢ä¸º String ç±»å‹ã€‚

å†ç¼–å†™ä¸€ä¸ªä¸æ’é™¤ Sessionï¼Œç»™æ‰€æœ‰ä¼šè¯å¹¿æ’­çš„æ–¹æ³•ï¼š


```Java
// å…¨éƒ¨å¹¿æ’­private void broadcastToPicture(Long pictureId, PictureEditResponseMessage pictureEditResponseMessage) throws Exception {
    broadcastToPicture(pictureId, pictureEditResponseMessage, null);
}
```

3ï¼‰å®ç°è¿Øœæ¥å»ºç«‹æˆåŠŸåæ‰§è¡Œçš„æ–¹æ³•ï¼Œä¿å­˜ä¼šè¯åˆ°é›†åˆä¸­ï¼Œå¹¶ä¸”ç»™å…¶ä»–ä¼šè¯å‘é€æ¶ˆæ¯ï¼š


```Java
@Overridepublic void afterConnectionEstablished(WebSocketSession session) throws Exception {
    // ä¿å­˜ä¼šè¯åˆ°é›†åˆä¸­User user = (User) session.getAttributes().get("user");
    Long pictureId = (Long) session.getAttributes().get("pictureId");
    pictureSessions.putIfAbsent(pictureId, ConcurrentHashMap.newKeySet());
    pictureSessions.get(pictureId).add(session);

    // æ„é€ å“åº”PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
    pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.INFO.getValue());
    String message = String.format("%såŠ å…¥ç¼–è¾‘", user.getUserName());
    pictureEditResponseMessage.setMessage(message);
    pictureEditResponseMessage.setUser(userService.getUserVO(user));
    // å¹¿æ’­ç»™åŒä¸€å¼ å›¾ç‰‡çš„ç”¨æˆ·
    broadcastToPicture(pictureId, pictureEditResponseMessage);
}
```

4ï¼‰ç¼–å†™æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯çš„æ–¹æ³•ï¼Œæ ¹æ®æ¶ˆæ¯ç±»åˆ«æ‰§è¡Œä¸åŒçš„å¤„ç†ï¼š


```Java
@Overrideprotected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
    // å°†æ¶ˆæ¯è§£æä¸º PictureEditMessagePictureEditRequestMessage pictureEditRequestMessage = JSONUtil.toBean(message.getPayload(), PictureEditRequestMessage.class);
    String type = pictureEditRequestMessage.getType();
    PictureEditMessageTypeEnum pictureEditMessageTypeEnum = PictureEditMessageTypeEnum.valueOf(type);

    // ä» Session å±æ€§ä¸­è·å–å…¬å…±å‚æ•°
    Map<String, Object> attributes = session.getAttributes();
    User user = (User) attributes.get("user");
    Long pictureId = (Long) attributes.get("pictureId");

    // è°ƒç”¨å¯¹åº”çš„æ¶ˆæ¯å¤„ç†æ–¹æ³•switch (pictureEditMessageTypeEnum) {
        case ENTER_EDIT:
            handleEnterEditMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        case EDIT_ACTION:
            handleEditActionMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        case EXIT_EDIT:
            handleExitEditMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        default:
            PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
            pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ERROR.getValue());
            pictureEditResponseMessage.setMessage("æ¶ˆæ¯ç±»å‹é”™è¯¯");
            pictureEditResponseMessage.setUser(userService.getUserVO(user));
            session.sendMessage(new TextMessage(JSONUtil.toJsonStr(pictureEditResponseMessage)));
    }
}
```

æ¥ä¸‹æ¥ä¾æ¬¡Øœç¼–å†™æ¯ä¸ªå¤„ç†æ¶ˆæ¯çš„æ–¹æ³•ã€‚é¦–å…ˆæ˜¯ç”¨æˆ·è¿›å…¥ç¼–è¾‘çŠ¶æ€ï¼Œè¦è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç¼–è¾‘ç”¨æˆ·ï¼Œå¹¶ä¸”å‘å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š


```Java
public void handleEnterEditMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    // æ²¡æœ‰ç”¨æˆ·æ­£åœ¨ç¼–è¾‘è¯¥å›¾ç‰‡ï¼Œæ‰èƒ½è¿›å…¥ç¼–è¾‘if (!pictureEditingUsers.containsKey(pictureId)) {
        // è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç¼–è¾‘ç”¨æˆ·
        pictureEditingUsers.put(pictureId, user.getId());
        PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ENTER_EDIT.getValue());
        String message = String.format("%så¼€å§‹ç¼–è¾‘å›¾ç‰‡", user.getUserName());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        broadcastToPicture(pictureId, pictureEditResponseMessage);
    }
}
```

ç”¨æˆ·æ‰§è¡Œç¼–è¾‘æ“ä½œæ—¶ï¼Œå°†è¯¥æ“ä½œåŒæ­¥ç»™ é™¤äº†å½“å‰ç”¨æˆ·ä¹‹å¤– çš„å…¶ä»–å®¢æˆ·ç«¯ï¼Œä¹Ÿå°±æ˜¯è¯´ç¼–è¾‘æ“ä½œä¸ç”¨å†åŒæ­¥ç»™è‡ªå·±ï¼š


```Java
public void handleEditActionMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    Long editingUserId = pictureEditingUsers.get(pictureId);
    String editAction = pictureEditRequestMessage.getEditAction();
    PictureEditActionEnum actionEnum = PictureEditActionEnum.getEnumByValue(editAction);
    if (actionEnum == null) {
        return;
    }
    // ç¡®è®¤æ˜¯å½“å‰ç¼–è¾‘è€…if (editingUserId != null && editingUserId.equals(user.getId())) {
        PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.EDIT_ACTION.getValue());
        String message = String.format("%sæ‰§è¡Œ%s", user.getUserName(), actionEnum.getText());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setEditAction(editAction);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        // å¹¿æ’­ç»™é™¤äº†å½“å‰å®¢æˆ·ç«¯ä¹‹å¤–çš„å…¶ä»–ç”¨æˆ·ï¼Œå¦åˆ™ä¼šé€ æˆé‡å¤ç¼–è¾‘
        broadcastToPicture(pictureId, pictureEditResponseMessage, session);
    }
}
```

ç”¨æˆ·é€€å‡ºç¼–Øœè¾‘æ“ä½œæ—¶ï¼Œç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€ï¼Œå¹¶ä¸”å‘å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š


```Java
public void handleExitEditMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    Long editingUserId = pictureEditingUsers.get(pictureId);
    if (editingUserId != null && editingUserId.equals(user.getId())) {
        // ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€
        pictureEditingUsers.remove(pictureId);
        // æ„é€ å“åº”ï¼Œå‘é€é€€å‡ºç¼–è¾‘çš„æ¶ˆæ¯é€šçŸ¥PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.EXIT_EDIT.getValue());
        String message = String.format("%sé€€å‡ºç¼–è¾‘å›¾ç‰‡", user.getUserName());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        broadcastToPicture(pictureId, pictureEditResponseMessage);
    }
}
```

5ï¼‰WebSØœocket è¿æ¥å…³é—­æ—¶ï¼Œéœ€è¦ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€ã€å¹¶ä¸”ä»é›†åˆä¸­åˆ é™¤å½“å‰ä¼šè¯ï¼Œè¿˜å¯ä»¥ç»™å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯é€šçŸ¥ï¼š


```Java
@Overridepublic void afterConnectionClosed(WebSocketSession session, @NotNull CloseStatus status) throws Exception {
    Map<String, Object> attributes = session.getAttributes();
    Long pictureId = (Long) attributes.get("pictureId");
    User user = (User) attributes.get("user");
    // ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€
    handleExitEditMessage(null, session, user, pictureId);

    // åˆ é™¤ä¼šè¯
    Set<WebSocketSession> sessionSet = pictureSessions.get(pictureId);
    if (sessionSet != null) {
        sessionSet.remove(session);
        if (sessionSet.isEmpty()) {
            pictureSessions.remove(pictureId);
        }
    }

    // å“åº”PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
    pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.INFO.getValue());
    String message = String.format("%sç¦»å¼€ç¼–è¾‘", user.getUserName());
    pictureEditResponseMessage.setMessage(message);
    pictureEditResponseMessage.setUser(userService.getUserVO(user));
    broadcastToPicture(pictureId, pictureEditResponseMessage);
}
```

ğŸ’¡ ç”±äºå¤„ç†å™¨çš„ä»£ç Øœå¹¶ä¸å¤æ‚ï¼Œè€Œä¸”å¤„ç†é€»è¾‘ä¸­ä½¿ç”¨åˆ°äº†å½“å‰ç±»çš„å…¨å±€å˜é‡ï¼Œæ‰€ä»¥æ²¡æœ‰é€‰æ‹©å°†æ¯ä¸ªå¤„ç†å™¨å°è£…ä¸ºå•ç‹¬çš„ç±»ã€‚å¤§å®¶ä¹Ÿå¯ä»¥å°†æ¯ä¸ªå¤„ç†å™¨å°è£…ä¸ºå•ç‹¬çš„ç±»ï¼ˆç›¸å½“äºè®¾è®¡æ¨¡å¼ä¸­çš„ç­–ç•¥æ¨¡å¼ï¼‰ï¼Œå¹¶ä¸”æ ¹æ®æ¶ˆæ¯ç±»åˆ«è°ƒ

## 5ã€WebSocket é…ç½®

ç±»ä¼¼äºç¼–å†™Øœ Spring MVC çš„ Controller æ¥å£ï¼Œå¯ä»¥ä¸ºæŒ‡å®šçš„è·¯å¾„é…ç½®å¤„ç†å™¨å’Œæ‹¦æˆªå™¨ï¼š


```Java
@Configuration@EnableWebSocketpublic class WebSocketConfig implements WebSocketConfigurer {

    @Resourceprivate PictureEditHandler pictureEditHandler;

    @Resourceprivate WsHandshakeInterceptor wsHandshakeInterceptor;

    @Overridepublic void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        // websocket
        registry.addHandler(pictureEditHandler, "/ws/picture/edit")
                .addInterceptors(wsHandshakeInterceptor)
                .setAllowedOrigins("*");
    }
}
```

ä¹‹åï¼Œå‰ç«¯å°±å¯ä»¥é€šè¿‡ WebSocket è¿æ¥é¡¹ç›®å¯åŠ¨ç«¯å£çš„ `/ws/picture/edit` è·¯å¾„äº†ã€‚

---

# å‰ç«¯å¼€å‘

å‰ç«¯å¼€å‘ä¸»è¦é›†ä¸­åœ¨åŸºç¡€å›¾ç‰‡ç¼–è¾‘ç»„ä»¶ `ImageCropper.vue` ä¸­ã€‚

## 1ã€åŸºç¡€ä»£ç 

é¦–å…ˆæ ¹æ®åç«¯çš„æšä¸¾ç±»å’Œå¸¸é‡ï¼Œåœ¨ `picture.ts` ä¸­å®šä¹‰å›¾ç‰‡ç¼–è¾‘æ¶ˆæ¯ç±»å‹ã€å›¾ç‰‡ç¼–è¾‘åŠ¨ä½œï¼š


```TypeScript
export const PICTURE_EDIT_MESSAGE_TYPE_ENUM = {
  INFO: 'INFO',
  ERROR: 'ERROR',
  ENTER_EDIT: 'ENTER_EDIT',
  EXIT_EDIT: 'EXIT_EDIT',
  EDIT_ACTION: 'EDIT_ACTION',
};

export const PICTURE_EDIT_MESSAGE_TYPE_MAP = {
  INFO: 'å‘é€é€šçŸ¥',
  ERROR: 'å‘é€é”™è¯¯',
  ENTER_EDIT: 'è¿›å…¥ç¼–è¾‘çŠ¶æ€',
  EXIT_EDIT: 'é€€å‡ºç¼–è¾‘çŠ¶æ€',
  EDIT_ACTION: 'æ‰§è¡Œç¼–è¾‘æ“ä½œ',
};

export const PICTURE_EDIT_ACTION_ENUM = {
  ZOOM_IN: 'ZOOM_IN',
  ZOOM_OUT: 'ZOOM_OUT',
  ROTATE_LEFT: 'ROTATE_LEFT',
  ROTATE_RIGHT: 'ROTATE_RIGHT',
};

export const PICTURE_EDIT_ACTION_MAP = {
  ZOOM_IN: 'æ”¾å¤§æ“ä½œ',
  ZOOM_OUT: 'ç¼©å°æ“ä½œ',
  ROTATE_LEFT: 'å·¦æ—‹æ“ä½œ',
  ROTATE_RIGHT: 'å³æ—‹æ“ä½œ',
};
```

## 2ã€WebSocket å‰ç«¯åŸºç¡€ä»£ç 

ä¸ºäº†è®©é¡µé¢æˆ–ç»„ä»¶çš„ä»£ç ä¸­èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°ä½¿ç”¨ WebSocket è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨ `utils` ç›®å½•ä¸‹ç¼–å†™é€‚ç”¨äºå›¾ç‰‡ç¼–è¾‘ WebSocket è¿æ¥çš„å·¥å…·ç±»ã€‚å®šä¹‰äº†ï¼š

* è¿æ¥ WebSocket çš„åœ°å€
* WebSocket å„ä¸ªäº‹ä»¶çš„å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚è¿æ¥æˆåŠŸå’Œè¿æ¥å…³é—­äº‹ä»¶ï¼Œè·Ÿåç«¯å¯¹åº”
* å‘ WebSocket æœåŠ¡ç«¯å‘é€æ¶ˆæ¯çš„å‡½æ•°ç­‰

ä»£ç å¦‚ä¸‹ï¼Œè¿™æ®µå±äºæ ·æ¿ä»£ç ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å³å¯ï¼Œä¸å¿…è‡ªå·±æ•²ï¼š


```TypeScript
export default class PictureEditWebSocket {
  private pictureId: numberprivate socket: WebSocket | nullprivate eventHandlers: anyconstructor(pictureId: number) {
    this.pictureId = pictureId // å½“å‰ç¼–è¾‘çš„å›¾ç‰‡ IDthis.socket = null // WebSocket å®ä¾‹this.eventHandlers = {} // è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨
  }

  /**
   * åˆå§‹åŒ– WebSocket è¿æ¥
   */connect() {
    const url = `ws://localhost:8123/api/ws/picture/edit?pictureId=${this.pictureId}`this.socket = new WebSocket(url)

    // è®¾ç½®æºå¸¦ cookiethis.socket.binaryType = 'blob'// ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶this.socket.onopen = () => {
      console.log('WebSocket è¿æ¥å·²å»ºç«‹')
      this.triggerEvent('open')
    }

    // ç›‘å¬æ¶ˆæ¯äº‹ä»¶this.socket.onmessage = (event) => {
      const message = JSON.parse(event.data)
      console.log('æ”¶åˆ°æ¶ˆæ¯:', message)

      // æ ¹æ®æ¶ˆæ¯ç±»å‹è§¦å‘å¯¹åº”äº‹ä»¶const type = message.typethis.triggerEvent(type, message)
    }

    // ç›‘å¬è¿æ¥å…³é—­äº‹ä»¶this.socket.onclose = (event) => {
      console.log('WebSocket è¿æ¥å·²å…³é—­:', event)
      this.triggerEvent('close', event)
    }

    // ç›‘å¬é”™è¯¯äº‹ä»¶this.socket.onerror = (error) => {
      console.error('WebSocket å‘ç”Ÿé”™è¯¯:', error)
      this.triggerEvent('error', error)
    }
  }

  /**
   * å…³é—­ WebSocket è¿æ¥
   */disconnect() {
    if (this.socket) {
      this.socket.close()
      console.log('WebSocket è¿æ¥å·²æ‰‹åŠ¨å…³é—­')
    }
  }

  /**
   * å‘é€æ¶ˆæ¯åˆ°åç«¯
   * @param {Object} message æ¶ˆæ¯å¯¹è±¡
   */sendMessage(message: object) {
    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
      this.socket.send(JSON.stringify(message))
      console.log('æ¶ˆæ¯å·²å‘é€:', message)
    } else {
      console.error('WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯:', message)
    }
  }

  /**
   * æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬
   * @param {string} type æ¶ˆæ¯ç±»å‹
   * @param {Function} handler æ¶ˆæ¯å¤„ç†å‡½æ•°
   */on(type: string, handler: (data?: any) => void) {
    if (!this.eventHandlers[type]) {
      this.eventHandlers[type] = []
    }
    this.eventHandlers[type].push(handler)
  }

  /**
   * è§¦å‘äº‹ä»¶
   * @param {string} type æ¶ˆæ¯ç±»å‹
   * @param {Object} data æ¶ˆæ¯æ•°æ®
   */triggerEvent(type: string, data?: any) {
    const handlers = this.eventHandlers[type]
    if (handlers) {
      handlers.forEach((handler: any) => handler(data))
    }
  }
}
```

ä¸Šè¿°ä»£ç ä¸­æ¯”è¾ƒå·§å¦™çš„æ˜¯ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€å¥—äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼Œä½¿ç”¨å·¥å…·ç±»çš„ç»„ä»¶å¯ä»¥é€šè¿‡ `on` æ–¹æ³•æ³¨å†Œäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç„¶åé€šè¿‡ `triggerEvent` å‡½æ•°è§¦å‘äº‹ä»¶å¤„ç†å‡½æ•°ã€‚

## 3ã€å›¾ç‰‡ç¼–è¾‘ç»„ä»¶å¼€å‘

1ï¼‰å®šä¹‰å“åº”Øœå¼å˜é‡ï¼ŒåŒ…æ‹¬æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ã€ç”¨æˆ·æ˜¯å¦å¯ä»¥è¿›å…¥ç¼–è¾‘ã€ç”¨æˆ·æ˜¯å¦å¯ä»¥é€€å‡ºç¼–è¾‘ï¼Œè¿™äº›å˜é‡ä¼šç”¨äºæ§åˆ¶é¡µé¢çš„å±•ç¤ºå’Œç¼–è¾‘æŒ‰é’®æ˜¯å¦å¯ç‚¹å‡»ï¼š


```TypeScript
// --------- å®æ—¶ç¼–è¾‘ ---------const loginUserStore = useLoginUserStore()
let loginUser = loginUserStore.loginUser// æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·const editingUser = ref<API.UserVO>()
// æ²¡æœ‰ç”¨æˆ·æ­£åœ¨ç¼–è¾‘ä¸­ï¼Œå¯è¿›å…¥ç¼–è¾‘const canEnterEdit = computed(() => {
  return !editingUser.value
})
// æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·æ˜¯æœ¬äººï¼Œå¯é€€å‡ºç¼–è¾‘const canExitEdit = computed(() => {
  return editingUser.value?.id === loginUser.id
})
// å¯ä»¥ç¼–è¾‘const canEdit = computed(() => {
  return editingUser.value?.id === loginUser.id
})
```

2ï¼‰å¼€å‘ååŒç¼–è¾‘æ“ä½œç›¸å…³çš„æŒ‰é’®å…ƒç´ ï¼š


```PlainText
<!-- ååŒç¼–è¾‘æ“ä½œ -->
<div class="image-edit-actions">
  <a-space>
    <a-button v-if="editingUser" disabled> {{ editingUser.userName }}æ­£åœ¨ç¼–è¾‘</a-button>
    <a-button v-if="canEnterEdit" type="primary" ghost @click="enterEdit">è¿›å…¥ç¼–è¾‘</a-button>
    <a-button v-if="canExitEdit" danger ghost @click="exitEdit">é€€å‡ºç¼–è¾‘</a-button>
  </a-space>
</div>
```

ç»™æ‰€æœ‰çš„å›¾Øœç‰‡ç¼–è¾‘æ“ä½œæŒ‰é’®è¡¥å……ç¦ç”¨çŠ¶æ€ï¼Œå¦‚æœæœ‰å…¶ä»–äººåœ¨ç¼–è¾‘ï¼Œåˆ™ç¦ç”¨æŒ‰é’®ï¼š


```PlainText
<a-space>
  <a-button @click="rotateLeft" :disabled="!canEdit">å‘å·¦æ—‹è½¬</a-button>
  <a-button @click="rotateRight" :disabled="!canEdit">å‘å³æ—‹è½¬</a-button>
  <a-button @click="changeScale(1)" :disabled="!canEdit">æ”¾å¤§</a-button>
  <a-button @click="changeScale(-1)" :disabled="!canEdit">ç¼©å°</a-button>
  <a-button type="primary" :loading="loading" :disabled="!canEdit" @click="handleConfirm">
    ç¡®è®¤
  </a-button>
</a-space>
```

æ•ˆæœå¦‚å›¾ï¼š

3ï¼‰åˆå§‹åŒ– WebSocket è¿æ¥ï¼Œç»‘å®šäº‹ä»¶ï¼š


```TypeScript
let websocket: PictureEditWebSocket | null// åˆå§‹åŒ– WebSocket è¿æ¥ï¼Œç»‘å®šäº‹ä»¶const initWebsocket = () => {
  const pictureId = props.picture?.idif (!pictureId || !visible.value) {
    return
  }
  // é˜²æ­¢ä¹‹å‰çš„è¿æ¥æœªé‡Šæ”¾if (websocket) {
    websocket.disconnect()
  }
  // åˆ›å»º WebSocket å®ä¾‹
  websocket = new PictureEditWebSocket(pictureId)
  // å»ºç«‹ WebSocket è¿æ¥
  websocket.connect()

  // ç›‘å¬é€šçŸ¥æ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.INFO, (msg) => {
    console.log('æ”¶åˆ°é€šçŸ¥æ¶ˆæ¯ï¼š', msg)
message.info(msg.message)
  })

  // ç›‘å¬é”™è¯¯æ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.ERROR, (msg) => {
    console.log('æ”¶åˆ°é”™è¯¯æ¶ˆæ¯ï¼š', msg)
    message.error(msg.message)
  })

  // ç›‘å¬è¿›å…¥ç¼–è¾‘çŠ¶æ€æ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.ENTER_EDIT, (msg) => {
    console.log('æ”¶åˆ°è¿›å…¥ç¼–è¾‘çŠ¶æ€æ¶ˆæ¯ï¼š', msg)
message.info(msg.message)
    editingUser.value = msg.user
  })

  // ç›‘å¬ç¼–è¾‘æ“ä½œæ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.EDIT_ACTION, (msg) => {
    console.log('æ”¶åˆ°ç¼–è¾‘æ“ä½œæ¶ˆæ¯ï¼š', msg)
message.info(msg.message)
    switch (msg.editAction) {
      case PICTURE_EDIT_ACTION_ENUM.ROTATE_LEFT:
        cropperRef.value.rotateLeft()
        breakcase PICTURE_EDIT_ACTION_ENUM.ROTATE_RIGHT:
        cropperRef.value.rotateRight()
        breakcase PICTURE_EDIT_ACTION_ENUM.ZOOM_IN:
        cropperRef.value.changeScale(1)
        breakcase PICTURE_EDIT_ACTION_ENUM.ZOOM_OUT:
        cropperRef.value.changeScale(-1)
        break
    }
  })

  // ç›‘å¬é€€å‡ºç¼–è¾‘çŠ¶æ€æ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.EXIT_EDIT, (msg) => {
    console.log('æ”¶åˆ°é€€å‡ºç¼–è¾‘çŠ¶æ€æ¶ˆæ¯ï¼š', msg)
message.info(msg.message)
    editingUser.value = undefined
  })
}

watchEffect(() => {
  initWebsocket()
})

onUnmounted(() => {
  // æ–­å¼€è¿æ¥if (websocket) {
    websocket.disconnect()
  }
  editingUser.value = undefined
})

// å…³é—­å¼¹çª—const closeModal = () => {
  visible.value = false// æ–­å¼€è¿æ¥if (websocket) {
    websocket.disconnect()
  }
  editingUser.value = undefined
}
```

ä¸Šè¿°ä»£ç ä¸­çš„å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

1. å®šä¹‰äº†æ”¶åˆ°æ¶ˆæ¯åçš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚æ”¶åˆ°ç¼–è¾‘æ“ä½œæ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨å›¾ç‰‡ç¼–è¾‘å™¨ç»„ä»¶çš„å¯¹åº”æ“ä½œæ–¹æ³•ï¼Œæ¥åŒæ­¥ç¼–è¾‘ç»“æœã€‚æ”¶åˆ°æœ‰ç”¨æˆ·è¿›å…¥ç¼–è¾‘çŠ¶æ€çš„æ¶ˆæ¯æ—¶ï¼Œè®¾ç½® editingUser çš„å€¼ï¼›æ”¶åˆ°æœ‰ç”¨æˆ·é€€å‡ºç¼–è¾‘çŠ¶æ€çš„æ¶ˆæ¯æ—¶ï¼Œæ¸…ç©º editingUser çš„å€¼ã€‚
2. åŠæ—¶é‡Šæ”¾ WebSocket è¿æ¥å’Œèµ„æºï¼šåœ¨ç»„ä»¶é”€æ¯æ—¶ï¼ˆonUnmounted å‡½æ•°ï¼‰ã€å¼¹çª—å…³é—­æ—¶ï¼ˆcloseModal å‡½æ•°ï¼‰ã€é‡æ–°è¿æ¥æ—¶ï¼ˆinitWebsocket å‡½æ•°å¼€å¤´ï¼‰éƒ½è¦é‡Šæ”¾è¿æ¥å¹¶é‡ç½®æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ã€‚

4ï¼‰ç¼–è¾‘å‘é€ WØœebSocket æ¶ˆæ¯çš„å‡½æ•°ï¼ŒåŒ…æ‹¬è¿›å…¥ç¼–è¾‘çŠ¶æ€ã€é€€å‡ºç¼–è¾‘çŠ¶æ€ã€æ‰§è¡Œç¼–è¾‘å›¾ç‰‡æ“ä½œï¼šâ€‚â€‚â€‚â€‚â€‚ï»¿â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‚â€‚â€‚â€‰â€â€‚â€‰â€‚â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‚â€‚


```TypeScript
// è¿›å…¥ç¼–è¾‘çŠ¶æ€const enterEdit = () => {
  if (websocket) {
    // å‘é€è¿›å…¥ç¼–è¾‘çŠ¶æ€çš„æ¶ˆæ¯
    websocket.sendMessage({
      type: PICTURE_EDIT_MESSAGE_TYPE_ENUM.ENTER_EDIT,
    })
  }
}

// é€€å‡ºç¼–è¾‘çŠ¶æ€const exitEdit = () => {
  if (websocket) {
    // å‘é€é€€å‡ºç¼–è¾‘çŠ¶æ€çš„æ¶ˆæ¯
    websocket.sendMessage({
      type: PICTURE_EDIT_MESSAGE_TYPE_ENUM.EXIT_EDIT,
    })
  }
}

// ç¼–è¾‘å›¾ç‰‡æ“ä½œconst editAction = (action: string) => {
  if (websocket) {
    // å‘é€ç¼–è¾‘æ“ä½œçš„è¯·æ±‚
    websocket.sendMessage({
      type: PICTURE_EDIT_MESSAGE_TYPE_ENUM.EDIT_ACTION,
      editAction: action,
    })
  }
}
```

æ‰€æœ‰ç¼–è¾‘å›¾Øœç‰‡çš„æ“ä½œéƒ½è¦è¡¥å……ä¸Šå‘é€ WebSocket æ¶ˆæ¯ï¼š


```TypeScript
// å‘å·¦æ—‹è½¬const rotateLeft = () => {
  cropperRef.value.rotateLeft()
  editAction(PICTURE_EDIT_ACTION_ENUM.ROTATE_LEFT)
}

// å‘å³æ—‹è½¬const rotateRight = () => {
  cropperRef.value.rotateRight()
  editAction(PICTURE_EDIT_ACTION_ENUM.ROTATE_RIGHT)
}

// ç¼©æ”¾const changeScale = (num: number) => {
  cropperRef.value.changeScale(num)
  if (num > 0) {
    editAction(PICTURE_EDIT_ACTION_ENUM.ZOOM_IN)
  } else {
    editAction(PICTURE_EDIT_ACTION_ENUM.ZOOM_OUT)
  }
}
```

## 4ã€ååŒç¼–è¾‘èŒƒå›´æ§åˆ¶

åªæœ‰å›¢é˜Ÿç©ºØœé—´æ‰æ”¯æŒåä½œç¼–è¾‘ï¼Œå¦åˆ™è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·ï¼Œé»˜è®¤å°±è¿›å…¥å¯ç¼–è¾‘çŠ¶æ€ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `ImageCropper` ç»„ä»¶ä¸­è·å–åˆ°ç©ºé—´ä¿¡æ¯ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦ä¸ºå›¢é˜Ÿç©ºé—´ã€‚

1ï¼‰å¯ä»¥ç”±å¼•å…¥è¯¥ç»„ä»¶çš„çˆ¶é¡µé¢ `AddPicturePage` è·å–ç©ºé—´ä¿¡æ¯ï¼š


```TypeScript
const space = ref<API.SpaceVO>()

// è·å–ç©ºé—´ä¿¡æ¯const fetchSpace = async () => {
  // è·å–æ•°æ®if (spaceId.value) {
    const res = await getSpaceVoByIdUsingGet({
      id: spaceId.value,
    })
    if (res.data.code === 0 && res.data.data) {
      space.value = res.data.data
    }
  }
}

watchEffect(() => {
  fetchSpace()
})
```

ç„¶åä¼ å…¥ç»™ç»„ä»¶ï¼š


```TypeScript
<ImageCropper
  ref="imageCropperRef"
  :imageUrl="picture?.url"
  :picture="picture"
  :spaceId="spaceId"
  :space="space"
  :onSuccess="onSuccess"
/>
```

2ï¼‰åœ¨å›¾ç‰‡ç¼–è¾‘ç»„ä»¶ä¸­æ–°å¢ space å±æ€§ï¼š


```TypeScript
interface Props {
  imageUrl?: string
  picture?: API.PictureVO
  spaceId?: number
  space?: API.SpaceVO
  onSuccess?: (newPicture: API.PictureVO) => void
}
```

ç„¶åå°±å¯ä»¥Øœæ ¹æ® space åˆ¤æ–­æ˜¯å¦ä¸ºå›¢é˜Ÿç©ºé—´äº†ï¼Œå®šä¹‰ä¸€ä¸ªå˜é‡ä¾¿äºå¤ç”¨ï¼šR7zfQ2yjmCwaGmgYTa9cW+7DK0YPbs0kpW2reaJf93o=


```TypeScript
// æ˜¯å¦ä¸ºå›¢é˜Ÿç©ºé—´const isTeamSpace = computed(() => {
  return props.space?.spaceType === SPACE_TYPE_ENUM.TEAM;
})
```

3ï¼‰ä½¿ç”¨è¯¥Øœå˜é‡æ¥æ§åˆ¶ååŒç¼–è¾‘çš„èŒƒå›´ï¼ŒåŒ…æ‹¬æ˜¯å¦å¯ç¼–è¾‘ã€æ˜¯å¦åˆå§‹åŒ– WebSocket è¿æ¥ï¼š


```TypeScript
// å¯ä»¥ç¼–è¾‘const canEdit = computed(() => {
  // ä¸æ˜¯å›¢é˜Ÿç©ºé—´ï¼Œåˆ™é»˜è®¤å¯ç¼–è¾‘if (!isTeamSpace.value) {
    return true
  }
  return editingUser.value?.id === loginUser.id
})

watchEffect(() => {
  // å›¢é˜Ÿç©ºé—´æ‰åˆå§‹åŒ–if (isTeamSpace.value) {
    initWebsocket()
  }
})
```

ä»¥åŠæ˜¯å¦å±•ç¤ºååŒç¼–è¾‘æ“ä½œçš„æŒ‰é’®ï¼š


```PlainText
<!-- ååŒç¼–è¾‘æ“ä½œ -->
<div class="image-edit-actions" v-if="isTeamSpace">
</div>
```



