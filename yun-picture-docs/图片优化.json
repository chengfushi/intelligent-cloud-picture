{"nodes":[{"block_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","block_type":1,"children":["YgWodILAeoQau0xyihHcE3G8nNd","F0wFd5TnwoNakCxsCnvclY1dn1f","I9BmdRDgdomKP7xLKVxchVeTnNh","UFJodxanyoko3qxRJdIcbLKTnTg","XNrSdKEx5oeQcfxtjHpcoKAXnbe","PYbedH39Gogo8PxWudCcxsDknZc","Wdrgdi2gCohgs0xqEi3cYX9YnAd","Ozz3dSym8oQPlxxTNySc9tRBnjb","UjXudJtjdoZb2bxLadvcwgUUnJf","U8DGdQjILosnwJxOrFfc2TaFnMd","VYqFdJpUmokoP5x2WVLctjHEn1g","EugSdErzYooyb1xTbddcHqBYnKc","TiZWddCDXoenB2xJWDBcVFDunAf","EFcudyHMOoDT6YxTgL2ceTNNnxb","P7iudJFzloC0yBxj7T5c1qWUnRh","MGTNdqNS8oihbBxs5TXc6og0nQe","B29ZdptGyoCjHUxrbi5c0miinCh","UeEDdGCngo8xnvxrvG9cUwjNnEb","MP0kdC1GUoA0R9xHErpcSfU5nvc","Qtu7d1bGko2oOkxdJSecwzCnnke","KI77dCRsGoIG4yxqh8VcuKmYn9g","BxXmdkb7eodcdsxRYwwcT4ZenNc","NpI2d26MAobgwSx3bUXc5bQunga","IMfCdCvbRokk2YxFAdRc3eWinMd","W8lEd0e4aoXKpgxw8A0cwlzpnHh","FYJ0dxCSgo4KJcxQPCJcQ74qnWg","QhnmdJ0kCoMOP2xPPWfciZpNnWf","OnRcdvrsEoeLebxxNyhcFpUYn4b","Ld4EdCCaWoW0FKxPPMWch26knmb","Q6RWdDL9QovmdVxqiyjcWan4nxc","KWXddzZqao6jvKx1TRGcijlxneb","HxxDdWVBroXMmLxUnhScuYzInfg","XqT4dx892ouis3xtegDcKkVknJb","Nzjmdv6i5oU8mRx5zd0c5QWlnLb","HyFGdkdA6oOePixgQzSc9Xvjn9c","RAbLdKzrYoI9EQxOwgXcBpilnhh","Xc3cdYBEPo7C1exKSqacWxpynPb","WCz5dBB7Mo5aTqxK8jocLhwen9d","CJK3d1yFYoI55bxc9WschMK1nid","FDrFd51GPoMyU9x7PKscTouynUg","QTMrdKYv5oVN08xYawVcJJcEnqb","J6q3d2NEsoYYHhxEROrck8hVngc","OQJwdJYTLob4TTxqjWQczCy5nhg","D3xydn8hMoYgsgx95CDcoENinwg","UhFMd0ewRo9f7MxZs9gccL91n59","V9UXdj9yOoReyTxTVKrcReMQnlf","MnFdduVGiokZGoxp9nOch69CnNd","AjmIduXBLozsLrxNlzkcEMfGntJ","S8DEdXdy9oPZlsxPcIwchmrcnAd","KahIdNkTpoYO97xUUjEc1IHonje","RXuOdXKQuoOw5zxTE04c2EX1nKe","E1JEdxhUfonFAnxqlOCcSyuCnbg","Hm9edDY1koSIDmxIcjycI1zVn5d","LXEVd4eqHo4XmtxbYJWcLaWBnof","FwWKdnqYmoQstIxjjgzcWILynHf","MZCJdzB1DoHgooxrbLwcD0Hlnvd","I0pzdlsNgozDTwxu6aQcByninxd","AAnTdn2b0o64VbxnmeOcwXsenQf","HORudlqX3omE2Sx5xdlcwZLOnfq","IADodzTW5oIF9xx2s4HcGxwAnHb","RZJOddkI1oAmRNxCpk9cTBoAnFh","CYcddvTRSohHfExNqJecjdlCnPc","NlALd2SGtoUNY9xuKK2cksx3n5b","H7eFdsMhVoZ4BWxz9v0cMxOTn3f","IsIZdx95doFsHMxBZCIcjO8fnjk","ZPNjdIdILoA3zjxic8ucnwzHnGr","QqbAdK5V2o6xepxdnkUcYXWlnyb","VZ7sdJs64oQPJWxzUx8cMBF8nAe","Hjgvd5FasoQNp2x7l71cYAcrn2d","ACaodlzwiorQ5YxWKhicQbiQnDh","QGpLdzB7po8g4PxXbDHcbuysnXJ","JT0ndKVwIoTLjTxfs7Gcyv1snhf","WgvZdNBP3ohiLjx6jL6cNZuzn2d","P0X1dxIseodvmXxpiYSctrDln7p","T0wEdQlXtoEyZIxYXxJc2XCPnyb","OE67dwGNAoT3SKxH7S9c7ixwnuc","VYrJdfz1SoimHYx1Jq5cxYwpnAe","UIVhdak5BoecQjxjSsWc99W2nGb","RSKOdVLHaowzKaxB1Btc1rVpn3q","RYsxddTLKobneIxpKqpcC3gSnZf","WlWcdw5GPoSvvuxhRoOcOfAGnyg","Brg1drQUuovzsExDguEcefPenng","N8epdVhHooSpwaxSd0ncKVohnMf","NSgYd4GI0oemcuxdKLFc3avFnxc","Ktz2dJ63zo3z0gxM4qVctsnsnkb","ZhWZdnWBVo3OESx1UFecZUaTnyk","C5midG9e5o0LC2x4zKWcolGdnfd","YetUdFhL9o9uDIxMhescwQzvnhc","MEsrdxn9nownZdxp0qOc9nMOn5d","KqSDddtikoaeLdxcJsMcqRmtned","ZWfedKPjboWtGSxHeFscGbtmnPI","UHkpdFfhdoGZUpxVy9dcgfLdnvh","Vl7ldo9I4oDkGkxuandchWPhnVg","BKKodSkPSoThUoxZEbzcX0Vrnhf","MVdPdWyR7o8r6XxwgHZcG6Vynof","R3Xidm0WqoMYCPxZIC4cITecnce","Re7WdX6XeoNeVpxXvwlclXuAn1d","EwvQdmKOYouSzlxspvXc8WeAnAe","WMUTd9qadoR8Osx2lhkcFg9FnCY","F5BPdlJkMo8AENx5wARcfoBvnwc","Vk8Dd6HVkoR833xg8Pxc3qC9nBb","C9Z5dSpsUoiFI7xeDx4cxAfLnff","CPtqdHRPEorN2Bxbkxac9ceUnue","SU5mdI3Keo9F5QxdKzbcwFdDnPf","MqvPdiVCNo2q3QxTUT5cmd25nke","Wkm8dlqdQoxZGRx8QgrcwXNPnbf","KuJ4dyZvkoVVuWxjGN1cvnXcnZf","M00HdMxmRohExxxlbX2cJvYLnth","JxH6dIdZDoiMOSxnZ9hczC9qnse","EhcJdTTA9oGlQAxQBy3ckAw8n5M","EBrMd8oGdofmCyxYco9c4aNunuc","SaYYdnnj5oNtrbxo1bEcipOvn7d","EMygdXrmfo7Z9Rxa8IUc0iLmnTg","ZhWkduDNZo4tpRxf5dbcq6Bpn7c","DNKsdayoHoPZ5exFfNBccGcvnsh","QqSodKUxSoygwBxTOKUctNi8nlq","E1eLdWPf4oo5VvxwSJzcjhRCnEg","R0zHdXDLKoCKztxOb8fcR6eBnOg","A3EKdfw4No5NmQxAwtZcO7YknOh","ZeKSddeAQoLWOzxH6yTcODeanbe","DO7mdFHUrooFjgxizWZc15Cxntb","AIKXd99oFoOOpZx8nvecSsmfnIh","ZTJTdbHM8oshQtxsPtecdNC9n3c","DbGmdtD4IovzgSxs1B9cjkQ6ngf","IlAtd0Ey2oULSLx5VpLceTMMngf","JbBgdEESHoLIhwxI7CQcgWjRn1d","REiMdmto3oET2Lxj5y4c2Wqwn3f","TCk4dUwsMoN887xdhAMcDzDRn2f","ZMoLdeCyqouMQUxSgyAcpqT8n4d","UgMMdH2EroRuCNxLzYYcRjB2nJd","Y0MEdlLT6o96BKxUXCackbLwnJg","YF7FdtxQMow4oExIM9zcwkqUn2e","R1s0dlReroVv0ox4JwwcuN40n8f","E9oidXgtuoZkMzxr86ec8gVanhd","CHHEd3PVXoraIcxaRtKcO9zRnmf","P4cId1Th8oCl0FxyTO5cjnuTnjc","XmOPdZYujoH3SexyOkhct1gRn3N","VtKOdJcwxofF8RxK2yEcIzqfnOc","YnLEd9fGYoJ18YxPPazc9XKAncc","ZMoRdOwbyohaGex6zoZceDdZnNc","Q8CldwtPvowQZNxmObTcsST4n5g","StFGdqrvQoWy5Dxqx3VcToqWnHe","GQ8pd0mFloSDe6x15iucNzKDnFe","Ulptd5HvSohY6UxRmDdcs6GInHb","JmqBdUE67opgSrxgFB7c2pbBnie","KMh1d8BZFozADgxQ8VOck3DwnUd","L4j1d3vW7oeQJFxPrYqcKj5In2b","Q7nWdezOToBNvWxmGIEc2Y8MnYf","VaHEdPyhdopfeoxHM1ycfOZOnBe","NjsQd5epuox8D6xZ4pnc0Qb8nZg","H9QKd2xbWoeqLqx1cOycRP3cnnh","DwWtdmnjSo2j5jxmvSAcxMbQnmB","Pr1GdAfDyoGD7Jx7lIncbzfdnSh","Wggxd8iRbouMwlxpvyUcLjkEn0f","RnUMddNrdow81Wxp5wVcpwZbnYf","Tw9qdC4okooVDhx2q9pcLKM8nBf","WF54dspFdoS5t8xln8NcuVbFn1f","CnFKdIHBTo09ruxP87TcmQGknit","LXNvdzOOzo6VhZxQ3JGcgELAnbe","QCMCdNtxWoU3AlxaJiecfegXnmc","DvXpdHQGNobLMnxZI8TcZ7OLnWf","Vbkmd58xmo4ShuxSPh3cWJunnTg","OLz5dtyYgoyu71xBxZRcZ1ilnSc","I8D7dZKnFoowuLxFVGjcmwuknMe","VXxAdYMKgoZSe2x0vxYcAB6kn6c","WQQAd4sxvo4mpjxCxQAcNVe1nNb","MWkxdeeWroMDWyxLpbocT43ontg","KwmadruB9oZG7wx5uhqcB15onCe","HCEXdt19koUmi4x6wSicvmJjnPc","UVNYdsdzxoFklbxk3wZcDyX6n4g","ZK65dg23MouMnHxMEHdcFQkvnvh","AmX3dlWXjo703LxtyrOc8Z6MnRh","HM7wdJOa2oy2HhxZddBcb1gOnkg","ASrXdE5i6oFoVLxKb26c8Ozwn2d","SSrXdslthonhEgx0t0KcmMr6n5b","V7YjdCvZzok2WjxeLHAcyaQFnlg","EP9ndlffwoXRf4x6bDBc9pEnnvb","IMFKd4dpdoF9enxe8YHc0nmbnUd","IdWddoopCo031lxBm9ScSiUgngf","YElRdrrqooMBCIxecCnc8BN3nMg","SUXodPKAzoupxdxMcCJcpFEWnOE","BJ8TddTDKoGBOfxAy7dcVkNenTc","LKErdXnO2o5H52xP7QCcU0dGnYf","V6bQdqxV3ozEZMxp5pXcEhdNnzf","ZX0KdmPUboxkMexvbaicwldInGf","G0x5dVK3xoavbfxIxhncTm1Lngh","ZRuhdnWR8oodYlxdw3tciWo2nie","IDtPdqG3QoSnK0xQtXFch123n6e","CTOMdnObAoWUKFx22EIcJ9gBnIf","U717dzdCQovt44xdBZYcZAHWnom","OAOed1nF8oWv8Xx1JFAc2drcnzh","MqpTdxwRgodostxQBm9cvjK1nyc","ALfSdsQrJoK2YpxQPWxcCOe4nIw","QjjvdIZZCobKeyx1Q0VcA3utndb","B9q0dP3ISoG9zaxPhumcCgXynBf","WqLdddx3Wox1azx7FVHcVcrHnwd","Cs3IdnQASooMLAx8bk2cmv24nm0","OF1Yd6dvwoj54LxcLb3cWgfAnmb","ONhEdgqdwoh2jpxNcWmcfPx9nxh","AiQEd2gTFoPALvxdCrXcayTEnfe","ZwiDdDJZrobKKbxEGfpcfnTXn8g","KXaUdd2zvoh6Txx1j8zc2Ba8nHf","A82idu1C8op0EUxGrz2cnxFin8f","YBJUdEZXSoL7C6xMHwCc1g7MnDx","G7RGdl0JqoBgeOxFkiCcvrAsnab","UDEOdey3NoZGd4x2PBucjnYMnvg","TpajdgoSyo5HEExm9CMcAgcgngh","Q5bJd33q8oAw8wxUtsacCJ4rn1f","I4P5dWTbfoFNoNxdeLLcBKxVnxc","QDlMdqvRho4ULjxO587cv8K0nch","GEHCdeRDfojJNKxbTyScGmXcnQf","IYpldqf7toIPwyxlTV7cH8qWnbe","CBEqdff0UoRztsx6IdZcCKvwnqg","L285d076foihdLx0elhcd51LnSb","MK4Id2FlsoKkC4xOK3pcZsUKnFd","JNXadNUimoPQA5xIZBWcKJQDnEc","XFVUdWjetorRtcxOSFocPhJsnGb","BXQ9dqw3gocNRVxsndQcn5qHnJ4","BTcbdZt46o5XTqxl7ddcLsv0nAc","Vk0GdJojEofI2CxGiQGc8bnKnug","QLEGdGmFooh4Jlx3Walcig3cn3g","KGdRdZ00roSLekxBve6cNNTEnKS","DQ15dfiJioEBJkxvDOUcZ9lfnlg","QUlpdbcVlozTIdxyugFcdtQxnmf","SDatdVrwyob4qPxXnD3cMky3nqh","D6WadQcYFouMYgxrabyccm7YnVh","Z4EjdoQ6XozRUdxwD88ctJ2qn6g","KKpDd50jEox6DIx5HgvctkXBnne","VRHRd6Mp3ovEv1xa5eWc0yYRnFe","Jok2dt7oTotXfexE0hicKke3nBb","SJlwd9yFuoI2WMxzSjjcxZSRn0g","QEM1d6PaMoWr8vxDYVicqdJcnYe","SCcwdGSRpop9vixssI3cc6H3nWf","CUxudLDhHofuCGx6DSAcgBMsn7c","Y578dYtCmoBrAExgYAxcnJPlnHh","P4Qpd0fI2oqEwgxer5AcvNk7nEc","G460dRgp8oYgQfx5J8XchWlAnBM","EwdEdCN0noiibYxdcOZcegnBnKe","VK9oduyZ4ozj6OxTRnxcZo64nec","DSuodNlWLonLanxder0cLkOanjh","K6bhdr2kRo4ZB5xBynLcW9a9nLe","T5oudvxlboH4YAxhIPPchRhqn3e","JNB9dkv6KozeRoxevKKc0Udkn7d","LCCrd1xLUoF7eoxlSBkcT8THn5Q","GogLdgGTBoRycYxUanocat2onmc","RRhjdCb8koyU40xfzZXcwXoOnGg","Ta5xd6rPxoyYvjxE3LNc4p4nnLc","DbuedB8YjozDELxmtZecs4eTnpe","RD3Bdx8QYoGUnYxcbmScB9Vtn2c","Kx6ddxJ7toW6AtxClPNcG5JlnMg","E9XSdgXxvobYPlx0VMlc2AeOnPf","CI2rdC5oWo9I9rxh90BcEJrSn8g","IfkSdDs9joxdvKxBR7CcJ07Unyh","GJFCdSocLoFvvsxqB3zc9Jflnwe","My5OdK984oUcguxJMCdc0Q9Jnqh","ElrpdgB0coQUOQxG2shc3QrRn6b","GuIqdfVqtoFSFfxynIAcJ5E1nzg","Z4VOdu0qloyEvUxkBAycrYbknUA","NTXrdqHdLo9ZwZxvOD2crHgtnSg","XV3ndy9FRol341xubIUcXO37nzf","OtLKdpT9ioCZghxdQXrcUzzEntb","PgpgdsHFtoEuhrxftG1cK0iynoB","XdaSdX2PuoBeszxcmHKcuabOnjh","ZXmkdAs3EouP97xeyJbcHo51nYf","V20ldGHUiorkSQx4dy5cOY2DnQh","SrkedIGOKot5TZxVZZVcRQNbnog","QUuMdbjE5oGcxaxJYM6cuIp0nmk","GC6ZdHEOGorEIAxNYDpcj54dntg","U2bUd04M1ovXZkxlPDqcKCWmnjc","QJuydaRPro2TXUx4NNycfyFJnoc","NlvZdyN4boHUR3xO5HZcNnW1n0f","CdEddhAgBoovVuxLlrgcaSrCnkf","NqBkdaCNwoNXg6xM3kBc3NJbneh","D3nHdJs0ToIyFHxSOJ8c3OELnvf","X7T5dkfiuoypRkxwxQ3cvwVfnOe","E4JydOmacoEC8BxxRIGcuCYVnbb","Gj4jdHr1MoxOkHxKjHZcdO21nfc","OSLHdgZUeoU4MFxrJAUcjnq3ndh","UIt0dBoSCoUo5Kx6XdqcuHMpnid","P1ssdchECofRWexdyJKcz2WInut","YIrgdjJlUosNQXxsYDFco684nvb","Rf5IdHwOTom5S1xV7JMcK2von1f","GbwXdCofNovtqzxbIEacQX9unAa","BUbmdkPvjou9PnxKr9NcseMbnuh","Lz09dvfxPoeH5txLk3nc1w2bnMs","IKfrdFmpGoKBlQxXfZsc6rQFnt1","AEkPdmlwQoHRdDxvtDac91tEnRQ","Ihk1dTycPozI30xWqLkcD8MenZe","RW4Sd0hVeoPS8KxYJJHchqEZn7d"],"page":{"elements":[{"text_run":{"content":"图片优化","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1}},"parent_id":""},{"block_id":"YgWodILAeoQau0xyihHcE3G8nNd","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"在进行下一阶段之前，我们需要对图片的一些功能进行优化，优化的目标主要是：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"查询更块，存储更少","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"。主要分为一下四个部分，近十余中优化策略","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"F0wFd5TnwoNakCxsCnvclY1dn1f","block_type":12,"bullet":{"elements":[{"text_run":{"content":"图片查询优化-分布式缓存、本地缓存、多级缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"I9BmdRDgdomKP7xLKVxchVeTnNh","block_type":12,"bullet":{"elements":[{"text_run":{"content":"图片上传优化-压缩、秒传、分片上传、断点续传","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UFJodxanyoko3qxRJdIcbLKTnTg","block_type":12,"bullet":{"elements":[{"text_run":{"content":"图片加载优化-懒加载、缩略图、CDN加速、浏览器缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"XNrSdKEx5oeQcfxtjHpcoKAXnbe","block_type":12,"bullet":{"elements":[{"text_run":{"content":"图片存储优化-降频存储（冷热数据分离）、清理策略","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"PYbedH39Gogo8PxWudCcxsDknZc","block_type":22,"divider":{},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Wdrgdi2gCohgs0xqEi3cYX9YnAd","block_type":3,"heading1":{"elements":[{"text_run":{"content":"图片查询优化","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Ozz3dSym8oQPlxxTNySc9tRBnjb","block_type":4,"heading2":{"elements":[{"text_run":{"content":"缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UjXudJtjdoZb2bxLadvcwgUUnJf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于经常访问的数据，每次都从数据库（硬盘）中获取是比较慢，可以利用性能更高的存储来提高系统响应速度，俗称","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"缓存","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 。合理使用缓存可以显著降低数据库的压力、提高系统性能。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"U8DGdQjILosnwJxOrFfc2TaFnMd","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"那么，什么样的数据适合缓存呢？一般情况下就4个字“","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"读多写少","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" ”，要频繁查询的、不怎么修改的。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"VYqFdJpUmokoP5x2WVLctjHEn1g","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"具体来说：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"EugSdErzYooyb1xTbddcHqBYnKc","block_type":13,"ordered":{"elements":[{"text_run":{"content":"高频访问的数据：如系统首页、热门推荐内容等。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"TiZWddCDXoenB2xJWDBcVFDunAf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"计算成本较高的数据：如复杂查询结果、大量数据的统计结果。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"EFcudyHMOoDT6YxTgL2ceTNNnxb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"允许短时间延迟的数据：如不需要实时更新的排行榜、图片列表等。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"P7iudJFzloC0yBxj7T5c1qWUnRh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"在我们的项目中，主页是用户高频访问的内容，调用的获取图片列表的接口也是高频访问的。而且即使数据更新存在一定延迟，也不会对用户体验造成明显影响，因此非常适合缓存。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"MGTNdqNS8oihbBxs5TXc6og0nQe","block_type":5,"heading3":{"elements":[{"text_run":{"content":"Redis分布式缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"B29ZdptGyoCjHUxrbi5c0miinCh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"分布式缓存是指将缓存数据分布存储在多台服务器上，以便在高并发场景下提供更高的吞吐量和更好的容错性。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"UeEDdGCngo8xnvxrvG9cUwjNnEb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"Redis是实现分布式缓存的主流方案，也是后端开发必学的技能。主要是由于它具有下面几个优势：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"MP0kdC1GUoA0R9xHErpcSfU5nvc","block_type":12,"bullet":{"elements":[{"text_run":{"content":"高性能:基于内存操作，访问速度极快。单节点 Redis的读写","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"QPS可达10w次每秒！","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Qtu7d1bGko2oOkxdJSecwzCnnke","block_type":12,"bullet":{"elements":[{"text_run":{"content":"丰富的数据结构：支持字符串、列表、集合、哈希、位图等，适用于各种数据结构存储。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"KI77dCRsGoIG4yxqh8VcuKmYn9g","block_type":12,"bullet":{"elements":[{"text_run":{"content":"分布式支持：可以通过RedisCluster构建高可用、高性能的分布式缓存，还提供哨兵集群机制提升可用性、提供分片集群机制提高可扩展性。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"BxXmdkb7eodcdsxRYwwcT4ZenNc","block_type":6,"heading4":{"elements":[{"text_run":{"content":"缓存设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"NpI2d26MAobgwSx3bUXc5bQunga","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"需要缓存首页的图片列表数据，也就是对 listPictureVOByPage接口进行缓存。首先按照缓存3要素\"key、value、过期时间”进行设计。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IMfCdCvbRokk2YxFAdRc3eWinMd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"缓存 key 设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"W8lEd0e4aoXKpgxw8A0cwlzpnHh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"由于接口支持传入不同的查询条件，对应的数据不同，因此需要将查询条件作为缓存key的一部分。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"FYJ0dxCSgo4KJcxQPCJcQ74qnWg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"可以将查询条件对象转换为JSON字符串，但这个JSON会比较长，可以利用哈希算法（md5)来压缩key。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QhnmdJ0kCoMOP2xPPWfciZpNnWf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"此外，由于使用分布式缓存，可能由多个项目和业务共享，因此需要在key的开头拼接前缀进行隔离。设计出的key如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"OnRcdvrsEoeLebxxNyhcFpUYn4b","block_type":14,"code":{"elements":[{"text_run":{"content":"yunpicture:listPictureVOByPage:${查询条件key}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Ld4EdCCaWoW0FKxPPMWch26knmb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"缓存 value 设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Q6RWdDL9QovmdVxqiyjcWan4nxc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"缓存从数据库中查到的Page分页对象，存储为什么格式呢？这里有2种选择：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"KWXddzZqao6jvKx1TRGcijlxneb","block_type":12,"bullet":{"elements":[{"text_run":{"content":"为了可读性，可以转换为JSON结构的字符串","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"HxxDdWVBroXMmLxUnhScuYzInfg","block_type":12,"bullet":{"elements":[{"text_run":{"content":"为了压缩空间，可以存为二进制等其他结构","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"XqT4dx892ouis3xtegDcKkVknJb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"但是对应的 Redis 数据结构都是 string。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Nzjmdv6i5oU8mRx5zd0c5QWlnLb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"缓存过期时间设置","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"HyFGdkdA6oOePixgQzSc9Xvjn9c","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"必须设置缓存过期时间！","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 根据实际业务场景和缓存空间的大小、数据的一致性的要求设置，合适即可，此处由于查询条件较多、而且考虑到图片会持续更新，设置为5~60分钟即可。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"RAbLdKzrYoI9EQxOwgXcBpilnhh","block_type":6,"heading4":{"elements":[{"text_run":{"content":"如何操作Redis？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Xc3cdYBEPo7C1exKSqacWxpynPb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"Java中有非常多的 Redis 操作库，比如 Jedis、Lettuce 等。为了便于和 Spring 项目集成，Spring 还提供了 Spring Data Redis作为操作Redis的更高层抽象（默认使用Lettuce作为底层客户端)。由于我们的项目使用Spring Boot，也推荐使用","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"Spring Data Redis","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fspring.io%2Fprojects%2Fspring-data-redis%2F"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"，开发成本更低。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"WCz5dBB7Mo5aTqxK8jocLhwen9d","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"它的使用也非常简单，我们直接上手项目实战。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"CJK3d1yFYoI55bxc9WschMK1nid","block_type":13,"ordered":{"elements":[{"text_run":{"content":"引入redis的maven依赖","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"FDrFd51GPoMyU9x7PKscTouynUg","block_type":14,"code":{"elements":[{"text_run":{"content":"<!-- Redis -->\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-data-redis</artifactId>\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</dependency>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"QTMrdKYv5oVN08xYawVcJJcEnqb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"在配置文件中引入redis：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"J6q3d2NEsoYYHhxEROrck8hVngc","block_type":14,"code":{"elements":[{"text_run":{"content":"spring:\n  # Redis 配置\n  redis:\n    database: 0\n    host: 127.0.0.1\n    port: 6379\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"    timeout: 5000","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":67,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"OQJwdJYTLob4TTxqjWQczCy5nhg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"编写操作Redis的代码：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"D3xydn8hMoYgsgx95CDcoENinwg","block_type":14,"code":{"elements":[{"text_run":{"content":"@PostMapping(\"/list/page/vo/cache\")\npublic BaseResponse<Page<PictureVO>> listPictureVOByPageWithCache(@RequestBody PictureQueryRequest pictureQueryRequest,\n                                                         HttpServletRequest request) {\n    long current = pictureQueryRequest.getCurrent();\n    long size = pictureQueryRequest.getPageSize();\n    // 限制爬虫\n    ThrowUtils.throwIf(size > 20, ErrorCode.PARAMS_ERROR);\n    // 普通用户默认只能查看已过审的数据\n    pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());\n\n    // 构建缓存 key\n    String queryCondition = JSONUtil.toJsonStr(pictureQueryRequest);\n    String hashKey = DigestUtils.md5DigestAsHex(queryCondition.getBytes());\n    String redisKey = \"yupicture:listPictureVOByPage:\" + hashKey;\n    // 从 Redis 缓存中查询\n    ValueOperations<String, String> valueOps = stringRedisTemplate.opsForValue();\n    String cachedValue = valueOps.get(redisKey);\n    if (cachedValue != null) {\n        // 如果缓存命中，返回结果\n        Page<PictureVO> cachedPage = JSONUtil.toBean(cachedValue, Page.class);\n        return ResultUtils.success(cachedPage);\n    }\n\n    // 查询数据库\n    Page<Picture> picturePage = pictureService.page(new Page<>(current, size),\n            pictureService.getQueryWrapper(pictureQueryRequest));\n    // 获取封装类\n    Page<PictureVO> pictureVOPage = pictureService.getPictureVOPage(picturePage, request);\n\n    // 存入 Redis 缓存\n    String cacheValue = JSONUtil.toJsonStr(pictureVOPage);\n    // 5 - 10 分钟随机过期，防止雪崩\n    int cacheExpireTime = 300 +  RandomUtil.randomInt(0, 300);\n    valueOps.set(redisKey, cacheValue, cacheExpireTime, TimeUnit.SECONDS);\n\n    // 返回结果\n    return ResultUtils.success(pictureVOPage);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":63,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UhFMd0ewRo9f7MxZs9gccL91n59","block_type":5,"heading3":{"elements":[{"text_run":{"content":"Caffeine 本地缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"V9UXdj9yOoReyTxTVKrcReMQnlf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"当应用需要频繁访问某些数据时，可以将这些数据缓存到应用的内存中（比如JVM中）；下次访问时，直接从内存读取，而不需要经过网络或其他存储系统。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"MnFdduVGiokZGoxp9nOch69CnNd","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"相比于分布式缓存，本地缓存的速度更快，但是无法在多个服务器间共享数据、而且不方便扩容。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"AjmIduXBLozsLrxNlzkcEMfGntJ","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"所以本地缓存的应用场景一般是：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"S8DEdXdy9oPZlsxPcIwchmrcnAd","block_type":12,"bullet":{"elements":[{"text_run":{"content":"数据访问量有限的小型数据集","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"KahIdNkTpoYO97xUUjEc1IHonje","block_type":12,"bullet":{"elements":[{"text_run":{"content":"不需要服务器间共享数据的单机应用","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"RXuOdXKQuoOw5zxTE04c2EX1nKe","block_type":12,"bullet":{"elements":[{"text_run":{"content":"高频、低延迟的访问场景（如用户临时会话信息、短期热点数据）。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"E1JEdxhUfonFAnxqlOCcSyuCnbg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于Java项目，Caffeine是主流的本地缓存技术，拥有极高的性能和丰富的功能。比如可以精确控制缓存数量和大小、支持缓存过期、支持多种缓存淘汰策略、支持异步操作、线程安全等。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Hm9edDY1koSIDmxIcjycI1zVn5d","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"由于本地缓存不需要引入额外的中间件，成本更低。因此如果只是要提升数据访问性能，优先考虑本地缓存而不是分布式缓存。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"LXEVd4eqHo4XmtxbYJWcLaWBnof","block_type":6,"heading4":{"elements":[{"text_run":{"content":"缓存设计","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"FwWKdnqYmoQstIxjjgzcWILynHf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"本地缓存的设计和分布式缓存基本一致，不再赞述。但有2个区别：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"MZCJdzB1DoHgooxrbLwcD0Hlnvd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"本地缓存需要自己创建初始化缓存结构（可以简单理解为要自己new一个HashMap)。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"I0pzdlsNgozDTwxu6aQcByninxd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"由于本地缓存本身就是服务器隔离的，而且占用服务器的内存，key可以更精简一些，不用再添加项目前缀。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"AAnTdn2b0o64VbxnmeOcwXsenQf","block_type":6,"heading4":{"elements":[{"text_run":{"content":"后端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"HORudlqX3omE2Sx5xdlcwZLOnfq","block_type":13,"ordered":{"elements":[{"text_run":{"content":"参考","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"官方文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fgithub.com%2Fben-manes%2Fcaffeine"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"引入Caffeine 的Maven依赖，注意如果要引入3.x版本的Caffeine，Java版本必须>= 11！如果不想升级JDK，也可以改为引入2x版本","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"IADodzTW5oIF9xx2s4HcGxwAnHb","block_type":14,"code":{"elements":[{"text_run":{"content":"<!-- 本地缓存 Caffeine -->\n<dependency>\n  <groupId>com.github.ben-manes.caffeine</groupId>\n  <artifactId>caffeine</artifactId>\n  <version>3.1.8</version>\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</dependency>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"RZJOddkI1oAmRNxCpk9cTBoAnFh","block_type":13,"ordered":{"elements":[{"text_run":{"content":"构造本地缓存，设置缓存容量和过期时间","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"CYcddvTRSohHfExNqJecjdlCnPc","block_type":14,"code":{"elements":[{"text_run":{"content":"private final Cache<String, String> LOCAL_CACHE =\n        Caffeine.newBuilder().initialCapacity(1024)\n                .maximumSize(10000L)\n                // 缓存 5 分钟移除\n                .expireAfterWrite(5L, TimeUnit.MINUTES)\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"                .build();","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"NlALd2SGtoUNY9xuKK2cksx3n5b","block_type":13,"ordered":{"elements":[{"text_run":{"content":"参考之前使用分布式缓存的代码，修改为使用本地缓存。在查询数据库前先查询本地缓存，如果已有数据则直接返回缓存：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"H7eFdsMhVoZ4BWxz9v0cMxOTn3f","block_type":14,"code":{"elements":[{"text_run":{"content":"// 构建缓存 key\nString queryCondition = JSONUtil.toJsonStr(pictureQueryRequest);\nString hashKey = DigestUtils.md5DigestAsHex(queryCondition.getBytes());\nString cacheKey = \"listPictureVOByPage:\" + hashKey;\n// 从本地缓存中查询\nString cachedValue = LOCAL_CACHE.getIfPresent(cacheKey);\nif (cachedValue != null) {\n    // 如果缓存命中，返回结果\n    Page<PictureVO> cachedPage = JSONUtil.toBean(cachedValue, Page.class);\n    return ResultUtils.success(cachedPage);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":30,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"IsIZdx95doFsHMxBZCIcjO8fnjk","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"如果每有数据则查询数据库，将结果放到本地缓存中","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZPNjdIdILoA3zjxic8ucnwzHnGr","block_type":14,"code":{"elements":[{"text_run":{"content":"// 查询数据库\nPage<Picture> picturePage = pictureService.page(new Page<>(current, size),\n        pictureService.getQueryWrapper(pictureQueryRequest));\n// 获取封装类\nPage<PictureVO> pictureVOPage = pictureService.getPictureVOPage(picturePage, request);\n\n// 存入本地缓存\nString cacheValue = JSONUtil.toJsonStr(pictureVOPage);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"LOCAL_CACHE.put(cacheKey, cacheValue);","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"QqbAdK5V2o6xepxdnkUcYXWlnyb","block_type":5,"heading3":{"elements":[{"text_run":{"content":"多级缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"VZ7sdJs64oQPJWxzUx8cMBF8nAe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"多级缓存是指结合本地缓存和分布式缓存的优点，在同一业务场景下构建两级缓存系统，这样可以兼顾本地缓存的高性能、以及分布式缓存的数据一致性和可靠性。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Hjgvd5FasoQNp2x7l71cYAcrn2d","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"多级缓存的工作流程：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ACaodlzwiorQ5YxWKhicQbiQnDh","block_type":13,"ordered":{"elements":[{"text_run":{"content":"第一级（Caffeine本地缓存)：优先从本地缓存中读取数据。如果命中，则直接返回。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"QGpLdzB7po8g4PxXbDHcbuysnXJ","block_type":13,"ordered":{"elements":[{"text_run":{"content":"第二级(Redis分布式缓存)：如果本地缓存未命中，则查询Redis分布式缓存。如果Redis命中，则返回数据并更新本地缓存。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"JT0ndKVwIoTLjTxfs7Gcyv1snhf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"数据库查询：如果Redis也未命中，则查询数据库，并将结果写入Redis和本地缓存。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"WgvZdNBP3ohiLjx6jL6cNZuzn2d","block_type":27,"image":{"align":2,"height":762,"token":"G4zJbKpeooAU7nxNajiciE5enae","width":1204},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"P0X1dxIseodvmXxpiYSctrDln7p","block_type":6,"heading4":{"elements":[{"text_run":{"content":"后端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"T0wEdQlXtoEyZIxYXxJc2XCPnyb","block_type":13,"ordered":{"elements":[{"text_run":{"content":"优先从本地缓存中读取数据","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"OE67dwGNAoT3SKxH7S9c7ixwnuc","block_type":14,"code":{"elements":[{"text_run":{"content":"// 构建缓存 key\nString queryCondition = JSONUtil.toJsonStr(pictureQueryRequest);\nString hashKey = DigestUtils.md5DigestAsHex(queryCondition.getBytes());\nString cacheKey = \"yupicture:listPictureVOByPage:\" + hashKey;\n\n// 1. 查询本地缓存（Caffeine）\nString cachedValue = LOCAL_CACHE.getIfPresent(cacheKey);\nif (cachedValue != null) {\n    Page<PictureVO> cachedPage = JSONUtil.toBean(cachedValue, Page.class);\n    return ResultUtils.success(cachedPage);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":30,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"VYrJdfz1SoimHYx1Jq5cxYwpnAe","block_type":13,"ordered":{"elements":[{"text_run":{"content":"本地缓存没有，从redis中获取数据，如果redis有本地缓存没有，将数据存入本地缓存返回","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UIVhdak5BoecQjxjSsWc99W2nGb","block_type":14,"code":{"elements":[{"text_run":{"content":"// 2. 查询分布式缓存（Redis）\nValueOperations<String, String> valueOps = stringRedisTemplate.opsForValue();\ncachedValue = valueOps.get(cacheKey);\nif (cachedValue != null) {\n    // 如果命中 Redis，存入本地缓存并返回\n    LOCAL_CACHE.put(cacheKey, cachedValue);\n    Page<PictureVO> cachedPage = JSONUtil.toBean(cachedValue, Page.class);\n    return ResultUtils.success(cachedPage);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":30,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"RSKOdVLHaowzKaxB1Btc1rVpn3q","block_type":13,"ordered":{"elements":[{"text_run":{"content":"redis没有，从数据库中获取数据，如果数据库有redis没有，将数据存入redis返回","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"RYsxddTLKobneIxpKqpcC3gSnZf","block_type":14,"code":{"elements":[{"text_run":{"content":"// 3. 查询数据库\nPage<Picture> picturePage = pictureService.page(new Page<>(current, size),\n        pictureService.getQueryWrapper(pictureQueryRequest));\nPage<PictureVO> pictureVOPage = pictureService.getPictureVOPage(picturePage, request);\n\n// 4. 更新缓存\nString cacheValue = JSONUtil.toJsonStr(pictureVOPage);\n// 更新本地缓存\nLOCAL_CACHE.put(cacheKey, cacheValue);\n// 更新 Redis 缓存，设置过期时间为 5 分钟\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"valueOps.set(cacheKey, cacheValue, 5, TimeUnit.MINUTES);","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":30,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"WlWcdw5GPoSvvuxhRoOcOfAGnyg","block_type":5,"heading3":{"elements":[{"text_run":{"content":"扩展","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Brg1drQUuovzsExDguEcefPenng","block_type":6,"heading4":{"elements":[{"text_run":{"content":"手动刷新缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"N8epdVhHooSpwaxSd0ncKVohnMf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"在某些情况下，数据更新较为频繁，但自动刷新缓存机制可能存在延迟，可以通过手动刷新来解决。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"NSgYd4GI0oemcuxdKLFc3avFnxc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"比如:","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Ktz2dJ63zo3z0gxM4qVctsnsnkb","block_type":12,"bullet":{"elements":[{"text_run":{"content":"提供一个刷新缓存的接口，仅管理员可调用。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"ZhWZdnWBVo3OESx1UFecZUaTnyk","block_type":12,"bullet":{"elements":[{"text_run":{"content":"提供管理后台，支持管理员手动刷新指定缓存。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"C5midG9e5o0LC2x4zKWcolGdnfd","block_type":6,"heading4":{"elements":[{"text_run":{"content":"解决缓存常见问题","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"YetUdFhL9o9uDIxMhescwQzvnhc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"使用缓存时，一般要注意下面几个问题：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"MEsrdxn9nownZdxp0qOc9nMOn5d","block_type":13,"ordered":{"elements":[{"text_run":{"content":"缓存击穿：某些热点数据在缓存过期后，大量请求直接打到数据库。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"KqSDddtikoaeLdxcJsMcqRmtned","block_type":34,"children":["WGd9dLMUToRstxxTOQYciwGcnbf"],"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","quote_container":{}},{"block_id":"WGd9dLMUToRstxxTOQYciwGcnbf","block_type":2,"parent_id":"KqSDddtikoaeLdxcJsMcqRmtned","text":{"elements":[{"text_run":{"content":"解决方案：设置热点数据的超长过期时间，或使用互斥锁（如Redisson）控制缓存刷新。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZWfedKPjboWtGSxHeFscGbtmnPI","block_type":13,"ordered":{"elements":[{"text_run":{"content":"缓存穿透：用户频繁请求不存在的数据，导致大量的请求直接触发数据库查询。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UHkpdFfhdoGZUpxVy9dcgfLdnvh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"解决方案：对无效查询结果也进行缓存（如设置空值缓存），或者使用布隆过滤器。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Vl7ldo9I4oDkGkxuandchWPhnVg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"缓存雪崩：大量缓存同时过期，导致请求打到数据库，系统崩溃。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"BKKodSkPSoThUoxZEbzcX0Vrnhf","block_type":34,"children":["OWnqdGTr9oxHqBxBy2dcjOxinnT"],"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","quote_container":{}},{"block_id":"OWnqdGTr9oxHqBxBy2dcjOxinnT","block_type":2,"parent_id":"BKKodSkPSoThUoxZEbzcX0Vrnhf","text":{"elements":[{"text_run":{"content":"解决方案：设置不同缓存的过期时间，避免同时过期；或者使用多级缓存，减少对数据库的依赖。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"MVdPdWyR7o8r6XxwgHZcG6Vynof","block_type":6,"heading4":{"elements":[{"text_run":{"content":"自动识别热点图片缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"R3Xidm0WqoMYCPxZIC4cITecnce","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"可以采用热key探测技术，实时对图片的访问量进行统计，并自动将热点图片添加到内存缓存，以应对大量高频的访问。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Re7WdX6XeoNeVpxXvwlclXuAn1d","block_type":6,"heading4":{"elements":[{"text_run":{"content":"查询优化","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"EwvQdmKOYouSzlxspvXc8WeAnAe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"可以参考数据库优化技巧，比如获取图片列表时只查询（select）必要的字段，返回给前端时也只返回必要的字段等。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"WMUTd9qadoR8Osx2lhkcFg9FnCY","block_type":6,"heading4":{"elements":[{"text_run":{"content":"代码优化","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"F5BPdlJkMo8AENx5wARcfoBvnwc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"如果操作缓存的逻辑更复杂，可以单独抽象CacheManager统一管理缓存相关操作。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Vk8Dd6HVkoR833xg8Pxc3qC9nBb","block_type":4,"heading2":{"elements":[{"text_run":{"content":"图片上传优化","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"C9Z5dSpsUoiFI7xeDx4cxAfLnff","block_type":5,"heading3":{"elements":[{"text_run":{"content":"图片压缩","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"CPtqdHRPEorN2Bxbkxac9ceUnue","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于图库网站来؜说，图片压缩是图片优化中最基本且最重要的操作，能够显著减少图片文件的大小，从而降低带宽使用和流量消耗，大幅降低成本的同时，提高图片加载速度。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SU5mdI3Keo9F5QxdKzbcwFdDnPf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"有哪些压缩图片的方法呢？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"MqvPdiVCNo2q3QxTUT5cmd25nke","block_type":13,"ordered":{"elements":[{"text_run":{"content":"将图片格式转换为体积更小的格式，比如 WebP 或其他现代格式","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Wkm8dlqdQoxZGRx8QgrcwXNPnbf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"对图片质量进行压缩","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"KuJ4dyZvkoVVuWxjGN1cvnXcnZf","block_type":13,"ordered":{"elements":[{"text_run":{"content":"缩小图片尺寸","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"M00HdMxmRohExxxlbX2cJvYLnth","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"当然对于图؜片网站来说，我们希望尽可能不要影响图片的质量，因此更推荐第 1 种方法","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"JxH6dIdZDoiMOSxnZ9hczC9qnse","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"那么将图片压缩成什么格式？如何对图片进行压缩呢？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"EhcJdTTA9oGlQAxQBy3ckAw8n5M","block_type":6,"heading4":{"elements":[{"text_run":{"content":"图片压缩格式","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"EBrMd8oGdofmCyxYco9c4aNunuc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"格式上，有 2 种选择：PVHq6NW9Nt5fXkQO/a1pmCEpMMQkmAtku92aHSjiX4c=","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SaYYdnnj5oNtrbxo1bEcipOvn7d","block_type":13,"children":["VFardITdRoAy4ZxA3JAch4tNnLf","ZsNOdZKZqoSaDRx7eancwKhZnNh","HewZd8Ty9oFKFixLWbKcpUCMngg","I0lKdfwk5o0BIzx7vn4cHvDgnwf"],"ordered":{"elements":[{"text_run":{"content":"Web؜P：由 Google 开发的现代图片格式，支持有损和无损压缩。相比传统格式：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"VFardITdRoAy4ZxA3JAch4tNnLf","block_type":12,"bullet":{"elements":[{"text_run":{"content":"比 PNG 文件小约 26%。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"SaYYdnnj5oNtrbxo1bEcipOvn7d"},{"block_id":"ZsNOdZKZqoSaDRx7eancwKhZnNh","block_type":12,"bullet":{"elements":[{"text_run":{"content":"比 JPEG 文件小约 25%-34%。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"SaYYdnnj5oNtrbxo1bEcipOvn7d"},{"block_id":"HewZd8Ty9oFKFixLWbKcpUCMngg","block_type":12,"bullet":{"elements":[{"text_run":{"content":"支持透明背景（Alpha 通道）。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"SaYYdnnj5oNtrbxo1bEcipOvn7d"},{"block_id":"I0lKdfwk5o0BIzx7vn4cHvDgnwf","block_type":12,"bullet":{"elements":[{"text_run":{"content":"兼容性：大部分主流浏览器（如 Chrome、Edge、Firefox 等）均已支持 WebP。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"SaYYdnnj5oNtrbxo1bEcipOvn7d"},{"block_id":"EMygdXrmfo7Z9Rxa8IUc0iLmnTg","block_type":13,"children":["Y0sZdWTCNoZOnix9wK8cNCxQnLb","LKZ2dPo32o6GsdxJ7iScaQFTnuf"],"ordered":{"elements":[{"text_run":{"content":"AVI؜F：基于 AV1 视频编码技术的图片格式，压缩率更高。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Y0sZdWTCNoZOnix9wK8cNCxQnLb","block_type":12,"bullet":{"elements":[{"text_run":{"content":"比 WebP 的文件大小更小，画质更优。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"EMygdXrmfo7Z9Rxa8IUc0iLmnTg"},{"block_id":"LKZ2dPo32o6GsdxJ7iScaQFTnuf","block_type":12,"bullet":{"elements":[{"text_run":{"content":"支持透明背景和高动态范围（HDR）。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"EMygdXrmfo7Z9Rxa8IUc0iLmnTg"},{"block_id":"ZhWkduDNZo4tpRxf5dbcq6Bpn7c","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"虽然 AVIF 看起来更牛，但目前其兼容性没有 WebP 要好，为了保证图片在不同浏览器都能正常加载，建议选择 WebP 格式。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"DNKsdayoHoPZ5exFfNBccGcvnsh","block_type":6,"heading4":{"elements":[{"text_run":{"content":"图片压缩方案","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"QqSodKUxSoygwBxTOKUctNi8nlq","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"跟解析图片؜的操作一样，可以使用本地的图像处理类库自行操作，也可以利用第三方云服务完成。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"E1eLdWPf4oo5VvxwSJzcjhRCnEg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"因为我们图片已؜经上传到了腾讯云 COS 对象存储服务，可以直接利用数据万象服务。通过配置图片处理规则，在图片上传的同时自动进行压缩处理，减少开发成本。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"R0zHdXDLKoCKztxOb8fcR6eBnOg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"如何利用数据万象对图片进行压缩呢？官方提供了 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"最佳实践文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F460%2F72229"},"strikethrough":false,"underline":false}}},{"text_run":{"content":" ，主要有 2 种压缩方式：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"A3EKdfw4No5NmQxAwtZcO7YknOh","block_type":13,"ordered":{"elements":[{"text_run":{"content":"访问图片时实时压缩","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"ZeKSddeAQoLWOzxH6yTcODeanbe","block_type":13,"ordered":{"elements":[{"text_run":{"content":"上传图片时实时压缩，","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"参考文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F54050%23.E4.B8.8A.E4.BC.A0.E6.97.B6.E5.A4.84.E7.90.86"},"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"DO7mdFHUrooFjgxizWZc15Cxntb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"其实还有第三种方式，也可以对已上传的图片进行压缩处理，","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"参考文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F54050%23.E4.BA.91.E4.B8.8A.E6.95.B0.E6.8D.AE.E5.A4.84.E7.90.86"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"AIKXd99oFoOOpZx8nvecSsmfnIh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于我们的需求，要将图片格式转化为 WebP，可以 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"参考官方文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F44883"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"，在上传文件时，传入 Rules 规则。使用 HTTP API 调用时，传入处理规则参数：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZTJTdbHM8oshQtxsPtecdNC9n3c","block_type":27,"image":{"align":2,"height":318,"token":"WQXqbJaUToTpTnxG7FucQtbTnbb","width":973},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"DbGmdtD4IovzgSxs1B9cjkQ6ngf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"如果使用 SDK，就需要构造图片处理规则对象，","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"参考文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F55377%23.E4.B8.8A.E4.BC.A0.E6.97.B6.E5.9B.BE.E7.89.87.E6.8C.81.E4.B9.85.E5.8C.96.E5.A4.84.E7.90.86"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IlAtd0Ey2oULSLx5VpLceTMMngf","block_type":6,"heading4":{"elements":[{"text_run":{"content":"后端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"JbBgdEESHoLIhwxI7CQcgWjRn1d","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"为了实现方؜便，我们此处仅对文件格式进行转化，不进行质量变换之类的其他处理。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"REiMdmto3oET2Lxj5y4c2Wqwn3f","block_type":13,"ordered":{"elements":[{"text_run":{"content":"修改 ؜CosManager 上传图片的方法，将图片后缀转为 webp，并且使用数据万象将图片格式转为 webp","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"TCk4dUwsMoN887xdhAMcDzDRn2f","block_type":14,"code":{"elements":[{"text_run":{"content":"public PutObjectResult putPictureObject(String key, File file) {\n    PutObjectRequest putObjectRequest = new PutObjectRequest(cosClientConfig.getBucket(), key,\n            file);\n    // 对图片进行处理（获取基本信息也被视作为一种处理）PicOperations picOperations = new PicOperations();\n    // 1 表示返回原图信息\n    picOperations.setIsPicInfo(1);\n    List<PicOperations.Rule> rules = new ArrayList<>();\n    // 图片压缩（转成 webp 格式）String webpKey = FileUtil.mainName(key) + \".webp\";\n    PicOperations.Rule compressRule = new PicOperations.Rule();\n    compressRule.setRule(\"imageMogr2/format/webp\");\n    compressRule.setBucket(cosClientConfig.getBucket());\n    compressRule.setFileId(webpKey);\n    rules.add(compressRule);\n    // 构造处理参数\n    picOperations.setRules(rules);\n    putObjectRequest.setPicOperations(picOperations);\n    return cosClient.putObject(putObjectRequest);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"ZMoLdeCyqouMQUxSgyAcpqT8n4d","block_type":13,"ordered":{"elements":[{"text_run":{"content":"修改 P؜ictureUploadTemplate 上传图片的方法，从图片处理结果中获取到缩略图，并设置到返回结果中：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UgMMdH2EroRuCNxLzYYcRjB2nJd","block_type":14,"code":{"elements":[{"text_run":{"content":"\ntry {\n    // 创建临时文件\n    file = File.createTempFile(uploadPath, null);\n    // 处理文件来源（本地或 URL）\n    processFile(inputSource, file);\n    // 上传图片到对象存储PutObjectResult putObjectResult = cosManager.putPictureObject(uploadPath, file);\n    ImageInfo imageInfo = putObjectResult.getCiUploadResult().getOriginalInfo().getImageInfo();\n    ProcessResults processResults = putObjectResult.getCiUploadResult().getProcessResults();\n    List<CIObject> objectList = processResults.getObjectList();\n    if (CollUtil.isNotEmpty(objectList)) {\n        CIObject compressedCiObject = objectList.get(0);\n        // 封装压缩图返回结果return buildResult(originFilename, compressedCiObject);\n    }\n    // 封装原图返回结果return buildResult(originFilename, file, uploadPath, imageInfo);\n} catch (Exception e) {\n    log.error(\"图片上传到对象存储失败\", e);\n    throw new BusinessException(ErrorCode.SYSTEM_ERROR, \"上传失败\");\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Y0MEdlLT6o96BKxUXCackbLwnJg","block_type":13,"ordered":{"elements":[{"text_run":{"content":"编写新的封装返回结果方法，从压缩图中获取图片信息：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"YF7FdtxQMow4oExIM9zcwkqUn2e","block_type":14,"code":{"elements":[{"text_run":{"content":"▼\nprivate UploadPictureResult buildResult(String originFilename, CIObject compressedCiObject) {\n    UploadPictureResult uploadPictureResult = new UploadPictureResult();\n    int picWidth = compressedCiObject.getWidth();\n    int picHeight = compressedCiObject.getHeight();\n    double picScale = NumberUtil.round(picWidth * 1.0 / picHeight, 2).doubleValue();\n    uploadPictureResult.setPicName(FileUtil.mainName(originFilename));\n    uploadPictureResult.setPicWidth(picWidth);\n    uploadPictureResult.setPicHeight(picHeight);\n    uploadPictureResult.setPicScale(picScale);\n    uploadPictureResult.setPicFormat(compressedCiObject.getFormat());\n    uploadPictureResult.setPicSize(compressedCiObject.getSize().longValue());\n    // 设置图片为压缩后的地址\n    uploadPictureResult.setUrl(cosClientConfig.getHost() + \"/\" + compressedCiObject.getKey());\n    return uploadPictureResult;\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"R1s0dlReroVv0ox4JwwcuN40n8f","block_type":6,"heading4":{"elements":[{"text_run":{"content":"扩展","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"E9oidXgtuoZkMzxr86ec8gVanhd","block_type":13,"ordered":{"elements":[{"text_run":{"content":"增加对原图的处理","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"CHHEd3PVXoraIcxaRtKcO9zRnmf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"目前每次上传图片؜实际上会保存原图和压缩图 2 个图片，原图占用的空间还是比较大的。如果想进一步优化，可以删除原图，只保留缩略图；或者在数据库中保存原图的地址，用作备份。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"P4cId1Th8oCl0FxyTO5cjnuTnjc","block_type":13,"ordered":{"elements":[{"text_run":{"content":"尝试更大比例的压缩，比如使用 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"质量变换","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F44884"},"strikethrough":false,"underline":false}}},{"text_run":{"content":" 来处理图片。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"XmOPdZYujoH3SexyOkhct1gRn3N","block_type":5,"heading3":{"elements":[{"text_run":{"content":"扩展知识 - 文件秒传","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"VtKOdJcwxofF8RxK2yEcIzqfnOc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"由于文件秒؜传对于图片上传场景的作用有限，仅作为扩展知识学习即可，不必在本项目中实现。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"YnLEd9fGYoJ18YxPPazc9XKAncc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"文件秒传是一种基؜于文件的唯一标识（如 MD5、SHA-256）对文件内容进行快速校验，避免重复上传的方法，在大型文件传输场景下非常重要。可以提高性能、节约带宽和存储资源。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZMoRdOwbyohaGex6zoZceDdZnNc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"大家可能用؜过 XX 网盘软件，如果重复上传相同的文件 2 次，你会发现第二次的上传速度贼快.","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Q8CldwtPvowQZNxmObTcsST4n5g","block_type":6,"heading4":{"elements":[{"text_run":{"content":"文件秒传的实现方案","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"StFGdqrvQoWy5Dxqx3VcToqWnHe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"文件秒传的实现并不复杂，流程如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"GQ8pd0mFloSDe6x15iucNzKDnFe","block_type":13,"ordered":{"elements":[{"text_run":{"content":"客户端؜生成文件唯一标识：上传前，通过客户端计算文件的哈希值（如 MD5、SHA-256），生成文件的唯一指纹","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Ulptd5HvSohY6UxRmDdcs6GInHb","block_type":13,"children":["UvNrd7VAyodhs8xj3z3cS5D6n0b","BV0ldxT2LoOx6pxzY8pcd6sknwh"],"ordered":{"elements":[{"text_run":{"content":"服务端؜校验文件指纹：后端接收到文件指纹后，在存储中查询是否已存在相同文件。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UvNrd7VAyodhs8xj3z3cS5D6n0b","block_type":12,"bullet":{"elements":[{"text_run":{"content":"若存在相同文件，则直接返回文件的存储路径。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"Ulptd5HvSohY6UxRmDdcs6GInHb"},{"block_id":"BV0ldxT2LoOx6pxzY8pcd6sknwh","block_type":12,"bullet":{"elements":[{"text_run":{"content":"若不存在相同文件，则接收并存储新文件，同时记录其指纹信息。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"Ulptd5HvSohY6UxRmDdcs6GInHb"},{"block_id":"JmqBdUE67opgSrxgFB7c2pbBnie","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"注意，客户端؜和服务端是相对的概念。因为现在我们要把文件上传到对象存储服务器，我们的后端此时就是“客户端”，对象存储服务器才是 “服务端”。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"KMh1d8BZFozADgxQ8VOck3DwnUd","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于我们的؜项目，给图片表增加 md5 字段用于存储文件指纹，上传图片前增加类似的逻辑判断即可：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"L4j1d3vW7oeQJFxPrYqcKj5In2b","block_type":14,"code":{"elements":[{"text_run":{"content":"▼\n// 计算文件指纹String md5 = SecureUtil.md5(file);\n// 从数据库中查询已有的文件\nList<Picture> pictureList = pictureService.lambdaQuery()\n        .eq(Picture::getMd5, md5)\n        .list();\n// 文件已存在，秒传if (CollUtil.isNotEmpty(pictureList)) {\n    // 直接复用已有文件的信息，不必重复上传文件Picture existPicture = pictureList.get(0);\n} else {\n    // 文件不存在，实际上传逻辑\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Q7nWdezOToBNvWxmGIEc2Y8MnYf","block_type":6,"heading4":{"elements":[{"text_run":{"content":"实际使用中的限制","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"VaHEdPyhdopfeoxHM1ycfOZOnBe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"我们目前的项目其实不适合使用文件秒传؜。一方面是对于图片场景，文件比较小、重复文件也相对较少，秒传的优化效果有限；另外一方面是本项目使用腾讯云 COS 的对象存储，只能通过唯一地址去取文件，无法完全自定义文件的存储结构、也不支持文件快捷方式的概念，因此秒传的文件地址必须使用和原文件相同的对象路径，可能导致其他的问题（比如用户 A 上传的图片地址等同于用户 B 上传的地址）。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"NjsQd5epuox8D6xZ4pnc0Qb8nZg","block_type":5,"heading3":{"elements":[{"text_run":{"content":"扩展知识 - 分片上传和断点续传","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"H9QKd2xbWoeqLqx1cOycRP3cnnh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于大文件，还可以开启分片上传和断点续传，不需要自己开发，直接使用 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"对象存储的 SDK","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F65935"},"strikethrough":false,"underline":false}}},{"text_run":{"content":" 就能完成。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"DwWtdmnjSo2j5jxmvSAcxMbQnmB","block_type":22,"divider":{},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Pr1GdAfDyoGD7Jx7lIncbzfdnSh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Wggxd8iRbouMwlxpvyUcLjkEn0f","block_type":4,"heading2":{"elements":[{"text_run":{"content":"图片加载优化","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"RnUMddNrdow81Wxp5wVcpwZbnYf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"图片加载优؜化的目的是提升页面加载速度、减少带宽消耗，并改善用户体验。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Tw9qdC4okooVDhx2q9pcLKM8nBf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"将؜从缩略图、懒加载、CDN 加速、浏览器缓存这 4 个方面进行全面优化。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"WF54dspFdoS5t8xln8NcuVbFn1f","block_type":5,"heading3":{"elements":[{"text_run":{"content":"缩略图","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"CnFKdIHBTo09ruxP87TcmQGknit","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"系统目前的؜问题：首页直接加载原图，原图文件通常比缩略图大数倍甚至数十倍，不仅导致加载时间长，还会造成大量流量浪费。OTsSx2bzs2C13D2pB4s4on5rzOarAwg0YtGpfccE/pk=","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"LXNvdzOOzo6VhZxQ3JGcgELAnbe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"解决方案：؜上传图片时，同时生成一份较小尺寸的缩略图。用户浏览图片列表时加载缩略图，只有在进入详情页或下载时才加载原图。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QCMCdNtxWoU3AlxaJiecfegXnmc","block_type":6,"heading4":{"elements":[{"text_run":{"content":"1、实现方案","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"DvXpdHQGNobLMnxZI8TcZ7OLnWf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"生成缩略图؜的方法和前面讲的 “图片压缩” 一致，可以使用本地图像处理类库，也可以利用第三方云服务完成。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Vbkmd58xmo4ShuxSPh3cWJunnTg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"此处我们依然选择数据万象服务，","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"参考 Java SDK 文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F55377%23.E4.B8.8A.E4.BC.A0.E6.97.B6.E5.9B.BE.E7.89.87.E6.8C.81.E4.B9.85.E5.8C.96.E5.A4.84.E7.90.86"},"strikethrough":false,"underline":false}}},{"text_run":{"content":" 使用 SDK 来构造图片处理规则对象，具体的图片缩放参数可 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"参考文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F44880"},"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"OLz5dtyYgoyu71xBxZRcZ1ilnSc","block_type":6,"heading4":{"elements":[{"text_run":{"content":"2、后端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"I8D7dZKnFoowuLxFVGjcmwuknMe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）数据表 picture 新增缩略图字段：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"VXxAdYMKgoZSe2x0vxYcAB6kn6c","block_type":14,"code":{"elements":[{"text_run":{"content":"ALTER TABLE picture\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"    -- 添加新列ADD COLUMN thumbnailUrl varchar(512) NULL COMMENT '缩略图 url';","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":56,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"WQQAd4sxvo4mpjxCxQAcNVe1nNb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）PictureMapper.xml 新增缩略图字段：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"MWkxdeeWroMDWyxLpbocT43ontg","block_type":14,"code":{"elements":[{"text_run":{"content":"<result property=\"thumbnailUrl\" column=\"thumbnailUrl\" jdbcType=\"VARCHAR\"/><!-- ... --><sql id=\"Base_Column_List\">\n    id,url,thumbnailUrl,name,\n    introduction,category,tags,\n    picSize,picWidth,picHeight,\n    picScale,picFormat,userId,\n    createTime,editTime,updateTime,\n    isDelete\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</sql>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":66,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"KwmadruB9oZG7wx5uhqcB15onCe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"3）数据模型؜新增缩略图字段，包括 Picture 类、PictureVO 类、UploadPictureResult 类：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"HCEXdt19koUmi4x6wSicvmJjnPc","block_type":14,"code":{"elements":[{"text_run":{"content":"/**\n * 缩略图 url\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" */private String thumbnailUrl;","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UVNYdsdzxoFklbxk3wZcDyX6n4g","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"4）缩略图处理","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZK65dg23MouMnHxMEHdcFQkvnvh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"首先明确我؜们使用的缩放规则，设置最大宽高后，对图片进行等比缩小。且如果缩略图的宽高大于原图，则不会处理。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"AmX3dlWXjo703LxtyrOc8Z6MnRh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"修改 Co؜sManager 的上传图片方法，补充对缩略图的处理：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"HM7wdJOa2oy2HhxZddBcb1gOnkg","block_type":14,"code":{"elements":[{"text_run":{"content":"public PutObjectResult putPictureObject(String key, File file) {\n    PutObjectRequest putObjectRequest = new PutObjectRequest(cosClientConfig.getBucket(), key,\n            file);\n    // 对图片进行处理（获取基本信息也被视作为一种处理）PicOperations picOperations = new PicOperations();\n    // 1 表示返回原图信息\n    picOperations.setIsPicInfo(1);\n    List<PicOperations.Rule> rules = new ArrayList<>();\n    // 图片压缩（转成 webp 格式）String webpKey = FileUtil.mainName(key) + \".webp\";\n    PicOperations.Rule compressRule = new PicOperations.Rule();\n    compressRule.setRule(\"imageMogr2/format/webp\");\n    compressRule.setBucket(cosClientConfig.getBucket());\n    compressRule.setFileId(webpKey);\n    rules.add(compressRule);\n    // 缩略图处理\n    PicOperations.Rule thumbnailRule = new PicOperations.Rule();\n    thumbnailRule.setBucket(cosClientConfig.getBucket());\n    String thumbnailKey = FileUtil.mainName(key) + \"_thumbnail.\" + FileUtil.getSuffix(key);\n    thumbnailRule.setFileId(thumbnailKey);\n    // 缩放规则 /thumbnail/<Width>x<Height>>（如果大于原图宽高，则不处理）\n    thumbnailRule.setRule(String.format(\"imageMogr2/thumbnail/%sx%s>\", 128, 128));\n    rules.add(thumbnailRule);\n    // 构造处理参数\n    picOperations.setRules(rules);\n    putObjectRequest.setPicOperations(picOperations);\n    return cosClient.putObject(putObjectRequest);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"ASrXdE5i6oFoVLxKb26c8Ozwn2d","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"修改 Pi؜ctureUploadTemplate 的上传图片方法，获取到缩略图：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SSrXdslthonhEgx0t0KcmMr6n5b","block_type":14,"code":{"elements":[{"text_run":{"content":"ProcessResults processResults = putObjectResult.getCiUploadResult().getProcessResults();\nList<CIObject> objectList = processResults.getObjectList();\nif (CollUtil.isNotEmpty(objectList)) {\n    CIObject compressedCiObject = objectList.get(0);\n    CIObject thumbnailCiObject = objectList.get(1);\n    // 封装压缩图返回结果return buildResult(originFilename, compressedCiObject, thumbnailCiObject);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"V7YjdCvZzok2WjxeLHAcyaQFnlg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"修改 Pi؜ctureUploadTemplate 封装返回结果的方法，将缩略图路径也设置到返回结果中：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"EP9ndlffwoXRf4x6bDBc9pEnnvb","block_type":14,"code":{"elements":[{"text_run":{"content":"private UploadPictureResult buildResult(String originFilename, CIObject compressedCiObject, CIObject thumbnailCiObject) {\n    UploadPictureResult uploadPictureResult = new UploadPictureResult();\n    // ...// 设置缩略图\n    uploadPictureResult.setThumbnailUrl(cosClientConfig.getHost() + \"/\" + thumbnailCiObject.getKey());\n    return uploadPictureResult;\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"IMFKd4dpdoF9enxe8YHc0nmbnUd","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"需要同步修؜改 PictureService 的上传图片方法，补充设置缩略图字段：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IdWddoopCo031lxBm9ScSiUgngf","block_type":14,"code":{"elements":[{"text_run":{"content":"// 构造要入库的图片信息Picture picture = new Picture();\npicture.setUrl(uploadPictureResult.getUrl());\npicture.setThumbnailUrl(uploadPictureResult.getThumbnailUrl());\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"String picName = uploadPictureResult.getPicName();","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"YElRdrrqooMBCIxecCnc8BN3nMg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"5）测试效果","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SUXodPKAzoupxdxMcCJcpFEWnOE","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"上传大图片时，缩略图的效果显著，体积直接减小百倍！","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"BJ8TddTDKoGBOfxAy7dcVkNenTc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"但有个比较؜坑的情况，如果上传的图片本身就比较小，缩略图反而比压缩图更大，还不如不缩略！","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"LKErdXnO2o5H52xP7QCcU0dGnYf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"我们可以优؜化 CosManager 图片上传的逻辑，仅对 > 20 KB 的图片生成缩略图：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"V6bQdqxV3ozEZMxp5pXcEhdNnzf","block_type":14,"code":{"elements":[{"text_run":{"content":"// 缩略图处理，仅对 > 20 KB 的图片生成缩略图if (file.length() > 2 * 1024) {\n    PicOperations.Rule thumbnailRule = new PicOperations.Rule();\n    thumbnailRule.setBucket(cosClientConfig.getBucket());\n    String thumbnailKey = FileUtil.mainName(key) + \"_thumbnail.\" + FileUtil.getSuffix(key);\n    thumbnailRule.setFileId(thumbnailKey);\n    // 缩放规则 /thumbnail/<Width>x<Height>>（如果大于原图宽高，则不处理）\n    thumbnailRule.setRule(String.format(\"imageMogr2/thumbnail/%sx%s>\", 128, 128));\n    rules.add(thumbnailRule);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"ZX0KdmPUboxkMexvbaicwldInGf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"修改 Pi؜ctureUploadTemplate 的逻辑，如果没有生成缩略图，则缩略图等于压缩图：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"G0x5dVK3xoavbfxIxhncTm1Lngh","block_type":14,"code":{"elements":[{"text_run":{"content":"if (CollUtil.isNotEmpty(objectList)) {\n    CIObject compressedCiObject = objectList.get(0);\n    // 缩略图默认等于压缩图CIObject thumbnailCiObject = compressedCiObject;\n    // 有生成缩略图，才得到缩略图if (objectList.size() > 1) {\n        thumbnailCiObject = objectList.get(1);\n    }\n    // 封装压缩图返回结果return buildResult(originFilename, compressedCiObject, thumbnailCiObject);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"ZRuhdnWR8oodYlxdw3tciWo2nie","block_type":6,"heading4":{"elements":[{"text_run":{"content":"3、前端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"IDtPdqG3QoSnK0xQtXFch123n6e","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"只需要将首页展示的图片改为优先读取缩略图即可：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"CTOMdnObAoWUKFx22EIcJ9gBnIf","block_type":14,"code":{"elements":[{"text_run":{"content":"<img\n  style=\"height: 180px; object-fit: cover\"\n  :alt=\"picture.name\"\n  :src=\"picture.thumbnailUrl ?? picture.url\"\n  loading=\"lazy\"\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"/>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":1,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"U717dzdCQovt44xdBZYcZAHWnom","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"如果觉得太؜模糊了，还可以增大缩略图的宽高、调高需要生成缩略图的文件大小阈值，这是一个成本和用户体验上的权衡","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"OAOed1nF8oWv8Xx1JFAc2drcnzh","block_type":6,"heading4":{"elements":[{"text_run":{"content":"扩展","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"MqpTdxwRgodostxQBm9cvjK1nyc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）除了缩略图之外，还可以提供相对更清晰的 预览图，用于在图片详情页展示，仅在下载时才使用无损原图。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ALfSdsQrJoK2YpxQPWxcCOe4nIw","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）可以对؜文件名称进行更完整地校验处理，防止因为图片本身名称不规范导致的后缀丢失。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QjjvdIZZCobKeyx1Q0VcA3utndb","block_type":5,"heading3":{"elements":[{"text_run":{"content":"懒加载","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"B9q0dP3ISoG9zaxPhumcCgXynBf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"懒加载（Lazy Loading）可以避免一次性加载所有图片，只有当资源需要显示时才进行加载。比如对于图片列表来说，仅在用户滚动到图片所在区域时才加载该图片资源。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"WqLdddx3Wox1azx7FVHcVcrHnwd","block_type":6,"heading4":{"elements":[{"text_run":{"content":"实现方案","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Cs3IdnQASooMLAx8bk2cmv24nm0","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"虽然懒加载؜的实现更多的是依赖前端，但后端也有一定的优化策略，比如对图片列表进行分页，每页不需要展示过多的内容。ea/ltUip9c7M0FiZpvhBOidq1hgdtVTeHcw0XSJsUYE=","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"OF1Yd6dvwoj54LxcLb3cWgfAnmb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"前端如何实现懒加载呢？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ONhEdgqdwoh2jpxNcWmcfPx9nxh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）使用 HTML5 原生的 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"loading=\"lazy\"","text_element_style":{"bold":false,"inline_code":true,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 属性。示例代码如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"AiQEd2gTFoPALvxdCrXcayTEnfe","block_type":14,"code":{"elements":[{"text_run":{"content":"<img src=\"image.jpg\" alt=\"示例图片\" loading=\"lazy\" />","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"ZwiDdDJZrobKKbxEGfpcfnTXn8g","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"这种方法最؜简单，但是对旧版浏览器（如 IE）不兼容，而且不支持更复杂的懒加载需求（如动画或特殊事件触发）。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"KXaUdd2zvoh6Txx1j8zc2Ba8nHf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）使用 ؜JS 的 Intersection Observer，这个 API 能够检测元素是否进入视口，参考实现如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"A82idu1C8op0EUxGrz2cnxFin8f","block_type":13,"ordered":{"elements":[{"text_run":{"content":"将图片的真实 src 替换为一个占位属性（如 data-src）。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"YBJUdEZXSoL7C6xMHwCc1g7MnDx","block_type":13,"ordered":{"elements":[{"text_run":{"content":"使用 Intersection Observer 监听图片是否进入视口。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"G7RGdl0JqoBgeOxFkiCcvrAsnab","block_type":13,"ordered":{"elements":[{"text_run":{"content":"当图片进入视口时，将 data-src 的值赋给 src，触发加载。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"UDEOdey3NoZGd4x2PBucjnYMnvg","block_type":14,"code":{"elements":[{"text_run":{"content":"<img data-src=\"image.jpg\" alt=\"示例图片\" class=\"lazy\" /><img data-src=\"image2.jpg\" alt=\"示例图片\" class=\"lazy\" /><script>// 获取所有需要懒加载的图片const lazyImages = document.querySelectorAll('img.lazy');\n\n  // 创建 Intersection Observerconst observer = new IntersectionObserver((entries, observer) => {\n    entries.forEach(entry => {\n      if (entry.isIntersecting) {\n        const img = entry.target;\n        // 将 data-src 的值赋给 src 属性\n        img.src = img.dataset.src;\n        img.classList.remove('lazy');\n        observer.unobserve(img); // 停止观察已加载的图片\n      }\n    });\n  });\n\n  // 观察每个图片\n  lazyImages.forEach(image => observer.observe(image));\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"</script>","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":24,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"TpajdgoSyo5HEExm9CMcAgcgngh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"3）使用 J؜S 监听页面滚动事件实现。每次页面滚动时，判断图片是否进入可视区域；如果是，则给图片增加 src 属性，触发图片加载。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Q5bJd33q8oAw8wxUtsacCJ4rn1f","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"4）使用现成的组件库或类库实现，比如 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"lazysizes 库","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fgithub.com%2FaFarkas%2Flazysizes"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"。Dlfw8NwnEDAWu8E/AQcY7dm3A98behgssP1uNM9pOf8=","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"I4P5dWTbfoFNoNxdeLLcBKxVnxc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"由于我们的؜项目已经使用了缩略图，加载的资源本来也不多，所以暂时没必要使用懒加载了。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QDlMdqvRho4ULjxO587cv8K0nch","block_type":6,"heading4":{"elements":[{"text_run":{"content":"扩展知识 - 渐进式加载","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"GEHCdeRDfojJNKxbTyScGmXcnQf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"渐进式加载和懒加؜载技术类似，先加载低分辨率或低质量的占位资源（如模糊的图片缩略图），在用户访问或等待期间逐步加载高分辨率的完整资源，加载完成后再替换掉占位资源。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IYpldqf7toIPwyxlTV7cH8qWnbe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"适用于超清؜图片加载、用户体验要求较高的页面，在网络环境较差时，效果会更明显。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"CBEqdff0UoRztsx6IdZcCKvwnqg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"Ant Design Vue 的 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"Image 图片组件","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fantdv.com%2Fcomponents%2Fimage-cn"},"strikethrough":false,"underline":false}}},{"text_run":{"content":" 支持渐进加载功能","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"L285d076foihdLx0elhcd51LnSb","block_type":5,"heading3":{"elements":[{"text_run":{"content":"CDN 加速","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"MK4Id2FlsoKkC4xOK3pcZsUKnFd","block_type":6,"heading4":{"elements":[{"text_run":{"content":"1、什么是 CDN？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"JNXadNUimoPQA5xIZBWcKJQDnEc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"CDN（内容分发网络؜）是通过将图片文件分发到全球各地的节点，用户访问时从离自己最近的节点获取资源的技术，常用于文件资源或后端动态请求的网络加速，也能大幅分摊源站的压力、支持更多请求同时访问，是性能提升的利器。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"XFVUdWjetorRtcxOSFocPhJsnGb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"💡 如果؜你想了解一些云服务的介绍、架构和最佳实践，多去看大公司云服务的产品文档，就能学到很多知识。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"BXQ9dqw3gocNRVxsndQcn5qHnJ4","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"CDN 请求的核心过程如下：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"BTcbdZt46o5XTqxl7ddcLsv0nAc","block_type":13,"ordered":{"elements":[{"text_run":{"content":"图片文件由 源站（如 COS 对象存储、或者服务器）上传至 CDN 服务进行缓存。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"1"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Vk0GdJojEofI2CxGiQGc8bnKnug","block_type":13,"ordered":{"elements":[{"text_run":{"content":"当用户请求图片时，CDN 会根据用户的地理位置，返回离用户 最近的 CDN 节点缓存的图片资源。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"QLEGdGmFooh4Jlx3Walcig3cn3g","block_type":13,"ordered":{"elements":[{"text_run":{"content":"未命中缓存的图片将从源站获取，并缓存在 CDN 节点，供后续用户访问，俗称 回源。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false,"sequence":"auto"}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"KGdRdZ00roSLekxBve6cNNTEnKS","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"💡 回源的具体解释：在؜内容分发网络中，回源是指用户通过浏览器发送请求时，响应该请求的是源站点的服务器，而不是各节点上的缓存服务器。一般情况下，当 CDN 节点上的缓存服务器没有缓存响应的内容，或者响应的内容在源站点服务器上被修改，就会回源站去获取。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"DQ15dfiJioEBJkxvDOUcZ9lfnlg","block_type":6,"heading4":{"elements":[{"text_run":{"content":"2、CDN 的优势","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"QUlpdbcVlozTIdxyugFcdtQxnmf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"有同学会问؜了：COS 对象存储不也是存储图片的服务么？CDN 内容分发网络有啥独特的优势啊？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SDatdVrwyob4qPxXnD3cMky3nqh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"从这两个服؜务的名称中，我们就能明显感受到区别了，COS 更倾向于 “存储”，CDN 更倾向于 “网络请求”。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"D6WadQcYFouMYgxrabyccm7YnVh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"所以如果文件存储容量较大؜、但是访问频率较低，用对象存储性价比更高；但如果资源访问频率高、流量消耗大，还需要对访问进行加速、减少源站压力，就要使用 CDN 了。CDN 的流量和请求单价通常低于对象存储，而且更加安全，可以保护源站地址不被泄露。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Z4EjdoQ6XozRUdxwD88ctJ2qn6g","block_type":6,"heading4":{"elements":[{"text_run":{"content":"3、如何使用 CDN？","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"KKpDd50jEox6DIx5HgvctkXBnne","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"一般情况下，如果你؜要对外提供文件（图片）访问 / 下载服务，建议结合 COS 和 CDN。比如对于本项目，COS 作为源站，负责存储图片文件；CDN 负责提供文件访问服务，以及缓存、安全性的设置。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"VRHRd6Mp3ovEv1xa5eWc0yYRnFe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"也就是说，؜使用 CDN 之后，我们数据库中存储的图片地址就不再是 COS 的地址，而是 CDN 的 URL。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Jok2dt7oTotXfexE0hicKke3nBb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"如何开通和使用 CDN 服务？建议阅读 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"官方的产品文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F228%2F3149"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"、还有 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"CDN 结合 COS 的文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F228%2F38088"},"strikethrough":false,"underline":false}}},{"text_run":{"content":"，写得很贴心。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SJlwd9yFuoI2WMxzSjjcxZSRn0g","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"💡 CDN 还提供自动图片优化功能，感兴趣的同学可以 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"看文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F228%2F43121"},"strikethrough":false,"underline":false}}},{"text_run":{"content":" 了解下。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QEM1d6PaMoWr8vxDYVicqdJcnYe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"大家一定要认真看：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SCcwdGSRpop9vixssI3cc6H3nWf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）缓存策؜略：为静态资源（如图片、CSS、JS）设置长期缓存时间，可以减少回源的次数和消耗。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"CUxudLDhHofuCGx6DSAcgBMsn7c","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）防盗链؜：配置 Referer 防盗链保护资源，比如仅允许自己的域名可以加载图片","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Y578dYtCmoBrAExgYAxcnJPlnHh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"3）IP ؜限制：根据需要配置 IP 黑白名单，限制不必要的访问。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"P4Qpd0fI2oqEwgxer5AcvNk7nEc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"4）HTT؜PS 配置：配置有效的 SSL 证书，启用 HTTPS 传输，提高请求的安全性。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"G460dRgp8oYgQfx5J8XchWlAnBM","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"5）","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"监控告警：这点尤为重要！","text_element_style":{"bold":true,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 一定要给 CDN 配置监控告警，比如设置一段时间内最多消耗的流量，超出时会自动发短信告警，避免费用超额；或者限制单个 IP 的请求频率，防止突发流量影响服务。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"EwdEdCN0noiibYxdcOZcegnBnKe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"6）CDN ؜节点选择：国内业务选择覆盖中国大陆的节点就足够了，非必要的话，不要开通全球 CDN 节点，容易遭受海外攻击。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"VK9oduyZ4ozj6OxTRnxcZo64nec","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"7）访问日؜志：开启访问日志，分析用户行为和流量来源，这个能力更适合业务访问量较大的场景。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"DSuodNlWLonLanxder0cLkOanjh","block_type":5,"heading3":{"elements":[{"text_run":{"content":"浏览器缓存","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"K6bhdr2kRo4ZB5xBynLcW9a9nLe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"通过设置 HTT؜P 头信息（如 Cache-Control），可以让用户的浏览器将资源缓存在本地。在用户再次访问同样的资源时，直接从本地缓存加载资源，而无需再次请求服务器。1jGyT1jdedQgDNFYA8T3BC8Rpod+tQXglYFmkZuCZXA=","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"T5oudvxlboH4YAxhIPPchRhqn3e","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"所有缓存在使用时的注意事项基本都是类似的：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"JNB9dkv6KozeRoxevKKc0Udkn7d","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）设置合理的缓存时间。常用的几种设置参数是：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"LCCrd1xLUoF7eoxlSBkcT8THn5Q","block_type":12,"bullet":{"elements":[{"text_run":{"content":"静态资源使用长期缓存，比如：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"Cache-Control: public, max-age=31536000","text_element_style":{"bold":false,"inline_code":true,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 表示缓存一年，适合存储图片等静态资源。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"GogLdgGTBoRycYxUanocat2onmc","block_type":12,"bullet":{"elements":[{"text_run":{"content":"动态内容使用验证缓存，比如：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"Cache-Control: private, no-cache","text_element_style":{"bold":false,"inline_code":true,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 表示缓存可被客户端存储，但每次使用前需要与服务器验证有效性。适合会动态变化内容的页面，比如用户个人中心。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"RRhjdCb8koyU40xfzZXcwXoOnGg","block_type":12,"bullet":{"elements":[{"text_run":{"content":"敏感内容禁用缓存，比如：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"Cache-Control: no-store","text_element_style":{"bold":false,"inline_code":true,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 表示不允许任何形式的缓存，适合安全性较高的场景，比如登录页面、支付页面。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Ta5xd6rPxoyYvjxE3LNc4p4nnLc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）要能够及时更؜新缓存。可以给图片的名称添加 “版本号”（如文件名中包含 hash 值），这样哪怕上传相同的图片，由于版本号不同，得到的图片地址也不同，下次访问时就会重新加载。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"DbuedB8YjozDELxmtZecs4eTnpe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于我们的项目，图片资源是非常适合长期缓存在浏览器本地的，也已经通过给文件名添加日期和随机数防止了重复。由于图片是从对象存储云服务加载的，如果需要使用缓存，可以接入 CDN 服务，直接在云服务的控制台配置缓存，","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"参考文档","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F228%2F50114"},"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"RD3Bdx8QYoGUnYxcbmScB9Vtn2c","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"如果触发了؜浏览器本地缓存，在 F12 控制台中能够看到图片瞬间加载成功：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Kx6ddxJ7toW6AtxClPNcG5JlnMg","block_type":4,"heading2":{"elements":[{"text_run":{"content":"图片存储优化","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"E9XSdgXxvobYPlx0VMlc2AeOnPf","block_type":5,"heading3":{"elements":[{"text_run":{"content":"数据沉降","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"CI2rdC5oWo9I9rxh90BcEJrSn8g","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"大部分数据的؜访问热度会随着存储时间延长逐渐降低，为了严格控制存储成本，需要定期分析业务数据的访问情况，并动态调整存储类型。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IfkSdDs9joxdvKxBR7CcJ07Unyh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"这就涉及到 数据沉降 技术，将长时间未访问的数据自动迁移到低频访问存储，从而降低存储成本。就跟我们平时使用电脑一样，SSD 硬盘很贵，我们一般优先将常用软件放在 SSD 目录中，至于一些以前写过的资料什么的，可以放在机械硬盘或外接硬盘中。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"GJFCdSocLoFvvsxqB3zc9Jflnwe","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"一般情况下，数据沉降分为 2 个阶段：先分析再沉降。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"My5OdK984oUcguxJMCdc0Q9Jnqh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）先分析؜：通过对象存储提供的清单 / 访问日志分析，或者业务代码中自行统计分析。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ElrpdgB0coQUOQxG2shc3QrRn6b","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）再沉降：可以直接通过对象存储提供的 生命周期 功能自动沉降数据，只需编写沉降规则即可。如下图，将 30 天未修改的文件沉降至低频存储","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"GuIqdfVqtoFSFfxynIAcJ5E1nzg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"低频存储的价格比标准存储低了一些，还可以将 几乎不需要修改和访问 的文件（比如日志文件）移动到归档存储中，存储价格更低，可节约几倍的成本！","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Z4VOdu0qloyEvUxkBAycrYbknUA","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"不过要注意，虽؜然低频存储的存储费用更低，但是当你要访问低频存储的资源时，会产生数据取回费用，所以一般只对几乎不访问的资源进行沉降，尽量减少取回费用。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"NTXrdqHdLo9ZwZxvOD2crHgtnSg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"数据沉降和 冷热数据分离 的概念是比较接近的，冷热数据分离是根据数据的访问热度，将访问频繁的数据（热数据）和访问较少的数据（冷数据）存储在不同的存储层中。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"XV3ndy9FRol341xubIUcXO37nzf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于我们的项目，很久无؜人问津的历史图片就可以称为 “冷数据”，可以利用 COS 的生命周期功能在 30 天后自动沉降为低频存储。当然也可以通过数据库记录图片的访问和下载时间，自行调用 API 批量沉降数据或者转储到其他存储服务。OTsSx2bzs2C13D2pB4s4on5rzOarAwg0YtGpfccE/pk=","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"OtLKdpT9ioCZghxdQXrcUzzEntb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"💡 数据沉降和冷热数据分离的概؜念又有一些细微的差别，个人的理解是数据沉降更倾向于关注一个对象的生命周期（一个资源从热到冷），目标更多的是降低存储成本，配置沉降规则后也一般不会调整。冷热数据分离更关注整个系统的资源分布（比如热门图片放到性能更高的硬盘中，冷门图片进行归档存储），目标是同时优化性能和节约成本，数据的热度可以实时调整。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"PgpgdsHFtoEuhrxftG1cK0iynoB","block_type":5,"heading3":{"elements":[{"text_run":{"content":"清理策略","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"XdaSdX2PuoBeszxcmHKcuabOnjh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于 “重؜存储” 的系统，数据清理是必要的！通过设置合理的清理策略，可以避免冗余数据占用存储空间，降低成本。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"ZXmkdAs3EouP97xeyJbcHo51nYf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"分享 4 种典型的清理策略：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"V20ldGHUiorkSQx4dy5cOY2DnQh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）立即清؜理：在删除图片记录时，立即关联删除对象存储中已上传的图片文件，确保数据库记录与存储文件保持一致。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"SrkedIGOKot5TZxVZZVcRQNbnog","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"这里还有个؜小技巧，可以使用异步清理降低对删除操作性能的影响，并且记录一些日志，避免删除失败的情况。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QUuMdbjE5oGcxaxJYM6cuIp0nmk","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）手动清؜理：由管理员手动触发清理任务，可以筛选要清理的数据，按需选择需要清理的文件范围。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"GC6ZdHEOGorEIAxNYDpcj54dntg","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"3）定期清؜理：通过定时任务自动触发清理操作。系统预先设置规则（如文件未访问时间超过一定期限）自动清理不需要的数据。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"U2bUd04M1ovXZkxlPDqcKCWmnjc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"4）惰性清理：؜清理任务不会主动执行，而是等到资源需求增加（存储空间不足）或触发特定操作时才清理，适合存储空间紧张但清理任务优先级较低的场景。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"QJuydaRPro2TXUx4NNycfyFJnoc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"实际开发中，以上几种清理策略可以结合使用。比如 Redis 的内存管理机制结合了定期清理和惰性清理策略。 定期清理通过后台定期扫描一部分键，随机检查并删除已过期的键，从而主动释放内存，减少过期键的堆积。惰性清理则是在访问某个键时，检查其是否已过期，如果已过期则立即删除。这两种策略互为补充：定期清理降低了过期键的占用积累，而惰性清理确保了访问时键的准确性和及时清理，从而在性能和内存使用之间取得平衡。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"NlvZdyN4boHUR3xO5HZcNnW1n0f","block_type":6,"heading4":{"elements":[{"text_run":{"content":"实现方案","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"CdEddhAgBoovVuxLlrgcaSrCnkf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"对于我们的项目，؜由于不像 Redis 一样对空间的限制那么严格，更多的是为了节约成本，所以不需要惰性清理策略，按需运用 “立即清理 + 手动清理 + 定期清理” 即可。OTsSx2bzs2C13D2pB4s4on5rzOarAwg0YtGpfccE/pk=","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"NqBkdaCNwoNXg6xM3kBc3NJbneh","block_type":6,"heading4":{"elements":[{"text_run":{"content":"后端开发","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"D3nHdJs0ToIyFHxSOJ8c3OELnvf","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）CosManager 补充删除对象的方法：","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"X7T5dkfiuoypRkxwxQ3cvwVfnOe","block_type":14,"code":{"elements":[{"text_run":{"content":"/**\n * 删除对象\n *\n * @param key 文件 key\n */public void deleteObject(String key) throws CosClientException {\n    cosClient.deleteObject(cosClientConfig.getBucket(), key);\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"E4JydOmacoEC8BxxRIGcuCYVnbb","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）在 PictureService 中开发图片清理方法。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Gj4jdHr1MoxOkHxKjHZcdO21nfc","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"注意，删除图؜片时，需要先判断该图片地址是否还存在于其他记录里，确认没有才能删除。比如秒传的场景，就有可能多个图片地址指向同一个文件。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"OSLHdgZUeoU4MFxrJAUcjnq3ndh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"此外，还要注意删除对؜象存储中的文件时传入的是 key（不包含域名的相对路径），而数据库中取到的图片地址是包含域名的，所以删除前要移除域名，从而得到 key。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"UIt0dBoSCoUo5Kx6XdqcuHMpnid","block_type":14,"code":{"elements":[{"text_run":{"content":"@Async\n@Override\npublic void clearPictureFile(Picture oldPicture) {\n    // 判断该图片是否被多条记录使用String pictureUrl = oldPicture.getUrl();\n    long count = this.lambdaQuery()\n            .eq(Picture::getUrl, pictureUrl)\n            .count();\n    // 有不止一条记录用到了该图片，不清理if (count > 1) {\n        return;\n    }\n    // FIXME 注意，这里的 url 包含了域名，实际上只要传 key 值（存储路径）就够了\n    cosManager.deleteObject(oldPicture.getUrl());\n    // 清理缩略图String thumbnailUrl = oldPicture.getThumbnailUrl();\n    if (StrUtil.isNotBlank(thumbnailUrl)) {\n        cosManager.deleteObject(thumbnailUrl);\n    }\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"P1ssdchECofRWexdyJKcz2WInut","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"上述代码中，使用了 Spring 的 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"@Async","text_element_style":{"bold":false,"inline_code":true,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 注解，可以使得方法被异步调用，记得要在启动类上添加 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"@EnableAsync","text_element_style":{"bold":false,"inline_code":true,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":" 注解才会生效。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"YIrgdjJlUosNQXxsYDFco684nvb","block_type":14,"code":{"elements":[{"text_run":{"content":"@SpringBootApplication@EnableAsync@MapperScan(\"com.yupi.yupicturebackend.mapper\")@EnableAspectJAutoProxy(exposeProxy = true)public class YuPictureBackendApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(YuPictureBackendApplication.class, args);\n    }\n","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"}","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"language":29,"wrap":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"Rf5IdHwOTom5S1xV7JMcK2von1f","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"然后你可以将 cl؜earPictureFile 方法运用到图片删除接口等场景        ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"GbwXdCofNovtqzxbIEacQX9unAa","block_type":6,"heading4":{"elements":[{"text_run":{"content":"扩展","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"BUbmdkPvjou9PnxKr9NcseMbnuh","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"1）补充更؜多清理时机：在重新上传图片时，虽然那条图片记录不会删除，但其实之前的图片文件已经作废了，也可以触发清理逻辑。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Lz09dvfxPoeH5txLk3nc1w2bnMs","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"2）实现更多؜清理策略：比如用 Spring Scheduler 定时任务实现定时清理、编写一个接口供管理员手动清理，作为一种兜底策略。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"IKfrdFmpGoKBlQxXfZsc6rQFnt1","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"3）优化清理文件的代码，比如要删除多个文件时，使用 ","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}},{"text_run":{"content":"对象存储的批量删除接口","text_element_style":{"bold":false,"inline_code":false,"italic":false,"link":{"url":"https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F436%2F65939%23841fe310-bdf8-4789-9bc0-26ea844e316d"},"strikethrough":false,"underline":false}}},{"text_run":{"content":" 代替 for 循环调用。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"AEkPdmlwQoHRdDxvtDac91tEnRQ","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"4）为了清理原图，可以在数据库中保存原图的地址。","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}},{"block_id":"Ihk1dTycPozI30xWqLkcD8MenZe","block_type":22,"divider":{},"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb"},{"block_id":"RW4Sd0hVeoPS8KxYJJHchqEZn7d","block_type":2,"parent_id":"AzbUdUbAqons0YxYlHBcmLNtnHb","text":{"elements":[{"text_run":{"content":"至此项目第一阶段完成","text_element_style":{"bold":false,"inline_code":false,"italic":false,"strikethrough":false,"underline":false}}}],"style":{"align":1,"folded":false}}}],"type":"docx"}