# å›¾ç‰‡åŠŸèƒ½æ‰©å±•

ä¸ºäº†å¸å¼•ç”¨Øœæˆ·ä½¿ç”¨æˆ‘ä»¬å¹³å°çš„ç§æœ‰ç©ºé—´ä½œä¸ºä¸ªäººç›¸å†Œï¼Œéœ€è¦æä¾›æ›´å¤šåŠŸèƒ½ã€‚

æœ¬èŠ‚æˆ‘ä»¬é‡ç‚¹å¯¹å›¾ç‰‡åŠŸèƒ½è¿›è¡Œæ‰©å±•ï¼ŒåŒ…æ‹¬ï¼š

* å›¾ç‰‡æœç´¢
* åŸºç¡€å±æ€§æœç´¢
* ä»¥å›¾æœå›¾
* é¢œè‰²æœç´¢
* å›¾ç‰‡åˆ†äº«
* é“¾æ¥åˆ†äº«
* æ‰«ç åˆ†äº«
* å›¾ç‰‡æ‰¹é‡ç®¡ç†
* æ‰¹é‡ä¿®æ”¹ä¿¡æ¯
* æ‰¹é‡é‡å‘½å

æœ‰äº†è¿™äº›åŠŸØœèƒ½ï¼Œç”¨æˆ·èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°ç®¡ç†å’Œåˆ†äº«å¹³å°ä¸Šçš„å›¾ç‰‡èµ„æºï¼Œè¿›ä¸€æ­¥æå‡ä½¿ç”¨ä½“éªŒã€‚

# å›¾ç‰‡æœç´¢â€”â€”åŸºç¡€å±æ€§æœç´¢

## éœ€æ±‚åˆ†æ

æˆ‘ä»¬å¯ä»¥æä¾›å¤šç§æœç´¢ç»´åº¦ï¼Œå¸®ç”¨æˆ·æ›´å¿«åœ°æ‰¾åˆ°è‡ªå·±ç©ºé—´çš„å›¾ç‰‡ã€‚

å°†æœç´¢ç»´åº¦æŒ‰ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼Œä¼˜å…ˆçº§é«˜çš„ä¼šå±•ç¤ºåœ¨é å‰çš„ä½ç½®ï¼š

* å…³é”®è¯ï¼šåŒæ—¶æœç´¢åç§°å’Œç®€ä»‹
* æ ‡ç­¾
* åˆ†ç±»
* ç¼–è¾‘æ—¶é—´ï¼ˆå¼€å§‹æ—¶é—´ä¸ç»“æŸæ—¶é—´ï¼‰
* å›¾ç‰‡åç§°
* å›¾ç‰‡ç®€ä»‹
* å›¾ç‰‡å®½åº¦
* å›¾ç‰‡é«˜åº¦
* å›¾ç‰‡æ ¼å¼

## æ–¹æ¡ˆè®¾è®¡

åç«¯å¯ä»¥ç›´Øœæ¥å¤ç”¨åŸæœ‰çš„åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨æ¥å£ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ ç›¸åº”çš„æœç´¢æ¡ä»¶ï¼Œä»¥æ”¯æŒæ›´çµæ´»çš„ç­›é€‰ã€‚

å‰ç«¯å¯ä»¥é’ˆØœå¯¹ä¸åŒç±»å‹çš„æœç´¢ç»´åº¦é€‰ç”¨ç‰¹å®šçš„è¡¨å•é¡¹ç»„ä»¶ï¼Œæ¥æé«˜æœç´¢çš„ä½“éªŒã€‚

* å…³é”®è¯ï¼šæ–‡æœ¬è¾“å…¥æ¡†
* æ ‡ç­¾ï¼šä¸‹æ‹‰é€‰æ‹©æ¡†
* åˆ†ç±»ï¼šä¸‹æ‹‰é€‰æ‹©æ¡†
* ç¼–è¾‘æ—¶é—´ï¼šæ—¥æœŸé€‰æ‹©å™¨
* å›¾ç‰‡åç§°ï¼šæ–‡æœ¬è¾“å…¥æ¡†
* å›¾ç‰‡ç®€ä»‹ï¼šæ–‡æœ¬è¾“å…¥æ¡†
* å›¾ç‰‡å®½åº¦ï¼šæ•°å­—è¾“å…¥æ¡†
* å›¾ç‰‡é«˜åº¦ï¼šæ•°å­—è¾“å…¥æ¡†
* å›¾ç‰‡æ ¼å¼ï¼šæ–‡æœ¬è¾“å…¥æ¡† / ä¸‹æ‹‰é€‰æ‹©æ¡†

## åç«¯å¼€å‘

å…¶ä»–çš„æœç´¢æ¡ä»¶åŸºæœ¬éƒ½å·²ç»æœ‰äº†ï¼Œè¿˜éœ€è¦æ”¯æŒæŒ‰ç…§ç¼–è¾‘æ—¶é—´æœç´¢ã€‚

1ï¼‰ä¸ºäº†æ”¯ØœæŒæŒ‰ç¼–è¾‘æ—¶é—´è¿›è¡Œæœç´¢ï¼Œéœ€è¦åœ¨è¯·æ±‚ç±» PictureQueryRequest ä¸­æ·»åŠ å¼€å§‹å’Œç»“æŸç¼–è¾‘æ—¶é—´å­—æ®µï¼š


```Java
/**
 * å¼€å§‹ç¼–è¾‘æ—¶é—´
 */private Date startEditTime;

/**
 * ç»“æŸç¼–è¾‘æ—¶é—´
 */private Date endEditTime;
```

2ï¼‰æ›´æ–°å›¾ç‰‡æœåŠ¡çš„ getQueryWrapper æ–¹æ³•

åœ¨å¤„ç†æŸ¥è¯¢æ—¶ï¼Œè¡¥å……æŒ‰ç¼–è¾‘æ—¶é—´ç­›é€‰çš„é€»è¾‘ï¼š


```Java
Date startEditTime = pictureQueryRequest.getStartEditTime();
Date endEditTime = pictureQueryRequest.getEndEditTime();
queryWrapper.ge(ObjUtil.isNotEmpty(startEditTime), "editTime", startEditTime);
queryWrapper.lt(ObjUtil.isNotEmpty(endEditTime), "editTime", endEditTime);
```

## å‰ç«¯å¼€å‘

### 1ã€å›¾ç‰‡æœç´¢è¡¨å•ç»„ä»¶

ç”±äºç©ºé—´è¯¦æƒ…é¡µçš„ä»£ç é‡è¾ƒå¤§ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å›¾ç‰‡æœç´¢é€»è¾‘å•ç‹¬å°è£…ä¸ºå›¾ç‰‡æœç´¢è¡¨å•ç»„ä»¶ `PictureSearchForm.vue`ã€‚ä¸ºæé«˜æ•ˆç‡ï¼Œè¯¥ç»„ä»¶å¯ä»¥ä»å›¾ç‰‡ç®¡ç†é¡µé¢çš„æœç´¢è¡¨å•å¤åˆ¶è€Œæ¥ã€‚

æ³¨æ„ï¼Œè¯¥ç»„ä»¶ä»…è´Ÿè´£ä¿®æ”¹æœç´¢æ¡ä»¶ï¼Œä¸è´Ÿè´£æ•°æ®è·å–ä¸å­˜å‚¨ã€‚

1ï¼‰å®šä¹‰ç»„ä»¶å±æ€§ï¼š


```TypeScript
interface Props {
  onSearch?: (searchParams: PictureQueryRequest) => void
}

const props = defineProps<Props>()
```

2ï¼‰ç¼–å†™æœç´¢æ¡ä»¶å’Œæœç´¢å‡½æ•°ï¼šä½¿ç”¨ `reactive` å˜é‡å­˜å‚¨æœç´¢æ¡ä»¶ï¼Œå¹¶è§¦å‘çˆ¶ç»„ä»¶çš„ `onSearch` æ–¹æ³•ã€‚


```TypeScript
// æœç´¢æ¡ä»¶const searchParams = reactive<API.PictureQueryRequest>({})

// è·å–æ•°æ®const doSearch = () => {
  props.onSearch?.(searchParams)
}
```

3ï¼‰å¼€å‘é¡µé¢ç»“æ„

å…¶ä¸­ï¼š

* æ—¥æœŸè¡¨å•é¡¹ä½¿ç”¨ Ant Design çš„ [æ—¥æœŸé€‰æ‹©å™¨ç»„ä»¶](https://antdv.com/components/date-picker-cn#components-date-picker-demo-presetted-ranges)ï¼Œæ”¯æŒé¢„è®¾çš„æ—¥æœŸèŒƒå›´é€‰é¡¹ï¼ˆæ¯”å¦‚è¿‡å»ä¸€å‘¨ï¼‰
* å®½åº¦ / é«˜åº¦è¡¨å•é¡¹ä½¿ç”¨ [æ•°å­—è¾“å…¥æ¡†ç»„ä»¶](https://antdv.com/components/input-number-cn)

ä»£ç å¦‚ä¸‹ï¼š


```PlainText
<div class="picture-search-form">
  <!-- æœç´¢è¡¨å• -->
  <a-form layout="inline" :model="searchParams" @finish="doSearch">
    <a-form-item label="å…³é”®è¯" name="searchText">
      <a-input
        v-model:value="searchParams.searchText"
        placeholder="ä»åç§°å’Œç®€ä»‹æœç´¢"
        allow-clear
      />
    </a-form-item>
    <a-form-item label="åˆ†ç±»" name="category">
      <a-auto-complete
        v-model:value="searchParams.category"
        style="min-width: 180px"
        :options="categoryOptions"
        placeholder="è¯·è¾“å…¥åˆ†ç±»"
        allowClear
      />
    </a-form-item>
    <a-form-item label="æ ‡ç­¾" name="tags">
      <a-select
        v-model:value="searchParams.tags"
        style="min-width: 180px"
        :options="tagOptions"
        mode="tags"
        placeholder="è¯·è¾“å…¥æ ‡ç­¾"
        allowClear
      />
    </a-form-item>
    <a-form-item label="æ—¥æœŸ" name="">
      <a-range-picker
        style="width: 400px"
        show-time
        v-model:value="dateRange"
        :placeholder="['ç¼–è¾‘å¼€å§‹æ—¥æœŸ', 'ç¼–è¾‘ç»“æŸæ—¶é—´']"
        format="YYYY/MM/DD HH:mm:ss"
        :presets="rangePresets"
        @change="onRangeChange"
      />
    </a-form-item>
    <a-form-item label="åç§°" name="name">
      <a-input v-model:value="searchParams.name" placeholder="è¯·è¾“å…¥åç§°" allow-clear />
    </a-form-item>
    <a-form-item label="ç®€ä»‹" name="introduction">
      <a-input v-model:value="searchParams.introduction" placeholder="è¯·è¾“å…¥ç®€ä»‹" allow-clear />
    </a-form-item>
    <a-form-item label="å®½åº¦" name="picWidth">
      <a-input-number v-model:value="searchParams.picWidth" />
    </a-form-item>
    <a-form-item label="é«˜åº¦" name="picHeight">
      <a-input-number v-model:value="searchParams.picHeight" />
    </a-form-item>
    <a-form-item label="æ ¼å¼" name="picFormat">
      <a-input v-model:value="searchParams.picFormat" placeholder="è¯·è¾“å…¥æ ¼å¼" allow-clear />
    </a-form-item>
    <a-form-item>
      <a-button type="primary" html-type="submit" style="width: 96px">æœç´¢</a-button>
    </a-form-item>
  </a-form>
</div>
```

æ—¥æœŸè¡¨å•é¡¹æ‰€éœ€çš„å˜é‡ï¼š


```TypeScript
const dateRange = ref<[]>([])

/**
 * æ—¥æœŸèŒƒå›´æ›´æ”¹æ—¶è§¦å‘
 * @param dates
 * @param dateStrings
 */const onRangeChange = (dates: any[], dateStrings: string[]) => {
  if (dates.length < 2) {
    searchParams.startEditTime = undefined
    searchParams.endEditTime = undefined
  } else {
    searchParams.startEditTime = dates[0].toDate()
    searchParams.endEditTime = dates[1].toDate()
  }
}

const rangePresets = ref([
  { label: 'è¿‡å» 7 å¤©', value: [dayjs().add(-7, 'd'), dayjs()] },
  { label: 'è¿‡å» 14 å¤©', value: [dayjs().add(-14, 'd'), dayjs()] },
  { label: 'è¿‡å» 30 å¤©', value: [dayjs().add(-30, 'd'), dayjs()] },
  { label: 'è¿‡å» 90 å¤©', value: [dayjs().add(-90, 'd'), dayjs()] },
])
```

4ï¼‰è·å–åˆ†Øœç±»å’Œæ ‡ç­¾è¡¨å•é¡¹çš„é»˜è®¤é€‰é¡¹åˆ—è¡¨ï¼Œè¿™æ®µä»£ç å¯ä»¥ç›´æ¥å¤ç”¨åˆ›å»ºå›¾ç‰‡é¡µé¢çš„ï¼š


```TypeScript
const categoryOptions = ref<string[]>([])
const tagOptions = ref<string[]>([])

// è·å–æ ‡ç­¾å’Œåˆ†ç±»é€‰é¡¹const getTagCategoryOptions = async () => {
  const res = await listPictureTagCategoryUsingGet()
  if (res.data.code === 0 && res.data.data) {
    // è½¬æ¢æˆä¸‹æ‹‰é€‰é¡¹ç»„ä»¶æ¥å—çš„æ ¼å¼
    tagOptions.value = (res.data.data.tagList ?? []).map((data: string) => {
      return {
        value: data,
        label: data,
      }
    })
    categoryOptions.value = (res.data.data.categoryList ?? []).map((data: string) => {
      return {
        value: data,
        label: data,
      }
    })
  } else {
    message.error('åŠ è½½é€‰é¡¹å¤±è´¥ï¼Œ' + res.data.message)
  }
}

onMounted(() => {
  getTagCategoryOptions()
})
```

5ï¼‰ç©ºé—´è¯¦æƒ…é¡µä½¿ç”¨ç»„ä»¶ï¼š


```PlainText
<!-- æœç´¢è¡¨å• -->
<PictureSearchForm />
```

æµè§ˆæ•ˆæœï¼Œç›®å‰è¡¨å•é¡¹éƒ½æŒ¤åœ¨ä¸€èµ·ï¼Œä¸å¤ªå¥½çœ‹

å¯ä»¥æ·»åŠ  CSS æ ·å¼ï¼Œå¢åŠ ä¸Šè¾¹è·ï¼š


```CSS
.picture-search-form .ant-form-item {
  margin-top: 16px;
}
```

6ï¼‰ç”±äºæ•°Øœå­—è¾“å…¥æ¡†çš„å€¼æ— æ³•ç›´æ¥é€šè¿‡ allow-clear æ¸…ç†ï¼Œæ‰€ä»¥ç»™è¡¨å•å¢åŠ ä¸€ä¸ªé‡ç½®æŒ‰é’®ã€‚

é¡µé¢ä»£ç ï¼š


```PlainText
<a-form-item>
  <a-space>
    <a-button type="primary" html-type="submit" style="width: 96px">æœç´¢</a-button>
    <a-button html-type="reset" @click="doClear">é‡ç½®</a-button>
  </a-space>
</a-form-item>
```

éœ€è¦ç¼–å†™ä¸€ä¸ªé‡ç½®å‡½æ•°ï¼Œå°†æ‰€æœ‰æœç´¢æ¡ä»¶çš„å€¼æ¸…ç©ºã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨äº† `reactive` å“åº”å¼å˜é‡ï¼Œæ— æ³•ç›´æ¥æ•´ä½“èµ‹å€¼ä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œè€Œæ˜¯éœ€è¦å°†å…¶ä¸­çš„å­—æ®µå…¨éƒ¨è®¾ç½®ä¸ºç©ºã€‚æ­¤å¤–ï¼Œä¸è¦å¿˜äº†æ—¥æœŸç»„ä»¶çš„å€¼ä¹Ÿéœ€è¦é‡ç½®ä¸ºç©ºæ•°ç»„ã€‚


```TypeScript
// æ¸…ç†const doClear = () => {
  // å–æ¶ˆæ‰€æœ‰å¯¹è±¡çš„å€¼Object.keys(searchParams).forEach((key) => {
    searchParams[key] = undefined
  })
  dateRange.value = []
  props.onSearch?.(searchParams)
}
```

æ•ˆæœå¦‚å›¾ï¼š

![](assets/XVpGbmpQroIS4RxwhXMcAnU3nlc.png)

### 2ã€æ‰§è¡Œæœç´¢

1ï¼‰ç»™ç»„ä»¶ä¼ é€’ onSearch æœç´¢å‡½æ•°ï¼š


```PlainText
<!-- æœç´¢è¡¨å• -->
<PictureSearchForm :onSearch="onSearch" />
```

2ï¼‰ç¼–å†™æœç´¢å‡½æ•°

ç”±äºæœç´¢å‚æ•°å¯èƒ½Øœè¢«é‡ç½®ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œå°† searchParams ä» reactive å˜é‡æ”¹ä¸º ref å˜é‡ï¼Œè¿™æ ·å¯ä»¥æ•´ä½“ç»™ searchParams èµ‹å€¼ä¸ºç©ºçš„å¯¹è±¡ã€‚

è¦ä¿®æ”¹çš„ä»£ç å¦‚ä¸‹ï¼š


```TypeScript
// æœç´¢æ¡ä»¶const searchParams = ref<API.PictureQueryRequest>({
  current: 1,
  pageSize: 12,
  sortField: 'createTime',
  sortOrder: 'descend',
})

// åˆ†é¡µå‚æ•°const onPageChange = (page, pageSize) => {
  searchParams.value.current = page
  searchParams.value.pageSize = pageSize
  fetchData()
}

// æœç´¢const onSearch = (newSearchParams: API.PictureQueryRequest) => {
  searchParams.value = {
    ...searchParams.value,
    ...newSearchParams,
    current: 1,
  }
  fetchData()
}

// è·å–æ•°æ®const fetchData = async () => {
  loading.value = true// è½¬æ¢æœç´¢å‚æ•°const params = {
    spaceId: props.id,
    ...searchParams.value,
  }
  const res = await listPictureVoByPageUsingPost(params)
  if (res.data.data) {
    dataList.value = res.data.data.records ?? []
    total.value = res.data.data.total ?? 0
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}
```

---

# å›¾ç‰‡æœç´¢â€”â€”ä»¥å›¾æœå›¾

## éœ€æ±‚åˆ†æ

ç”¨æˆ·å¯ä»¥ä½¿Øœç”¨ä¸€å¼ å›¾ç‰‡æ¥æœç´¢ç›¸ä¼¼çš„å›¾ç‰‡ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„å…³é”®è¯æœç´¢ï¼Œèƒ½å¤Ÿæ›´ç²¾ç¡®åœ°æ‰¾åˆ°ä¸ä¸Šä¼ å›¾ç‰‡å†…å®¹ç›¸ä¼¼çš„å›¾ç‰‡ã€‚

ä¸ºäº†è·å¾—æ›´å¤šçš„æœç´¢ç»“æœï¼Œæˆ‘ä»¬çš„éœ€æ±‚æ˜¯ä» å…¨ç½‘æœç´¢å›¾ç‰‡ï¼Œè€Œä¸æ˜¯åªåœ¨è‡ªå·±çš„å›¾åº“ä¸­æœç´¢ã€‚

æ³¨æ„ï¼Œè¯¥åŠŸèƒ½ä¸ç”¨å±€é™äºç§æœ‰ç©ºé—´ï¼Œå…¬å…±å›¾åº“ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚

## æ–¹æ¡ˆè®¾è®¡

ä¸»è¦æœ‰ 2 ç§æ–¹æ¡ˆï¼šç¬¬ä¸‰æ–¹ API ä»¥åŠæ•°æ®æŠ“å–ï¼ˆçˆ¬è™«ï¼‰

### 1ã€ç¬¬ä¸‰æ–¹ API

å¦‚æœæƒ³ä»è‡ªå»ºçš„å›¾åº“ä¸­æœç´¢ï¼šå¯ä»¥ä½¿ç”¨ç™¾åº¦ AI æä¾›çš„å›¾ç‰‡æœç´¢ APIï¼Œ<span style="color: #C7D5F6">[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://ai.baidu.com/tech/imagesearch/)</span>

Bing ä»¥å›¾æœå›¾ APIï¼š åˆ©ç”¨å¿…åº”çš„å›¾åº“ï¼Œå¯ä»¥ä»å…¨ç½‘è¿›è¡Œæœç´¢ï¼Œè€Œä¸”å¯ä»¥å…è´¹ä½¿ç”¨ï¼Œ<span style="color: #C7D5F6">[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://learn.microsoft.com/en-us/bing/search-apis/bing-image-search/quickstarts/rest/java)</span>

### 2ã€æ•°æ®æŠ“å–

åˆ©ç”¨å·²æœ‰çš„Øœä»¥å›¾æœå›¾ç½‘ç«™ï¼Œé€šè¿‡æ•°æ®æŠ“å–çš„æ–¹å¼å®æ—¶æŸ¥è¯¢æœå›¾ç½‘ç«™çš„è¿”å›ç»“æœã€‚

ä¸ºäº†è®©å¤§å®¶å­¦ä¹ åˆ°æ›´å¤šçŸ¥è¯†ï¼Œæ­¤å¤„æˆ‘ä»¬é€‰æ‹©è¿™ç§æ–¹æ¡ˆã€‚

ä»¥ç™¾åº¦æœå›¾Øœç½‘ç«™ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä½“éªŒä¸€éæµç¨‹ï¼Œå¹¶ä¸”å¯¹æ¥å£è¿›è¡Œåˆ†æï¼š

1ï¼‰è¿›åˆ°ç™¾åº¦å›¾ç‰‡æœç´¢ï¼Œé€šè¿‡ url ä¸Šä¼ å›¾ç‰‡ï¼Œå‘ç°æ¥å£ï¼š<span style="color: #C7D5F6">[https://graph.baidu.com/upload?uptime=](https://graph.baidu.com/upload?uptime=)</span> ï¼Œè¯¥æ¥å£çš„è¿”å›å€¼ä¸º â€œä»¥å›¾æœå›¾çš„é¡µé¢åœ°å€â€

2ï¼‰è®¿é—®ä¸Šä¸€æ­¥å¾—åˆ°çš„ <span style="color: #C7D5F6">[é¡µé¢åœ°å€](https://graph.baidu.com/s?card_key=&entrance=GENERAL&extUiData%5BisLogoShow%5D=1&f=all&isLogoShow=1&session_id=16250747570487381669&sign=1265ce97cd54acd88139901733452612&tpl_from=pc)</span>ï¼Œå¯ä»¥åœ¨è¿”å›å€¼ä¸­æ‰¾åˆ° firstUrlï¼š

![](assets/QydmbLwDzoFN9JxLU52cSpT4n5f.png)

3ï¼‰è®¿é—® <span style="color: #C7D5F6">[firstUrl](https://graph.baidu.com/ajax/pcsimi?carousel=503&entrance=GENERAL&extUiData%5BisLogoShow%5D=1&inspire=general_pc&limit=30&next=2&render_type=card&session_id=16250747570487381669&sign=1265ce97cd54acd88139901733452612&tk=4caaa&tpl_from=pc)</span>ï¼Œå°±èƒ½å¾—åˆ° JSON æ ¼å¼çš„ç›¸ä¼¼å›¾ç‰‡åˆ—è¡¨ï¼Œé‡Œé¢åŒ…å«äº†å›¾ç‰‡çš„ç¼©ç•¥å›¾å’ŒåŸå›¾åœ°å€ï¼š

![](assets/FqvLboqonotpFAxdSpEc3TNPn7f.png)

## åç«¯å¼€å‘

æ–°å»º `api` åŒ…ï¼Œç”±äºé¡¹ç›®å¯èƒ½ä¼šç”¨åˆ°å¤šä¸ª apiï¼Œå¯ä»¥å°†æ¯ä¸ª api éƒ½æ”¾åœ¨ api ç›®å½•ä¸‹çš„ä¸€ä¸ªåŒ…ä¸­ã€‚æ¯”å¦‚å›¾ç‰‡æœç´¢ api çš„ç›¸å…³ä»£ç ï¼Œå…¨éƒ¨æ”¾åœ¨ `api.imagesearch` åŒ…ä¸‹ã€‚

### 1ã€æ•°æ®æ¨¡å‹å¼€å‘

åœ¨ `imagesearch.model` åŒ…ä¸­ï¼Œæ–°å»ºä¸€ä¸ªå›¾ç‰‡æœç´¢ç»“æœç±»ï¼Œç”¨äºæ¥å— API çš„è¿”å›å€¼ï¼š


```Java
@Datapublic class ImageSearchResult {

    /**
     * ç¼©ç•¥å›¾åœ°å€
     */private String thumbUrl;

    /**
     * æ¥æºåœ°å€
     */private String fromUrl;
}
```

### 2ã€API å¼€å‘

æ ¹æ®æ–¹æ¡ˆï¼Œæˆ‘ä»¬è¦è°ƒç”¨å¤šä¸ª APIï¼Œæ¯ä¸ªå­ API å¯ä»¥ä½œä¸ºä¸€ä¸ªé™æ€ç±»æ¥å®ç°ï¼Œç»Ÿä¸€æ”¾åœ¨ `imagesearch.sub` åŒ…ä¸­ï¼Œå¹¶ä¸”æ¯ä¸ªç±»éƒ½åŒ…å«ä¸€ä¸ª `main` æ–¹æ³•ï¼Œç”¨äºè¿›è¡Œæœ¬åœ°æµ‹è¯•ã€‚

1ï¼‰è·å–ä»¥å›¾æœå›¾çš„é¡µé¢åœ°å€

é€šè¿‡å‘ç™¾åº¦Øœå‘é€ POST è¯·æ±‚ï¼Œè·å–ç»™å®šå›¾ç‰‡ URL çš„ç›¸ä¼¼å›¾ç‰‡é¡µé¢åœ°å€ã€‚


```Java
@Slf4jpublic class GetImagePageUrlApi {

    /**
     * è·å–å›¾ç‰‡é¡µé¢åœ°å€
     *
     * @param imageUrl
     * @return
     */public static String getImagePageUrl(String imageUrl) {
        // 1. å‡†å¤‡è¯·æ±‚å‚æ•°
        Map<String, Object> formData = new HashMap<>();
        formData.put("image", imageUrl);
        formData.put("tn", "pc");
        formData.put("from", "pc");
        formData.put("image_source", "PC_UPLOAD_URL");
        // è·å–å½“å‰æ—¶é—´æˆ³long uptime = System.currentTimeMillis();
        // è¯·æ±‚åœ°å€String url = "https://graph.baidu.com/upload?uptime=" + uptime;

        try {
            // 2. å‘é€ POST è¯·æ±‚åˆ°ç™¾åº¦æ¥å£HttpResponse response = HttpRequest.post(url)
                    .form(formData)
                    .timeout(5000)
                    .execute();
            // åˆ¤æ–­å“åº”çŠ¶æ€if (HttpStatus.HTTP_OK != response.getStatus()) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ¥å£è°ƒç”¨å¤±è´¥");
            }
            // è§£æå“åº”String responseBody = response.body();
            Map<String, Object> result = JSONUtil.toBean(responseBody, Map.class);

            // 3. å¤„ç†å“åº”ç»“æœif (result == null || !Integer.valueOf(0).equals(result.get("status"))) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ¥å£è°ƒç”¨å¤±è´¥");
            }
            Map<String, Object> data = (Map<String, Object>) result.get("data");
            String rawUrl = (String) data.get("url");
            // å¯¹ URL è¿›è¡Œè§£ç String searchResultUrl = URLUtil.decode(rawUrl, StandardCharsets.UTF_8);
            // å¦‚æœ URL ä¸ºç©ºif (searchResultUrl == null) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªè¿”å›æœ‰æ•ˆç»“æœ");
            }
            return searchResultUrl;
        } catch (Exception e) {
            log.error("æœç´¢å¤±è´¥", e);
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœç´¢å¤±è´¥");
        }
    }

    public static void main(String[] args) {
        // æµ‹è¯•ä»¥å›¾æœå›¾åŠŸèƒ½String imageUrl = "https://www.codefather.cn/logo.png";
        String result = getImagePageUrl(imageUrl);
        System.out.println("æœç´¢æˆåŠŸï¼Œç»“æœ URLï¼š" + result);
    }
}
```

2ï¼‰è·å–å›¾ç‰‡åˆ—è¡¨é¡µé¢åœ°å€

é€šè¿‡ jsoup çˆ¬å– HTML é¡µé¢ï¼Œæå–å…¶ä¸­åŒ…å« `firstUrl` çš„ JavaScript è„šæœ¬ï¼Œå¹¶è¿”å›å›¾ç‰‡åˆ—è¡¨çš„é¡µé¢åœ°å€ã€‚


```Java
@Slf4jpublic class GetImageFirstUrlApi {

    /**
     * è·å–å›¾ç‰‡åˆ—è¡¨é¡µé¢åœ°å€
     *
     * @param url
     * @return
     */public static String getImageFirstUrl(String url) {
        try {
            // ä½¿ç”¨ Jsoup è·å– HTML å†…å®¹Document document = Jsoup.connect(url)
                    .timeout(5000)
                    .get();

            // è·å–æ‰€æœ‰ <script> æ ‡ç­¾Elements scriptElements = document.getElementsByTag("script");

            // éå†æ‰¾åˆ°åŒ…å« `firstUrl` çš„è„šæœ¬å†…å®¹for (Element script : scriptElements) {
                String scriptContent = script.html();
                if (scriptContent.contains("\"firstUrl\"")) {
                    // æ­£åˆ™è¡¨è¾¾å¼æå– firstUrl çš„å€¼Pattern pattern = Pattern.compile("\"firstUrl\"\\s*:\\s*\"(.*?)\"");
                    Matcher matcher = pattern.matcher(scriptContent);
                    if (matcher.find()) {
                        String firstUrl = matcher.group(1);
                        // å¤„ç†è½¬ä¹‰å­—ç¬¦
                        firstUrl = firstUrl.replace("\\/", "/");
                        return firstUrl;
                    }
                }
            }

            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªæ‰¾åˆ° url");
        } catch (Exception e) {
            log.error("æœç´¢å¤±è´¥", e);
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœç´¢å¤±è´¥");
        }
    }

    public static void main(String[] args) {
        // è¯·æ±‚ç›®æ ‡ URLString url = "https://graph.baidu.com/s?card_key=&entrance=GENERAL&extUiData[isLogoShow]=1&f=all&isLogoShow=1&session_id=16250747570487381669&sign=1265ce97cd54acd88139901733452612&tpl_from=pc";
        String imageFirstUrl = getImageFirstUrl(url);
        System.out.println("æœç´¢æˆåŠŸï¼Œç»“æœ URLï¼š" + imageFirstUrl);
    }
}
```

3ï¼‰è·å–å›¾ç‰‡åˆ—è¡¨

é€šè¿‡è°ƒç”¨ç™¾Øœåº¦æ¥å£è¿”å›çš„ JSON æ•°æ®ï¼Œæå–å‡ºå…¶ä¸­çš„å›¾ç‰‡åˆ—è¡¨å¹¶è¿”å›ã€‚


```Java
@Slf4jpublic class GetImageListApi {

    /**
     * è·å–å›¾ç‰‡åˆ—è¡¨
     *
     * @param url
     * @return
     */public static List<ImageSearchResult> getImageList(String url) {
        try {
            // å‘èµ·GETè¯·æ±‚HttpResponse response = HttpUtil.createGet(url).execute();

            // è·å–å“åº”å†…å®¹int statusCode = response.getStatus();
            String body = response.body();

            // å¤„ç†å“åº”if (statusCode == 200) {
                // è§£æ JSON æ•°æ®å¹¶å¤„ç†return processResponse(body);
            } else {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ¥å£è°ƒç”¨å¤±è´¥");
            }
        } catch (Exception e) {
            log.error("è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥", e);
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥");
        }
    }

    /**
     * å¤„ç†æ¥å£å“åº”å†…å®¹
     *
     * @param responseBody æ¥å£è¿”å›çš„JSONå­—ç¬¦ä¸²
     */private static List<ImageSearchResult> processResponse(String responseBody) {
        // è§£æå“åº”å¯¹è±¡JSONObject jsonObject = new JSONObject(responseBody);
        if (!jsonObject.containsKey("data")) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªè·å–åˆ°å›¾ç‰‡åˆ—è¡¨");
        }
        JSONObject data = jsonObject.getJSONObject("data");
        if (!data.containsKey("list")) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªè·å–åˆ°å›¾ç‰‡åˆ—è¡¨");
        }
        JSONArray list = data.getJSONArray("list");
        return JSONUtil.toList(list, ImageSearchResult.class);
    }

    public static void main(String[] args) {
        String url = "https://graph.baidu.com/ajax/pcsimi?carousel=503&entrance=GENERAL&extUiData%5BisLogoShow%5D=1&inspire=general_pc&limit=30&next=2&render_type=card&session_id=16250747570487381669&sign=1265ce97cd54acd88139901733452612&tk=4caaa&tpl_from=pc";
        List<ImageSearchResult> imageList = getImageList(url);
        System.out.println("æœç´¢æˆåŠŸ" + imageList);
    }
}
```

### 3ã€å›¾ç‰‡æœç´¢æœåŠ¡ï¼ˆé—¨é¢æ¨¡å¼ï¼‰

è¿™é‡Œæˆ‘ä»¬è¿ç”¨Øœä¸€ç§è®¾è®¡æ¨¡å¼æ¥æä¾›å›¾ç‰‡æœç´¢æœåŠ¡ã€‚é—¨é¢æ¨¡å¼é€šè¿‡æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£æ¥ç®€åŒ–å¤šä¸ªæ¥å£çš„è°ƒç”¨ï¼Œä½¿å¾—å®¢æˆ·ç«¯ä¸éœ€è¦å…³æ³¨å†…éƒ¨çš„å…·ä½“å®ç°ã€‚

æˆ‘ä»¬å¯ä»¥å°†å¤šä¸ª API æ•´åˆåˆ°ä¸€ä¸ªé—¨é¢ç±»ä¸­ï¼Œç®€åŒ–è°ƒç”¨è¿‡ç¨‹ã€‚åœ¨ `imagesearch` åŒ…ä¸‹æ–°å»ºé—¨é¢ç±»ï¼Œæ•´åˆå‡ ä¸ªæ¥å£çš„è°ƒç”¨ï¼š


```Java
@Slf4jpublic class ImageSearchApiFacade {

    /**
     * æœç´¢å›¾ç‰‡
     *
     * @param imageUrl
     * @return
     */public static List<ImageSearchResult> searchImage(String imageUrl) {
        String imagePageUrl = GetImagePageUrlApi.getImagePageUrl(imageUrl);
        String imageFirstUrl = GetImageFirstUrlApi.getImageFirstUrl(imagePageUrl);
        List<ImageSearchResult> imageList = GetImageListApi.getImageList(imageFirstUrl);
        return imageList;
    }

    public static void main(String[] args) {
        // æµ‹è¯•ä»¥å›¾æœå›¾åŠŸèƒ½String imageUrl = "https://www.codefather.cn/logo.png";
        List<ImageSearchResult> resultList = searchImage(imageUrl);
        System.out.println("ç»“æœåˆ—è¡¨" + resultList);
    }
}
```

### 4ã€æ¥å£å¼€å‘

å¼€å‘è¯·æ±‚ç±»ï¼š


```Java
@Datapublic class SearchPictureByPictureRequest implements Serializable {

    /**
     * å›¾ç‰‡ id
     */private Long pictureId;

    private static final long serialVersionUID = 1L;
}
```

å¼€å‘æ¥å£ï¼š


```Java
/**
 * ä»¥å›¾æœå›¾
 */@PostMapping("/search/picture")public BaseResponse<List<ImageSearchResult>> searchPictureByPicture(@RequestBody SearchPictureByPictureRequest searchPictureByPictureRequest) {
    ThrowUtils.throwIf(searchPictureByPictureRequest == null, ErrorCode.PARAMS_ERROR);
    Long pictureId = searchPictureByPictureRequest.getPictureId();
    ThrowUtils.throwIf(pictureId == null || pictureId <= 0, ErrorCode.PARAMS_ERROR);
    Picture oldPicture = pictureService.getById(pictureId);
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);
    List<ImageSearchResult> resultList = ImageSearchApiFacade.searchImage(oldPicture.getUrl());
    return ResultUtils.success(resultList);
}
```

## å‰ç«¯å¼€å‘

### 1ã€æœç´¢å…¥å£

1ï¼‰ä¿®æ”¹å›¾ç‰‡åˆ—è¡¨é¡µé¢çš„ä»£ç ï¼Œç»™å›¾ç‰‡æ“ä½œæ å¢åŠ ä¸€ä¸ªæœç´¢æŒ‰é’®ï¼š


```PlainText
<template v-if="showOp" #actions>
  <a-space @click="(e) => doSearch(picture, e)">
    <search-outlined />
    æœç´¢
  </a-space>
  <a-space @click="(e) => doEdit(picture, e)">
    <edit-outlined />
    ç¼–è¾‘
  </a-space>
  <a-space @click="(e) => doDelete(picture, e)">
    <delete-outlined />
    åˆ é™¤
  </a-space>
</template>
```

2ï¼‰ç‚¹å‡»æœç´¢åæ‰“å¼€æ–°é¡µé¢ï¼Œè¿›å…¥åˆ°ä»¥å›¾æœå›¾ç»“æœé¡µï¼š


```TypeScript
// æœç´¢const doSearch = (picture, e) => {
  e.stopPropagation()
  window.open(`/search_picture?pictureId=${picture.id}`)
}
```

### 2ã€ä»¥å›¾æœå›¾ç»“æœé¡µé¢

1ï¼‰æ–°å»ºå›¾ç‰‡æœç´¢é¡µé¢æ–‡ä»¶ `SearchPicturePage.vue`ã€‚å¯ä»¥å¤åˆ¶åˆ›å»ºå›¾ç‰‡é¡µé¢ï¼Œè¿™æ ·å¯ä»¥å¤ç”¨è·å– url æŸ¥è¯¢å‚æ•°å¹¶æŸ¥è¯¢è€æ•°æ®çš„é€»è¾‘ã€‚

æ·»åŠ è·¯ç”±ï¼š


```TypeScript
{
  path: '/search_picture',
  name: 'å›¾ç‰‡æœç´¢',
  component: SearchPicturePage,
}
```

2ï¼‰å¼€å‘é¡µØœé¢ï¼Œä¸Šæ–¹å±•ç¤ºé¡µé¢æ ‡é¢˜å’ŒåŸå§‹å›¾ç‰‡ï¼Œä¸‹æ–¹å±•ç¤ºæœç´¢ç»“æœå›¾ç‰‡åˆ—è¡¨ã€‚å¯ä»¥å‚è€ƒå›¾ç‰‡åˆ—è¡¨ç»„ä»¶æ¥å±•ç¤ºå›¾ç‰‡åˆ—è¡¨ï¼š


```PlainText
<template>
  <div id="searchPicturePage">
    <h2 style="margin-bottom: 16px">ä»¥å›¾æœå›¾</h2>
    <h3 style="margin: 16px 0">åŸå›¾</h3>
    <a-card style="width: 240px">
      <template #cover>
        <img
          style="height: 180px; object-fit: cover"
          :alt="picture.name"
          :src="picture.thumbnailUrl ?? picture.url"
        />
      </template>
    </a-card>
    <h3 style="margin: 16px 0">è¯†å›¾ç»“æœ</h3>
    <!-- å›¾ç‰‡åˆ—è¡¨ -->
    <a-list
      :grid="{ gutter: 16, xs: 1, sm: 2, md: 3, lg: 4, xl: 5, xxl: 6 }"
      :data-source="dataList"
    >
      <template #renderItem="{ item }">
        <a-list-item style="padding: 0">
          <a :href="item.fromUrl" target="_blank">
            <a-card>
              <template #cover>
                <img style="height: 180px; object-fit: cover" :src="item.thumbUrl" />
              </template>
            </a-card>
          </a>
        </a-list-item>
      </template>
    </a-list>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { useRoute } from 'vue-router'
import { getPictureVoByIdUsingGet, searchPictureByPictureUsingPost } from '@/api/pictureController'
import { message } from 'ant-design-vue'

const route = useRoute()

// å›¾ç‰‡ id
const pictureId = computed(() => {
  return route.query?.pictureId
})

const picture = ref<API.PictureVO>({})

// è·å–è€æ•°æ®
const getOldPicture = async () => {
  // è·å–æ•°æ®
  const id = route.query?.pictureId
  if (id) {
    const res = await getPictureVoByIdUsingGet({
      id: id,
    })
    if (res.data.code === 0 && res.data.data) {
      const data = res.data.data
      picture.value = data
    }
  }
}

onMounted(() => {
  getOldPicture()
})
</script>
```

3ï¼‰è·å–å›¾ç‰‡æœç´¢ç»“æœï¼š


```TypeScript
const dataList = ref<API.ImageSearchResult[]>([])
// è·å–æœå›¾ç»“æœconst fetchData = async () => {
  const res = await searchPictureByPictureUsingPost({
    pictureId: pictureId.value,
  })
  if (res.data.code === 0 && res.data.data) {
    dataList.value = res.data.data ?? []
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
}

// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡onMounted(() => {
  fetchData()
})
```

## æµ‹è¯•

ç»è¿‡æµ‹è¯•å‘Øœç°ï¼Œç™¾åº¦æœç´¢å¯¹äº webp æ ¼å¼å›¾ç‰‡çš„æ”¯æŒåº¦å¹¶ä¸å¥½ï¼ˆæ”¹æ–‡ä»¶çš„åç¼€ä¹Ÿæ²¡æœ‰ç”¨ï¼‰ï¼Œä¼°è®¡æ˜¯å¹³å°ä¸æ”¯æŒè¯¥æ ¼å¼çš„ç®—æ³•ã€‚

ä½†æ˜¯ä½¿ç”¨ png å›¾ç‰‡å»æµ‹è¯•ï¼Œå°±èƒ½æ­£å¸¸çœ‹åˆ°ç»“æœäº†ï¼š

![](assets/UG1UbDZFloqdPuxjFlyccFT3nbh.png)

---

# å›¾ç‰‡æœç´¢â€”â€”é¢œè‰²æœç´¢

## éœ€æ±‚åˆ†æ

èƒ½å¤ŸæŒ‰ç…§é¢œè‰²æœç´¢ç©ºé—´å†… ä¸»è‰²è°ƒ æœ€ç›¸ä¼¼çš„å›¾ç‰‡ï¼Œåœ¨è®¾è®¡ã€åˆ›æ„å’Œç”µå•†é¢†åŸŸæœ‰å¹¿æ³›åº”ç”¨ã€‚

## æ–¹æ¡ˆè®¾è®¡

éœ€è¦æ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š

1. æ•´ä½“ä¸šåŠ¡æµç¨‹
2. æ€ä¹ˆè·å–å›¾ç‰‡ä¸»è‰²è°ƒï¼Ÿ
3. æ€ä¹ˆè®¾è®¡æœç´¢ç®—æ³•ï¼Ÿ

### 1ã€æ•´ä½“æµç¨‹

ä¸ºäº†æå‡æ€§Øœèƒ½ï¼Œé¿å…æ¯æ¬¡æœç´¢éƒ½å®æ—¶è®¡ç®—å›¾ç‰‡ä¸»è‰²è°ƒï¼Œå»ºè®®åœ¨å›¾ç‰‡ä¸Šä¼ æˆåŠŸåç«‹å³æå–ä¸»è‰²è°ƒå¹¶å­˜å‚¨åˆ°æ•°æ®åº“çš„ç‹¬ç«‹å­—æ®µä¸­ã€‚

å®Œæ•´æµç¨‹å¦‚ä¸‹ï¼š

1. æå–å›¾ç‰‡é¢œè‰²ï¼šé€šè¿‡å›¾åƒå¤„ç†æŠ€æœ¯ï¼ˆäº‘æœåŠ¡ API æˆ–è€… OpenCV å›¾åƒå¤„ç†åº“ï¼‰æå–å›¾ç‰‡çš„é¢œè‰²ç‰¹å¾ï¼Œå¯ä»¥é‡‡ç”¨ä¸»è‰²è°ƒã€é¢œè‰²ç›´æ–¹å›¾ç­‰æ–¹æ³•è¡¨ç¤ºå›¾ç‰‡çš„é¢œè‰²ç‰¹å¾ã€‚æ­¤å¤„æˆ‘ä»¬é‡‡ç”¨ä¸»è‰²è°ƒï¼Œä¾¿äºç†è§£ã€‚
2. å­˜å‚¨é¢œè‰²ç‰¹å¾ï¼šå°†æå–çš„é¢œè‰²æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œä»¥ä¾¿åç»­å¿«é€Ÿæ£€ç´¢ã€‚
3. ç”¨æˆ·æŸ¥è¯¢è¾“å…¥ï¼šç”¨æˆ·é€šè¿‡é¢œè‰²é€‰æ‹©å™¨ã€RGB å€¼è¾“å…¥ã€æˆ–é¢„å®šä¹‰é¢œè‰²åç§°æŒ‡å®šé¢œè‰²æŸ¥è¯¢æ¡ä»¶ã€‚
4. è®¡ç®—ç›¸ä¼¼åº¦ï¼šæ ¹æ®ç”¨æˆ·æŒ‡å®šçš„é¢œè‰²ï¼Œä¸æ•°æ®åº“ä¸­çš„é¢œè‰²ç‰¹å¾è¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—ï¼ˆå¦‚æ¬§æ°è·ç¦»ã€ä½™å¼¦ç›¸ä¼¼åº¦ç­‰æ–¹æ³•ï¼‰ã€‚
5. è¿”å›ç»“æœï¼šç”±äºç©ºé—´å†…çš„å›¾ç‰‡æ•°é‡ç›¸å¯¹è¾ƒå°‘ï¼Œå¯ä»¥æŒ‰ç…§å›¾ç‰‡ä¸ç›®æ ‡é¢œè‰²çš„ç›¸ä¼¼åº¦è¿›è¡Œæ’åºï¼Œä¼˜å…ˆè¿”å›æœ€ç¬¦åˆç”¨æˆ·è¦æ±‚çš„å›¾ç‰‡ï¼Œè€Œä¸æ˜¯ä»…è¿”å›å®Œå…¨ç¬¦åˆæŒ‡å®šè‰²è°ƒçš„å›¾ç‰‡ã€‚

### 2ã€æ€ä¹ˆè·å–å›¾ç‰‡ä¸»è‰²è°ƒï¼Ÿ

æˆ‘ä»¬å­˜å‚¨å›¾ç‰‡ä½¿ç”¨çš„ COS å¯¹è±¡å­˜å‚¨æœåŠ¡å·²ç»å¸®æˆ‘ä»¬æ•´åˆäº†æ•°æ®ä¸‡è±¡ï¼Œè‡ªå¸¦è·å–å›¾ç‰‡ä¸»è‰²è°ƒçš„åŠŸèƒ½ï¼Œ[å‚è€ƒæ–‡æ¡£](https://cloud.tencent.com/document/product/460/6928)ã€‚

ğŸ’¡ åœ¨ä½¿ç”¨äº‘æœåŠ¡åŠŸèƒ½å‰ï¼Œæˆ‘ä»¬å¯ä»¥è¯¦ç»†äº†è§£ä¸‹æœåŠ¡çš„ç›¸å…³é™åˆ¶ï¼Œæ¯”å¦‚ [æ•°æ®ä¸‡è±¡çš„é™åˆ¶](https://cloud.tencent.com/document/product/460/36620)ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¾¾ä¸åˆ°é™åˆ¶ã€‚

é™¤äº†æ–¹ä¾¿ä¹‹Øœå¤–ï¼Œè¿™ä¸ªåŠŸèƒ½å±äºåŸºç¡€å›¾ç‰‡å¤„ç†ï¼Œå®˜æ–¹æä¾›çš„å…è´¹é¢åº¦è¾ƒé«˜ï¼Œé€‚åˆå­¦ä¹ æµ‹è¯•ï¼š

ğŸ’¡ ä¸€èˆ¬æˆ‘ä»¬åšé¡¹ç›®æ—¶ï¼ŒØœå°½å¯èƒ½å‡å°‘æ–°ä¾èµ–æˆ–æœåŠ¡çš„å¼•å…¥ï¼Œä¼šè®©æˆæœ¬æ›´å¯æ§ã€‚æ¯”å¦‚çœ‹åˆ°è…¾è®¯äº‘ COS æœ‰ç°æˆçš„æ”¯æŒå’Œå…è´¹é¢åº¦ï¼Œå°±å·²ç»æ˜¯æˆ‘ä»¬çš„é¦–é€‰è§£å†³æ–¹æ¡ˆï¼Œæ— éœ€è€ƒè™‘ç¬¬ä¸‰æ–¹ APIï¼Œå¯èƒ½ä¼šå¸¦æ¥çš„é¢å¤–é™åˆ¶å’Œå…¼å®¹æ€§é—®é¢˜ï¼ˆæ¯”å¦‚æˆ‘ä»¬çš„å›¾ç‰‡å¼€å¯é˜²ç›—é“¾ï¼Œå¯èƒ½å°±è§£æä¸åˆ°ï¼‰ã€‚

### 3ã€å¦‚ä½•è®¡ç®—é¢œè‰²ç›¸ä¼¼åº¦ï¼Ÿ

æ•°æ®åº“ä¸æ”¯ØœæŒç›´æ¥æŒ‰ç…§é¢œè‰²æ£€ç´¢ï¼Œç”¨ like æ£€ç´¢åˆä¸ç¬¦åˆé¢œè‰²çš„ç‰¹æ€§ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨ä¸€äº›ç®—æ³•æ¥è§£å†³ã€‚

æ­¤å¤„ä½¿ç”¨ æ¬§å‡ é‡Œå¾—è·ç¦» ç®—æ³•ï¼šé¢œè‰²å¯ä»¥ç”¨ RGB å€¼è¡¨ç¤ºï¼Œå¯ä»¥é€šè¿‡è®¡ç®—ä¸¤ç§é¢œè‰² RGB å€¼ä¹‹é—´çš„æ¬§å‡ é‡Œå¾—è·ç¦»æ¥åˆ¤æ–­å®ƒä»¬çš„ç›¸ä¼¼åº¦ã€‚

è·ç¦»è¶Šå°ï¼Œè¡¨ç¤ºé¢œè‰²è¶Šç›¸ä¼¼ï¼›è·ç¦»è¶Šå¤§ï¼Œè¡¨ç¤ºé¢œè‰²è¶Šä¸åŒã€‚

## åç«¯å¼€å‘

### 1ã€è¡¥å……é¢œè‰²å­—æ®µ

1ï¼‰å›¾ç‰‡è¡¨æ–°å¢å­—æ®µï¼Œæ‰§è¡Œ SQLï¼š


```SQL
ALTER TABLE picture
    ADD COLUMN picColor varchar(16) null comment 'å›¾ç‰‡ä¸»è‰²è°ƒ';
```

2ï¼‰æ¯æ¬¡æ–°å¢å­—æ®µæ—¶ï¼Œéƒ½è¦ä¿®æ”¹ PictureMapper.xml ä»¥æ”¯æŒæ–°å­—æ®µçš„æŸ¥è¯¢ã€‚

PicturØœe å®ä½“ç±»ã€PictureVO åŒ…è£…ç±»ã€UploadPictureResult ä¸Šä¼ å›¾ç‰‡ç»“æœç±»ä¹Ÿéœ€è¦è¡¥å……æ–°å­—æ®µï¼š


```Java
/**
 * å›¾ç‰‡ä¸»è‰²è°ƒ
 */private String picColor;
```

### 2ã€å­˜å‚¨é¢œè‰²

1ï¼‰ä¿®æ”¹ PØœictureUploadTemplate çš„ buildResult æ–¹æ³•ï¼Œç›´æ¥ä» ImageInfo å¯¹è±¡ä¸­å°±èƒ½è·å¾—ä¸»è‰²è°ƒï¼š


```Java
uploadPictureResult.setPicColor(imageInfo.getAve());
```

æ³¨æ„ä¸¤ä¸ª bØœuildResult æ–¹æ³•éƒ½è¦ä¿®æ”¹ï¼Œå…¶ä¸­ä¸€ä¸ª buildResult æ–¹æ³•è¦è¡¥å…… imageInfo å‚æ•°ï¼Œä¿®æ”¹çš„ä»£ç å¦‚ä¸‹ï¼š


```Java
private UploadPictureResult buildResult(String originFilename, CIObject compressedCiObject, CIObject thumbnailCiObject, ImageInfo imageInfo) {
    UploadPictureResult uploadPictureResult = new UploadPictureResult();
    int picWidth = compressedCiObject.getWidth();
    int picHeight = compressedCiObject.getHeight();
    double picScale = NumberUtil.round(picWidth * 1.0 / picHeight, 2).doubleValue();
    uploadPictureResult.setPicName(FileUtil.mainName(originFilename));
    uploadPictureResult.setPicWidth(picWidth);
    uploadPictureResult.setPicHeight(picHeight);
    uploadPictureResult.setPicScale(picScale);
    uploadPictureResult.setPicFormat(compressedCiObject.getFormat());
    uploadPictureResult.setPicColor(imageInfo.getAve());
    uploadPictureResult.setPicSize(compressedCiObject.getSize().longValue());
    // è®¾ç½®å›¾ç‰‡ä¸ºå‹ç¼©åçš„åœ°å€
    uploadPictureResult.setUrl(cosClientConfig.getHost() + "/" + compressedCiObject.getKey());
    // è®¾ç½®ç¼©ç•¥å›¾
    uploadPictureResult.setThumbnailUrl(cosClientConfig.getHost() + "/" + thumbnailCiObject.getKey());
    return uploadPictureResult;
}
```

2ï¼‰å›¾ç‰‡æœØœåŠ¡çš„ uploadPicture ä¸­è¡¥å……è®¾ç½® picColorï¼Œä»è€Œå°†è¯¥å­—æ®µä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼š


```Java
picture.setPicColor(uploadPictureResult.getPicColor());
```

### 3ã€é¢œè‰²ç›¸ä¼¼åº¦è®¡ç®—

æ–°å»º `utils` åŒ…ï¼Œç›´æ¥åˆ©ç”¨ AI æ¥ç¼–å†™å·¥å…·ç±»ï¼š


```Java
/**
 * å·¥å…·ç±»ï¼šè®¡ç®—é¢œè‰²ç›¸ä¼¼åº¦
 */public class ColorSimilarUtils {

    private ColorSimilarUtils() {
        // å·¥å…·ç±»ä¸éœ€è¦å®ä¾‹åŒ–
    }

    /**
     * è®¡ç®—ä¸¤ä¸ªé¢œè‰²çš„ç›¸ä¼¼åº¦
     *
     * @param color1 ç¬¬ä¸€ä¸ªé¢œè‰²
     * @param color2 ç¬¬äºŒä¸ªé¢œè‰²
     * @return ç›¸ä¼¼åº¦ï¼ˆ0åˆ°1ä¹‹é—´ï¼Œ1ä¸ºå®Œå…¨ç›¸åŒï¼‰
     */public static double calculateSimilarity(Color color1, Color color2) {
        int r1 = color1.getRed();
        int g1 = color1.getGreen();
        int b1 = color1.getBlue();

        int r2 = color2.getRed();
        int g2 = color2.getGreen();
        int b2 = color2.getBlue();

        // è®¡ç®—æ¬§æ°è·ç¦»double distance = Math.sqrt(Math.pow(r1 - r2, 2) + Math.pow(g1 - g2, 2) + Math.pow(b1 - b2, 2));

        // è®¡ç®—ç›¸ä¼¼åº¦return 1 - distance / Math.sqrt(3 * Math.pow(255, 2));
    }

    /**
     * æ ¹æ®åå…­è¿›åˆ¶é¢œè‰²ä»£ç è®¡ç®—ç›¸ä¼¼åº¦
     *
     * @param hexColor1 ç¬¬ä¸€ä¸ªé¢œè‰²çš„åå…­è¿›åˆ¶ä»£ç ï¼ˆå¦‚ 0xFF0000ï¼‰
     * @param hexColor2 ç¬¬äºŒä¸ªé¢œè‰²çš„åå…­è¿›åˆ¶ä»£ç ï¼ˆå¦‚ 0xFE0101ï¼‰
     * @return ç›¸ä¼¼åº¦ï¼ˆ0åˆ°1ä¹‹é—´ï¼Œ1ä¸ºå®Œå…¨ç›¸åŒï¼‰
     */public static double calculateSimilarity(String hexColor1, String hexColor2) {
        Color color1 = Color.decode(hexColor1);
        Color color2 = Color.decode(hexColor2);
        return calculateSimilarity(color1, color2);
    }

    // ç¤ºä¾‹ä»£ç public static void main(String[] args) {
        // æµ‹è¯•é¢œè‰²Color color1 = Color.decode("0xFF0000");
        Color color2 = Color.decode("0xFE0101");
        double similarity = calculateSimilarity(color1, color2);

        System.out.println("é¢œè‰²ç›¸ä¼¼åº¦ä¸ºï¼š" + similarity);

        // æµ‹è¯•åå…­è¿›åˆ¶æ–¹æ³•double hexSimilarity = calculateSimilarity("0xFF0000", "0xFE0101");
        System.out.println("åå…­è¿›åˆ¶é¢œè‰²ç›¸ä¼¼åº¦ä¸ºï¼š" + hexSimilarity);
    }
}
```

### 4ã€é¢œè‰²æŸ¥è¯¢æœåŠ¡

ä¸ºäº†è®©å¤§å®¶å­¦Øœä¹ æ›´æ¸…æ™°ï¼Œåœ¨å›¾ç‰‡æœåŠ¡ä¸­æ–°ç¼–å†™æŒ‰é¢œè‰²æŸ¥è¯¢å›¾ç‰‡çš„æ–¹æ³• searchPictureByColorï¼Œä¸å’Œå…¶ä»–çš„æœç´¢æ¡ä»¶æ”¾åœ¨ä¸€èµ·ã€‚

æŒ‰ç…§æ–¹æ¡ˆè®¾è®¡ä¸­çš„æµç¨‹å¼€å‘ï¼Œä»£ç å¦‚ä¸‹ï¼š


```Java
@Overridepublic List<PictureVO> searchPictureByColor(Long spaceId, String picColor, User loginUser) {
    // 1. æ ¡éªŒå‚æ•°
    ThrowUtils.throwIf(spaceId == null || StrUtil.isBlank(picColor), ErrorCode.PARAMS_ERROR);
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NO_AUTH_ERROR);
    // 2. æ ¡éªŒç©ºé—´æƒé™Space space = spaceService.getById(spaceId);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    if (!loginUser.getId().equals(space.getUserId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´è®¿é—®æƒé™");
    }
    // 3. æŸ¥è¯¢è¯¥ç©ºé—´ä¸‹æ‰€æœ‰å›¾ç‰‡ï¼ˆå¿…é¡»æœ‰ä¸»è‰²è°ƒï¼‰
    List<Picture> pictureList = this.lambdaQuery()
            .eq(Picture::getSpaceId, spaceId)
            .isNotNull(Picture::getPicColor)
            .list();
    // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç›´æ¥è¿”å›ç©ºåˆ—è¡¨if (CollUtil.isEmpty(pictureList)) {
        return Collections.emptyList();
    }
    // å°†ç›®æ ‡é¢œè‰²è½¬ä¸º Color å¯¹è±¡Color targetColor = Color.decode(picColor);
    // 4. è®¡ç®—ç›¸ä¼¼åº¦å¹¶æ’åº
    List<Picture> sortedPictures = pictureList.stream()
            .sorted(Comparator.comparingDouble(picture -> {
                // æå–å›¾ç‰‡ä¸»è‰²è°ƒString hexColor = picture.getPicColor();
                // æ²¡æœ‰ä¸»è‰²è°ƒçš„å›¾ç‰‡æ”¾åˆ°æœ€åif (StrUtil.isBlank(hexColor)) {
                    return Double.MAX_VALUE;
                }
                Color pictureColor = Color.decode(hexColor);
                // è¶Šå¤§è¶Šç›¸ä¼¼return -ColorSimilarUtils.calculateSimilarity(targetColor, pictureColor);
            }))
            // å–å‰ 12 ä¸ª
            .limit(12)
            .collect(Collectors.toList());

    // è½¬æ¢ä¸º PictureVOreturn sortedPictures.stream()
            .map(PictureVO::objToVo)
            .collect(Collectors.toList());
}
```

ä¸Šè¿°ä»£ç æœ‰ 2 ä¸ªå°ç»†èŠ‚ï¼š

1. æˆ‘ä»¬æå‰æŠŠç›®æ ‡é¢œè‰²ä»å­—ç¬¦ä¸²è½¬ä¸º color å¯¹è±¡ï¼Œè€Œä¸æ˜¯æ¯è®¡ç®—ä¸€å¼ å›¾éƒ½é‡æ–°è½¬æ¢ä¸€æ¬¡å¯¹è±¡ã€‚
2. æœ€åå°† Picture è½¬ä¸º PictureVO æ—¶ï¼Œä¸è¦è°ƒç”¨ service ä¸­çš„è½¬æ¢æ–¹æ³•ï¼Œä¼šé¢å¤–æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™æ˜¯æ²¡å¿…è¦çš„ã€‚

### 5ã€æ¥å£å¼€å‘

1ï¼‰è¯·æ±‚å°è£…ç±» ØœSearchPictureByColorRequestï¼Œéœ€è¦ä¼ å…¥ç©ºé—´ id å’Œä¸»è‰²è°ƒï¼šâ€‚â€‚ï»¿â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‚â€â€‚â€‚â€‰â€‚â€‰â€‚â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‚â€‚


```Java
@Datapublic class SearchPictureByColorRequest implements Serializable {

    /**
     * å›¾ç‰‡ä¸»è‰²è°ƒ
     */private String picColor;

    /**
     * ç©ºé—´ id
     */private Long spaceId;

    private static final long serialVersionUID = 1L;
}
```

2ï¼‰å¼€å‘æ¥å£ï¼š


```Java
@PostMapping("/search/color")public BaseResponse<List<PictureVO>> searchPictureByColor(@RequestBody SearchPictureByColorRequest searchPictureByColorRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(searchPictureByColorRequest == null, ErrorCode.PARAMS_ERROR);
    String picColor = searchPictureByColorRequest.getPicColor();
    Long spaceId = searchPictureByColorRequest.getSpaceId();
    User loginUser = userService.getLoginUser(request);
    List<PictureVO> result = pictureService.searchPictureByColor(spaceId, picColor, loginUser);
    return ResultUtils.success(result);
}
```

## å‰ç«¯å¼€å‘

### 1ã€é¢œè‰²æœç´¢

1ï¼‰é€‰æ‹©é¢œè‰²é€‰æ‹©å™¨ç»„ä»¶ [vue3-colorpicker](https://github.com/aesoper101/vue3-colorpicker?tab=readme-ov-file)ï¼Œ[å‚è€ƒæ–‡æ¡£](https://aesoper101.github.io/vue3-colorpicker/?path=/docs/example-colorpicker--docs) æ¥äº†è§£ä½¿ç”¨æ–¹æ³•å’Œå‚æ•°ã€‚

å®‰è£…ç»„ä»¶ï¼š


```Shell
npm install vue3-colorpicker
```

2ï¼‰åœ¨ç©ºé—´Øœè¯¦æƒ…é¡µæ–°å¢é¢œè‰²æœç´¢ã€‚å› ä¸ºè·Ÿå…¶ä»–æœç´¢ä¸æ˜¯è”åŠ¨çš„ï¼Œæ‰€ä»¥ç‹¬ç«‹å‡ºæ¥ï¼Œæ”¾åˆ°æœç´¢æ¡†ä¸‹é¢ã€‚


```PlainText
<!-- æŒ‰é¢œè‰²æœç´¢ -->
<a-form-item label="æŒ‰é¢œè‰²æœç´¢" style="margin-top: 16px">
  <color-picker format="hex" @pureColorChange="onColorChange" />
</a-form-item>
```

æ³¨æ„ï¼ŒfoØœrmat è¦è®¾ç½®ä¸º hexï¼Œå¾—åˆ°åå…­è¿›åˆ¶çš„é¢œè‰²å€¼ã€‚

3ï¼‰ç¼–å†™åˆ‡æ¢é¢œè‰²äº‹ä»¶å‡½æ•°ï¼Œåˆ‡æ¢é¢œè‰²æ—¶ä¼šè§¦å‘æœç´¢ï¼š


```TypeScript
const onColorChange = async (color: string) => {
  const res = await searchPictureByColorUsingPost({
    picColor: color,
    spaceId: props.id,
  })
  if (res.data.code === 0 && res.data.data) {
    const data = res.data.data ?? [];
    dataList.value = data;
    total.value = data.length;
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

æ•ˆæœå¦‚å›¾ï¼š

![](assets/O19YbR957oLSeRxV3WJcV1Rsnbh.png)

### 2ã€å±•ç¤ºå›¾ç‰‡ä¸»è‰²è°ƒ

å›¾ç‰‡è¯¦æƒ…é¡µØœè¡¥å……é¢œè‰²ä¸»è‰²è°ƒçš„å±•ç¤ºï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå°è‰²å—è®©é¢œè‰²å±•ç¤ºæ•ˆæœæ›´æ˜æ˜¾ï¼š


```PlainText
<a-descriptions-item label="ä¸»è‰²è°ƒ">
  <a-space>
    {{ picture.picColor ?? '-' }}
    <div
      v-if="picture.picColor"
      :style="{
        backgroundColor: toHexColor(picture.picColor),
        width: '16px',
        height: '16px',
      }"
    />
  </a-space>
</a-descriptions-item>
```

ç”±äºåç«¯æ•°æ®ä¸‡è±¡è®¡ç®—å‡ºçš„è‰²å€¼æ ¼å¼ä¸æ˜¯æ ‡å‡†çš„ï¼Œå­˜åœ¨ç±»ä¼¼ `0x080e0` çš„è‰²å€¼ï¼Œéœ€è¦è½¬æ¢ä¸ºæ ‡å‡† 16 è¿›åˆ¶è‰²å€¼ï¼š


```TypeScript
export function toHexColor(input) {
  // å»æ‰ 0x å‰ç¼€const colorValue = input.startsWith('0x') ? input.slice(2) : input

  // å°†å‰©ä½™éƒ¨åˆ†è§£æä¸ºåå…­è¿›åˆ¶æ•°ï¼Œå†è½¬æˆ 6 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²const hexColor = parseInt(colorValue, 16).toString(16).padStart(6, '0')

  // è¿”å›æ ‡å‡† #RRGGBB æ ¼å¼return `#${hexColor}`
}
```

æ•ˆæœå¦‚å›¾ï¼š

![](assets/XzErbXY2uojBWpxADBLcAfK5n6g.png)

---

# å›¾ç‰‡åˆ†äº«

## éœ€æ±‚åˆ†æ

ä¸ºäº†æå‡ç½‘ç«™Øœçš„ç”¨æˆ·æ•°é‡ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ å¤šä¸ªå¼•å¯¼ç”¨æˆ·åˆ†äº«ç½‘ç«™çš„æŒ‰é’®ï¼Œå¹¶ä¸”ç¡®ä¿ä¸ªäººç”¨æˆ·èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°é€šè¿‡æ‰‹æœºè®¿é—®å’Œåˆ†äº«ç½‘ç«™å†…å®¹ã€‚

æ”¯æŒä¸¤ç§åˆ†Øœäº«å½¢å¼ï¼šç§»åŠ¨ç«¯æ‰«ç åˆ†äº«å’Œå¤åˆ¶é“¾æ¥åˆ†äº«ï¼ŒåŒæ—¶å…¼å®¹ç§»åŠ¨ç«¯å’Œ PC ç«¯ã€‚

## æ–¹æ¡ˆè®¾è®¡

è¯¥åŠŸèƒ½çš„å®ç°ä»¥å‰ç«¯ä¸ºä¸»ï¼Œä¸æ¶‰åŠåç«¯å¼€å‘ã€‚

### 1ã€é€šç”¨åˆ†äº«ç»„ä»¶

ç”±äºç½‘ç«™å¤šØœä¸ªä½ç½®éƒ½å¯ä»¥è§¦å‘åˆ†äº«ã€‚å¯ä»¥å¼€å‘ä¸€ä¸ªé€šç”¨çš„å¼¹çª—åˆ†äº«ç»„ä»¶ï¼Œå¹¶åœ¨ç½‘ç«™çš„å„ä¸ªé¡µé¢ï¼ˆæˆ–ç»„ä»¶ï¼‰ä¸­å¼•å…¥ã€‚

ç”¨æˆ·ç‚¹å‡»åˆ†Øœäº«æŒ‰é’®æ—¶ï¼Œåˆ†äº«å¼¹çª—ä¼šå¼¹å‡ºï¼Œå¹¶å±•ç¤ºå¤šç§ä¸åŒçš„åˆ†äº«æ–¹å¼ï¼Œå¼•å¯¼ç”¨æˆ·é¡ºåˆ©å®Œæˆåˆ†äº«ã€‚

### 2ã€åˆ†äº«å…¥å£

å¯ä»¥åœ¨å›¾ç‰‡Øœè¯¦æƒ…é¡µã€ä¸ªäººç©ºé—´çš„å›¾ç‰‡å¡ç‰‡æ“ä½œæ ä¸­å¢åŠ åˆ†äº«å…¥å£ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åœ¨ä¸»é¡µç­‰å…¶ä»–åˆé€‚çš„ä½ç½®åˆ†äº«~

### 3ã€å¤åˆ¶é“¾æ¥åˆ†äº«

æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ Ant Design çš„ [å¯å¤åˆ¶æ–‡æœ¬ç»„ä»¶](https://antdv.com/components/typography-cn#components-typography-demo-interactive)ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ç¬¬ä¸‰æ–¹åº“å¦‚ [copy-text-to-clipboard](https://www.npmjs.com/package/copy-text-to-clipboard) æ¥å®ç°å¤åˆ¶é“¾æ¥åŠŸèƒ½ã€‚

### 4ã€ç§»åŠ¨ç«¯æ‰«ç åˆ†äº«

ç§»åŠ¨ç«¯æ‰«ç åˆ†äº«å¯ä»¥ä½¿ç”¨ [ç»„ä»¶åº“çš„ qrcode ç»„ä»¶](https://antdv.com/components/qrcode-cn)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ [qrcode ç»„ä»¶](https://www.npmjs.com/package/qrcode)ã€‚å…¶åŸç†æ˜¯å°†åˆ†äº«é“¾æ¥è½¬åŒ–ä¸ºäºŒç»´ç å›¾ç‰‡ï¼Œç”¨æˆ·æ‰«æäºŒç»´ç åå³å¯è®¿é—®é“¾æ¥ã€‚

## å‰ç«¯å¼€å‘

### 1ã€é€šç”¨å¼¹çª—åˆ†äº«ç»„ä»¶

1ï¼‰æ–°å¢ ShareModal ç»„ä»¶ï¼Œä½¿ç”¨ [Modal å¼¹çª—ç»„ä»¶](https://antdv.com/components/modal-cn)ï¼Œæ”¯æŒä¼ å…¥ title æ ‡é¢˜å’Œ link åˆ†äº«é“¾æ¥å±æ€§ï¼Œå¯ä»¥ç”±çˆ¶ç»„ä»¶å†³å®šè¦åˆ†äº«çš„ä¿¡æ¯ã€‚


```PlainText
<template>
  <a-modal v-model:visible="visible" title="åˆ†äº«å›¾ç‰‡" :footer="false" @cancel="closeModal">
    <h4>å¤åˆ¶åˆ†äº«é“¾æ¥</h4>
    <a-typography-link copyable>
      {{ link }}
    </a-typography-link>
    <div style="margin-bottom: 16px" />
    <h4>æ‰‹æœºæ‰«ç æŸ¥çœ‹</h4>
    <a-qrcode :value="link" />
  </a-modal>
</template>

<script setup lang="ts">
import { defineProps, ref, withDefaults, defineExpose } from 'vue'

/**
 * å®šä¹‰ç»„ä»¶å±æ€§ç±»å‹
 */
interface Props {
  title: string
  link: string
}

/**
 * ç»™ç»„ä»¶æŒ‡å®šåˆå§‹å€¼
 */
const props = withDefaults(defineProps<Props>(), {
  title: () => 'åˆ†äº«',
  link: () => 'https://laoyujianli.com/share/yupi',
})
</script>
```

2ï¼‰å®šä¹‰ Øœvisible å˜é‡å’Œå¼¹çª—æ‰“å¼€å…³é—­çš„å‡½æ•°ï¼Œç”¨äºæ§åˆ¶å¼¹çª—æ˜¯å¦å¯è§ï¼š


```TypeScript
// æ˜¯å¦å¯è§const visible = ref(false)

// æ‰“å¼€å¼¹çª—const openModal = () => {
  visible.value = true
}

// å…³é—­å¼¹çª—const closeModal = () => {
  visible.value = false
}
```

3ï¼‰ä¸ºäº†æ–¹Øœä¾¿å…¶ä»–é¡µé¢ä½¿ç”¨ç»„ä»¶ï¼Œéœ€è¦æš´éœ²å‡º openModal å‡½æ•°ï¼š


```JavaScript
import { defineExpose } from "vue";

// æš´éœ²å‡½æ•°ç»™çˆ¶ç»„ä»¶defineExpose({
  openModal,
});
```

### 2ã€å›¾ç‰‡åˆ—è¡¨ä½¿ç”¨ç»„ä»¶

1ï¼‰å›¾ç‰‡åˆ—Øœè¡¨ç»„ä»¶ä¸­å¼•å…¥å¼¹çª—åˆ†äº«ç»„ä»¶ï¼Œæ³¨æ„è¦åœ¨ for å¾ªç¯å¤–å¼•å…¥ï¼š


```PlainText
<ShareModal ref="shareModalRef" :link="shareLink" />
```

2ï¼‰ç¼–å†™è§¦Øœå‘åˆ†äº«çš„å…¥å£ï¼Œç‚¹å‡»åˆ†äº«å›¾æ ‡åæ‰“å¼€å¼¹çª—ã€‚å¯ä»¥ç§»é™¤æ“ä½œæ çš„æ–‡å­—ï¼Œè®©å›¾ç‰‡å¡ç‰‡çœ‹èµ·æ¥æ›´ç²¾ç®€ï¼š


```PlainText
<template v-if="showOp" #actions>
  <search-outlined @click="(e) => doSearch(picture, e)" />
  <share-alt-outlined @click="(e) => doShare(picture, e)" />
  <edit-outlined @click="(e) => doEdit(picture, e)" />
  <delete-outlined @click="(e) => doDelete(picture, e)" />
</template>
```

3ï¼‰ç¼–å†™åˆ†Øœäº«å‡½æ•°ï¼Œæ‰“å¼€åˆ†äº«å¼¹çª—ã€‚æ³¨æ„ä¸è¦ç¡¬ç¼–ç åˆ†äº«é“¾æ¥çš„è·¯å¾„ï¼Œè€Œæ˜¯å¯ä»¥è·å–å½“å‰çš„ç½‘å€ï¼Œä»£ç å¦‚ä¸‹ï¼š


```JavaScript
// åˆ†äº«å¼¹çª—å¼•ç”¨const shareModalRef = ref()
// åˆ†äº«é“¾æ¥const shareLink = ref<string>()

// åˆ†äº«const doShare = (picture: API.PictureVO, e: Event) => {
  e.stopPropagation()
  shareLink.value = `${window.location.protocol}//${window.location.host}/picture/${picture.id}`if (shareModalRef.value) {
    shareModalRef.value.openModal()
  }
}
```

æ•ˆæœå¦‚å›¾ï¼š

![](assets/R4obbAVutooKXbxSoeGcrdginUc.png)

#### 3ã€å›¾ç‰‡è¯¦æƒ…é¡µä½¿ç”¨ç»„ä»¶

1ï¼‰åœ¨å…è´¹ä¸‹è½½æŒ‰é’®çš„å³è¾¹å¢åŠ åˆ†äº«æŒ‰é’®ï¼š


```PlainText
<a-button type="primary" ghost @click="doShare">
  åˆ†äº«
  <template #icon>
    <share-alt-outlined />
  </template>
</a-button>
```

2ï¼‰åˆ†äº«å‡½Øœæ•°å°±å¾ˆç®€å•äº†ï¼Œå¤åˆ¶å›¾ç‰‡åˆ—è¡¨ç»„ä»¶çš„åˆ†äº«å‡½æ•°ä»£ç åï¼Œç•¥ä½œä¿®æ”¹å³å¯ã€‚

æ•ˆæœå¦‚å›¾ï¼š

![](assets/WCCrbuGqqorIdExcK8WczwXmnre.png)

---

# å›¾ç‰‡æ‰¹é‡ç®¡ç†

## éœ€æ±‚åˆ†æ

ç”¨æˆ·å¯ä»¥å¯¹ç§æœ‰ç©ºé—´å†…çš„å›¾ç‰‡è¿›è¡Œæ‰¹é‡ä¿®æ”¹ï¼ŒåŒ…æ‹¬ï¼š

* æ‰¹é‡ä¿®æ”¹ä¿¡æ¯ï¼šä¿®æ”¹å›¾ç‰‡çš„æ ‡ç­¾å’Œåˆ†ç±»
* æ‰¹é‡é‡å‘½åï¼šæ‰¹é‡ä¿®æ”¹å›¾ç‰‡åç§°

## æ–¹æ¡ˆè®¾è®¡

### 1ã€æ‰¹å¤„ç†æ“ä½œä¼˜åŒ–

æ‰¹é‡æ“ä½œçš„Øœå®ç°å¹¶ä¸éš¾ï¼Œé¦–å…ˆæŸ¥è¯¢å‡ºç©ºé—´å†…æ‰€æœ‰çš„å›¾ç‰‡ï¼Œç„¶åæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ for å¾ªç¯éå†ä¸€ä¸‹å˜›ï¼

ä½†å¦‚æœæƒ³è®©æ‰¹é‡æ“ä½œæ›´å¿«ã€æ›´ç¨³å®šåœ°å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„å‡ ç‚¹ï¼š

1. æ•°æ®æ ¡éªŒï¼šæ ¡éªŒå‚æ•°çš„åˆæ³•æ€§ï¼Œå¹¶ä¸”æ ¡éªŒç”¨æˆ·æ˜¯å¦å…·æœ‰ç©ºé—´çš„è®¿é—®æƒé™ï¼Œç¡®ä¿æ“ä½œå®‰å…¨ã€‚
2. æŸ¥è¯¢ä¼˜åŒ–ï¼šæŸ¥è¯¢å›¾ç‰‡æ—¶ï¼Œä»…é€‰æ‹©æ‰€éœ€çš„å­—æ®µï¼ˆå¦‚ id å’Œ spaceIdï¼‰ï¼Œå‡å°‘æ•°æ®åº“å¼€é”€ã€‚
3. äº‹åŠ¡ï¼šç¡®ä¿æ‰¹é‡æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œå¦‚æœæœ‰ä¸€æ¡æ›´æ–°å¤±è´¥ï¼Œé‚£ä¹ˆéœ€è¦å¯¹è¿™ä¸€æ‰¹æ“ä½œè¿›è¡Œå›æ»šï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
4. æ‰¹é‡æ›´æ–°ï¼šåˆ©ç”¨ MyBatis-Plus æä¾›çš„ `updateBatchById` æ–¹æ³•è¿›è¡Œæ‰¹é‡æ›´æ–°ï¼Œè€Œä¸æ˜¯ for å¾ªç¯å¤šæ¬¡æ“ä½œæ•°æ®åº“ï¼Œä»è€Œæé«˜æ€§èƒ½å¹¶é™ä½æ“ä½œæ—¶é—´ã€‚

æ­¤å¤–ï¼Œå¦‚æœè¦å¤„ç†çš„Øœæ•°æ®é‡éå¸¸å¤§ï¼ˆä¸Šåƒæ¡ï¼‰ï¼Œä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼Œè¿˜å¯ä»¥ç»“åˆä½¿ç”¨çº¿ç¨‹æ± ã€åˆ†æ‰¹å¤„ç†å’Œå¹¶å‘ç¼–ç¨‹ï¼Œæå‡å¤§è§„æ¨¡æ“ä½œçš„æ•ˆç‡ã€‚è¿˜å¯ä»¥é€šè¿‡æ·»åŠ æ—¥å¿—æ¥è®°å½•æ‰¹å¤„ç†æ“ä½œçš„æ‰§è¡Œæƒ…å†µï¼Œæé«˜å¯è§‚æµ‹æ€§ã€‚

### 2ã€æ‰¹é‡é‡å‘½å

æœ€ç®€å•çš„å®ç°æ˜¯å°†æ‰€æœ‰å›¾ç‰‡éƒ½ä¿®æ”¹ä¸ºåŒä¸€ä¸ªåç§°ï¼Œä½†è¿™æ ·ä¸å¤Ÿæœ‰åŒºåˆ†åº¦ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªåŠ¨æ€ç”Ÿæˆè§„åˆ™ï¼Œå…è®¸ç”¨æˆ·åœ¨é‡å‘½åæ—¶å¡«å†™åŠ¨æ€å˜é‡ï¼ˆå ä½ç¬¦ï¼‰ã€‚æ¯”å¦‚ç”¨æˆ·è¾“å…¥`å›¾ç‰‡_{åºå·}`ï¼Œå…¶ä¸­`{åºå·}`å°±æ˜¯åŠ¨æ€å˜é‡ï¼Œæ¯ä¸ªå›¾ç‰‡çš„åºå·éƒ½ä¸åŒï¼Œä¼šä» 1 å¼€å§‹æŒç»­é€’å¢ã€‚

åç«¯å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æ›¿æ¢æ–¹æ³•æ¥å¤„ç† `{åºå·}` å ä½ç¬¦ï¼Œé€‚ç”¨äºæ¯”è¾ƒç®€å•çš„åœºæ™¯ï¼Œå¦‚æœåŠ¨æ€ç”Ÿæˆè§„åˆ™å¾ˆå¤æ‚ï¼Œå¯ä»¥ä½¿ç”¨æ¨¡æ¿å¼•æ“æŠ€æœ¯ã€‚

### æ‰©å±•çŸ¥è¯† - Spring è¡¨è¾¾å¼

æåˆ°åŠ¨æ€æ›¿Øœæ¢å†…å®¹ï¼Œè¿™é‡Œé¡ºä¾¿åˆ†äº«ä¸€ä¸‹ Spring è¡¨è¾¾å¼æŠ€æœ¯ã€‚

Spring è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpØœring Expression Languageï¼Œç®€ç§° SpELï¼‰ç”¨äºåœ¨ Spring é…ç½®æ–‡ä»¶æˆ– Java ä»£ç ä¸­åŠ¨æ€åœ°æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡ã€‚SpEL å¯ä»¥åœ¨è¿è¡Œæ—¶è§£æè¡¨è¾¾å¼ï¼Œå¹¶æ‰§è¡Œå¯¹ Java å¯¹è±¡çš„è®¿é—®ã€æ“ä½œå’Œè®¡ç®—ï¼Œæ”¯æŒä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¦‚æ¡ä»¶åˆ¤æ–­ã€æ–¹æ³•è°ƒç”¨ã€å±æ€§è®¿é—®ã€é›†åˆå¤„ç†ã€æ­£åˆ™è¡¨è¾¾å¼ç­‰ã€‚

ä¸¾ä¸€äº›è¯­æ³•ç¤ºä¾‹ï¼š


```Java
#{user.name}   // è®¿é—® user å¯¹è±¡çš„ name å±æ€§
#{person.address.city}  // è®¿é—®åµŒå¥—å¯¹è±¡åœ°å€ä¸­çš„ city å±æ€§
#{user.getFullName()}   // è°ƒç”¨ user å¯¹è±¡çš„ getFullName() æ–¹æ³•
#{user.age > 18 ? 'Adult' : 'Child'}  // æ ¹æ® age åˆ¤æ–­æ˜¯å¦ä¸ºæˆå¹´äºº
```

ä¸¾ä¾‹ä¸€ä¸ªåº”Øœç”¨åœºæ™¯ï¼Œæ¯”å¦‚ç¼“å­˜æ³¨è§£ä¸­ï¼Œä½¿ç”¨è¡¨è¾¾å¼æ ¹æ®æ–¹æ³•å‚æ•°åŠ¨æ€ç”Ÿæˆç¼“å­˜çš„ keyï¼š


```Java
/**
 * æ ¹æ®ç”¨æˆ· ID è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶å°†ç»“æœç¼“å­˜ã€‚
 * ä½¿ç”¨ SpEL åŠ¨æ€ç”Ÿæˆç¼“å­˜çš„ keyï¼ŒåŠ å…¥ç”¨æˆ· ID å’Œè¯·æ±‚çš„è¯­è¨€ï¼ˆlocaleï¼‰ã€‚
 *
 * @param userId ç”¨æˆ· ID
 * @param locale å½“å‰è¯­è¨€ç¯å¢ƒï¼ˆå¦‚ en, zhï¼‰
 * @return ç”¨æˆ·ä¿¡æ¯
 */@Cacheable(value = "users", key = "#userId + ':' + #locale")public String getUserInfo(Long userId, String locale) {
    // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
    System.out.println("Fetching user info from DB...");
    return "User " + userId + " info in " + locale + " language";
}
```

å®ƒçš„å®ç°æ–¹Øœå¼å¯å°±ä¸æ˜¯å­—ç¬¦ä¸²æ›¿æ¢è¿™ä¹ˆç®€å•äº†ï¼Œè€Œæ˜¯ç”¨åˆ°äº† AST æŠ½è±¡è¯­æ³•æ ‘æ¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå¤§å®¶è¦å¯¹è¿™ç§æ€è·¯æœ‰ä¸ªå°è±¡ã€‚

## åç«¯å¼€å‘

### 1ã€æ‰¹é‡ä¿®æ”¹ä¿¡æ¯

1ï¼‰å¼€å‘è¯·æ±‚ç±»ï¼Œæ¥å—å›¾ç‰‡ id åˆ—è¡¨ç­‰å­—æ®µï¼š


```Java
@Datapublic class PictureEditByBatchRequest implements Serializable {

    /**
     * å›¾ç‰‡ id åˆ—è¡¨
     */private List<Long> pictureIdList;

    /**
     * ç©ºé—´ id
     */private Long spaceId;

    /**
     * åˆ†ç±»
     */private String category;

    /**
     * æ ‡ç­¾
     */private List<String> tags;

    private static final long serialVersionUID = 1L;
}
```

2ï¼‰å¼€å‘æ‰¹Øœé‡ä¿®æ”¹å›¾ç‰‡æœåŠ¡ï¼Œä¾æ¬¡å®Œæˆå‚æ•°æ ¡éªŒã€ç©ºé—´æƒé™æ ¡éªŒã€å›¾ç‰‡æŸ¥è¯¢ã€æ‰¹é‡æ›´æ–°æ“ä½œï¼š


```Java
@Override@Transactional(rollbackFor = Exception.class)public void editPictureByBatch(PictureEditByBatchRequest pictureEditByBatchRequest, User loginUser) {
    List<Long> pictureIdList = pictureEditByBatchRequest.getPictureIdList();
    Long spaceId = pictureEditByBatchRequest.getSpaceId();
    String category = pictureEditByBatchRequest.getCategory();
    List<String> tags = pictureEditByBatchRequest.getTags();

    // 1. æ ¡éªŒå‚æ•°
    ThrowUtils.throwIf(spaceId == null || CollUtil.isEmpty(pictureIdList), ErrorCode.PARAMS_ERROR);
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NO_AUTH_ERROR);
    // 2. æ ¡éªŒç©ºé—´æƒé™Space space = spaceService.getById(spaceId);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    if (!loginUser.getId().equals(space.getUserId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´è®¿é—®æƒé™");
    }

    // 3. æŸ¥è¯¢æŒ‡å®šå›¾ç‰‡ï¼Œä»…é€‰æ‹©éœ€è¦çš„å­—æ®µ
    List<Picture> pictureList = this.lambdaQuery()
            .select(Picture::getId, Picture::getSpaceId)
            .eq(Picture::getSpaceId, spaceId)
            .in(Picture::getId, pictureIdList)
            .list();

    if (pictureList.isEmpty()) {
        return;
    }
    // 4. æ›´æ–°åˆ†ç±»å’Œæ ‡ç­¾
    pictureList.forEach(picture -> {
        if (StrUtil.isNotBlank(category)) {
            picture.setCategory(category);
        }
        if (CollUtil.isNotEmpty(tags)) {
            picture.setTags(JSONUtil.toJsonStr(tags));
        }
    });

    // 5. æ‰¹é‡æ›´æ–°boolean result = this.updateBatchById(pictureList);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
}
```

ğŸ’¡ å¯¹äºæˆ‘ä»¬çš„Øœé¡¹ç›®æ¥è¯´ï¼Œç”±äºç”¨æˆ·è¦å¤„ç†çš„æ•°æ®é‡ä¸å¤§ï¼Œä¸Šè¿°ä»£ç å·²ç»èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ã€‚ä½†å¦‚æœè¦å¤„ç†å¤§é‡æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨çº¿ç¨‹æ±  + åˆ†æ‰¹ + å¹¶å‘è¿›è¡Œä¼˜åŒ–ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š


```Java
@Resourceprivate ThreadPoolExecutor customExecutor;

/**
 * æ‰¹é‡ç¼–è¾‘å›¾ç‰‡åˆ†ç±»å’Œæ ‡ç­¾
 */@Override@Transactional(rollbackFor = Exception.class)public void batchEditPictureMetadata(PictureBatchEditRequest request, Long spaceId, Long loginUserId) {
    // å‚æ•°æ ¡éªŒ
    validateBatchEditRequest(request, spaceId, loginUserId);

    // æŸ¥è¯¢ç©ºé—´ä¸‹çš„å›¾ç‰‡
    List<Picture> pictureList = this.lambdaQuery()
            .eq(Picture::getSpaceId, spaceId)
            .in(Picture::getId, request.getPictureIds())
            .list();

    if (pictureList.isEmpty()) {
        throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "æŒ‡å®šçš„å›¾ç‰‡ä¸å­˜åœ¨æˆ–ä¸å±äºè¯¥ç©ºé—´");
    }

    // åˆ†æ‰¹å¤„ç†é¿å…é•¿äº‹åŠ¡int batchSize = 100;
    List<CompletableFuture<Void>> futures = new ArrayList<>();
    for (int i = 0; i < pictureList.size(); i += batchSize) {
        List<Picture> batch = pictureList.subList(i, Math.min(i + batchSize, pictureList.size()));

        // å¼‚æ­¥å¤„ç†æ¯æ‰¹æ•°æ®
        CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
            batch.forEach(picture -> {
                // ç¼–è¾‘åˆ†ç±»å’Œæ ‡ç­¾if (request.getCategory() != null) {
                    picture.setCategory(request.getCategory());
                }
                if (request.getTags() != null) {
                    picture.setTags(String.join(",", request.getTags()));
                }
            });
            boolean result = this.updateBatchById(batch);
            if (!result) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ‰¹é‡æ›´æ–°å›¾ç‰‡å¤±è´¥");
            }
        }, customExecutor);

        futures.add(future);
    }

    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
}
```

æ­¤å¤–ï¼Œè¿˜å¯Øœä»¥å¤šè®°å½•æ—¥å¿—ï¼Œæˆ–è€…è®©è¿”å›ç»“æœæ›´åŠ è¯¦ç»†ï¼Œæ¯”å¦‚æ›´æ–°æˆåŠŸäº†å¤šå°‘æ¡æ•°æ®ä¹‹ç±»çš„ã€‚

3ï¼‰å¼€å‘æ¥å£


```Java
@PostMapping("/edit/batch")public BaseResponse<Boolean> editPictureByBatch(@RequestBody PictureEditByBatchRequest pictureEditByBatchRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(pictureEditByBatchRequest == null, ErrorCode.PARAMS_ERROR);
    User loginUser = userService.getLoginUser(request);
    pictureService.editPictureByBatch(pictureEditByBatchRequest, loginUser);
    return ResultUtils.success(true);
}
```

### 2ã€æ‰¹é‡é‡å‘½å

ç›´æ¥å¤ç”¨æ‰¹Øœé‡ä¿®æ”¹ä¿¡æ¯çš„æ–¹æ³•ï¼Œåœ¨è¿™åŸºç¡€ä¸Šåšå¢å¼ºï¼Œè¡¥å……å¯¹å›¾ç‰‡åç§°çš„ä¿®æ”¹ã€‚

1ï¼‰æ‰¹é‡ç¼–Øœè¾‘è¯·æ±‚ç±» PictureEditByBatchRequest è¡¥å……å­—æ®µï¼š


```Java
/**
 * å‘½åè§„åˆ™
 */private String nameRule;
```

2ï¼‰æ‰¹é‡ä¿®æ”¹æ–¹æ³•è¡¥å……å›¾ç‰‡åç§°ï¼š


```Java
// æ‰¹é‡é‡å‘½åString nameRule = pictureEditByBatchRequest.getNameRule();
fillPictureWithNameRule(pictureList, nameRule);
```

ç¼–å†™å¡«å……å›¾ç‰‡åç§°çš„æ–¹æ³•ï¼Œä½¿ç”¨å­—ç¬¦ä¸²çš„ `replaceAll` æ–¹æ³•æ›¿æ¢åŠ¨æ€å˜é‡ï¼š


```Java
/**
 * nameRule æ ¼å¼ï¼šå›¾ç‰‡{åºå·}
 *
 * @param pictureList
 * @param nameRule
 */private void fillPictureWithNameRule(List<Picture> pictureList, String nameRule) {
    if (CollUtil.isEmpty(pictureList) || StrUtil.isBlank(nameRule)) {
        return;
    }
    long count = 1;
    try {
        for (Picture picture : pictureList) {
            String pictureName = nameRule.replaceAll("\\{åºå·}", String.valueOf(count++));
            picture.setName(pictureName);
        }
    } catch (Exception e) {
        log.error("åç§°è§£æé”™è¯¯", e);
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "åç§°è§£æé”™è¯¯");
    }
}
```

## å‰ç«¯å¼€å‘

ä¸ºäº†å®ç°æ–¹Øœä¾¿ï¼Œä»…å¯¹ç©ºé—´è¯¦æƒ…é¡µå½“å‰é¡µå·æŸ¥è¯¢å‡ºçš„å›¾ç‰‡è¿›è¡Œæ‰¹é‡ç®¡ç†ã€‚

### 1ã€æ‰¹é‡ç¼–è¾‘å¼¹çª—è¡¨å•

1ï¼‰ç›´æ¥å¤Øœç”¨ä¹‹å‰çš„å¼¹çª—åˆ†äº«ç»„ä»¶ + æœç´¢å›¾ç‰‡è¡¨å•ç»„ä»¶ï¼Œå°±èƒ½å¿«é€Ÿå®Œæˆå¼€å‘ã€‚

* è¡¨å•é¡¹åŒ…æ‹¬åˆ†ç±»ã€æ ‡ç­¾ã€å‘½åè§„åˆ™ï¼Œè¿˜å¯ä»¥åŠ ä¸€è¡Œæç¤ºè¯­ â€œåªå¯¹å½“å‰é¡µé¢çš„å›¾ç‰‡ç”Ÿæ•ˆâ€ã€‚
* ç»„ä»¶å±æ€§åŒ…æ‹¬ spaceId å’Œ pictureListï¼Œç”±ç©ºé—´è¯¦æƒ…é¡µä¼ å…¥ã€‚

ä»£ç å¦‚ä¸‹ï¼š


```PlainText
<template>
  <a-modal v-model:visible="visible" title="æ‰¹é‡ç¼–è¾‘å›¾ç‰‡" :footer="false" @cancel="closeModal">
    <a-typography-paragraph type="secondary">* åªå¯¹å½“å‰é¡µé¢çš„å›¾ç‰‡ç”Ÿæ•ˆ</a-typography-paragraph>
    <!-- è¡¨å•é¡¹ -->
    <a-form layout="vertical" :model="formData" @finish="handleSubmit">
      <a-form-item label="åˆ†ç±»" name="category">
        <a-auto-complete
          v-model:value="formData.category"
          :options="categoryOptions"
          placeholder="è¯·è¾“å…¥åˆ†ç±»"
          allowClear
        />
      </a-form-item>
      <a-form-item label="æ ‡ç­¾" name="tags">
        <a-select
          v-model:value="formData.tags"
          :options="tagOptions"
          mode="tags"
          placeholder="è¯·è¾“å…¥æ ‡ç­¾"
          allowClear
        />
      </a-form-item>
      <a-form-item label="å‘½åè§„åˆ™" name="nameRule">
        <a-input v-model:value="formData.nameRule" placeholder="è¯·è¾“å…¥å‘½åè§„åˆ™ï¼Œè¾“å…¥ {åºå·} å¯åŠ¨æ€ç”Ÿæˆ" />
      </a-form-item>
      <a-form-item>
        <a-button type="primary" html-type="submit">æäº¤</a-button>
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup lang="ts">
import { defineProps, ref, withDefaults, defineExpose, reactive, onMounted } from 'vue'
import {
  editPictureByBatchUsingPost,
  listPictureTagCategoryUsingGet,
} from '@/api/pictureController'
import { message } from 'ant-design-vue'

// å®šä¹‰ç»„ä»¶å±æ€§ç±»å‹
interface Props {
  pictureList: API.PictureVO[]
  spaceId: number
  onSuccess: () => void
}

// ç»™ç»„ä»¶æŒ‡å®šåˆå§‹å€¼
const props = withDefaults(defineProps<Props>(), {})

// æ§åˆ¶å¼¹çª—å¯è§æ€§
const visible = ref(false)

// æ‰“å¼€å¼¹çª—
const openModal = () => {
  visible.value = true
}

// å…³é—­å¼¹çª—
const closeModal = () => {
  visible.value = false
}

// æš´éœ²å‡½æ•°ç»™çˆ¶ç»„ä»¶
defineExpose({
  openModal,
})

// åˆå§‹åŒ–è¡¨å•æ•°æ®
const formData = reactive({
  category: '', // åˆ†ç±»
  tags: [], // æ ‡ç­¾
  nameRule: '', // å‘½åè§„åˆ™
})

const categoryOptions = ref<string[]>([])
const tagOptions = ref<string[]>([])

// è·å–æ ‡ç­¾å’Œåˆ†ç±»é€‰é¡¹
const getTagCategoryOptions = async () => {
  const res = await listPictureTagCategoryUsingGet()
  if (res.data.code === 0 && res.data.data) {
    // è½¬æ¢æˆä¸‹æ‹‰é€‰é¡¹ç»„ä»¶æ¥å—çš„æ ¼å¼
    tagOptions.value = (res.data.data.tagList ?? []).map((data: string) => {
      return {
        value: data,
        label: data,
      }
    })
    categoryOptions.value = (res.data.data.categoryList ?? []).map((data: string) => {
      return {
        value: data,
        label: data,
      }
    })
  } else {
    message.error('åŠ è½½é€‰é¡¹å¤±è´¥ï¼Œ' + res.data.message)
  }
}

onMounted(() => {
  getTagCategoryOptions()
})
</script>
```

2ï¼‰ç¼–å†™æäº¤è¡¨å•çš„å‡½æ•°ï¼Œè°ƒç”¨åç«¯æ‰¹é‡ç¼–è¾‘æ¥å£ï¼š


```TypeScript
// æäº¤è¡¨å•æ—¶å¤„ç†const handleSubmit = async (values: any) => {
  if (!props.pictureList) {
    return
  }
  const res = await editPictureByBatchUsingPost({
    pictureIdList: props.pictureList.map((picture) => picture.id),
    spaceId: props.spaceId,
    ...values,
  })
  if (res.data.code === 0 && res.data.data) {
    message.success('æ“ä½œæˆåŠŸ')
    closeModal()
    props.onSuccess?.()
  } else {
    message.error('æ“ä½œå¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

### 2ã€ä½¿ç”¨å¼¹çª—ç»„ä»¶

1ï¼‰ç©ºé—´è¯¦æƒ…é¡µå¼•å…¥å¼¹çª—ç»„ä»¶ï¼š


```PlainText
<BatchEditPictureModal
  ref="batchEditPictureModalRef"
  :spaceId="id"
  :pictureList="dataList"
  :onSuccess="onBatchEditPictureSuccess"
/>
```

2ï¼‰é€šè¿‡ Øœref è·å–åˆ°å¼¹çª—çš„å¼•ç”¨ï¼Œåœ¨æ‰¹é‡ç¼–è¾‘æˆåŠŸåè¦åˆ·æ–°å›¾ç‰‡åˆ—è¡¨æ•°æ®ï¼š


```TypeScript
// åˆ†äº«å¼¹çª—å¼•ç”¨const batchEditPictureModalRef = ref()

// æ‰¹é‡ç¼–è¾‘æˆåŠŸåï¼Œåˆ·æ–°æ•°æ®const onBatchEditPictureSuccess = () => {
  fetchData()
}
```

### 3ã€æ‰“å¼€å¼¹çª—ç»„ä»¶

åœ¨åˆ›å»ºå›¾ç‰‡æŒ‰Øœé’®çš„å³ä¾§è¡¥å…… â€œæ‰¹é‡ç¼–è¾‘â€ æŒ‰é’®ï¼Œç‚¹å‡»åæ‰“å¼€å¼¹çª—è¡¨å•ï¼šâ€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚ï»¿â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‚â€‚â€‚â€‰â€‚â€â€‰â€‚â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‚


```PlainText
<a-button :icon="h(EditOutlined)" @click="doBatchEdit"> æ‰¹é‡ç¼–è¾‘</a-button>
```

æŒ‰é’®ç‚¹å‡»å‡½æ•°ï¼š


```TypeScript
// æ‰“å¼€æ‰¹é‡ç¼–è¾‘å¼¹çª—const doBatchEdit = () => {
  if (batchEditPictureModalRef.value) {
    batchEditPictureModalRef.value.openModal()
  }
}
```

æ•ˆæœå¦‚å›¾ï¼š

![](assets/ZVwbbT5Mho8Kt5x8ZLecHufrneS.png)

---



